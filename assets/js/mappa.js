var ls=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);import"./modulepreload-polyfill-B5Qt9EMX.js";import{l as cs,U as us,a as ds}from"./universalFooter-4wcZNTqa.js";import{p as hs}from"./dataParser-By5c4Oll.js";import{i as fs}from"./initMap-B78Q3a7t.js";import"./_commonjsHelpers-BosuxZz1.js";var Pa=ls((fe,pe)=>{var yn=typeof global=="object"&&global&&global.Object===Object&&global,ps=typeof self=="object"&&self&&self.Object===Object&&self,_e=yn||ps||Function("return this")(),me=_e.Symbol,wn=Object.prototype,gs=wn.hasOwnProperty,ms=wn.toString,Xe=me?me.toStringTag:void 0,vs=Object.prototype.toString,bs="[object Null]",ys="[object Undefined]",Cr=me?me.toStringTag:void 0;function Ge(r){return r==null?r===void 0?ys:bs:Cr&&Cr in Object(r)?function(e){var t=gs.call(e,Xe),n=e[Xe];try{e[Xe]=void 0;var s=!0}catch{}var i=ms.call(e);return s&&(t?e[Xe]=n:delete e[Xe]),i}(r):function(e){return vs.call(e)}(r)}function ke(r){return r!=null&&typeof r=="object"}var ws="[object Symbol]";function qe(r){return typeof r=="symbol"||ke(r)&&Ge(r)==ws}function Ve(r,e){for(var t=-1,n=r==null?0:r.length,s=Array(n);++t<n;)s[t]=e(r[t],t,r);return s}var ie=Array.isArray,Er=me?me.prototype:void 0,kr=Er?Er.toString:void 0;function xn(r){if(typeof r=="string")return r;if(ie(r))return Ve(r,xn)+"";if(qe(r))return kr?kr.call(r):"";var e=r+"";return e=="0"&&1/r==-1/0?"-0":e}function Be(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}function St(r){return r}var xs="[object AsyncFunction]",_s="[object Function]",Ss="[object GeneratorFunction]",Cs="[object Proxy]";function _n(r){if(!Be(r))return!1;var e=Ge(r);return e==_s||e==Ss||e==xs||e==Cs}var Mr,Pt=_e["__core-js_shared__"],Ar=(Mr=/[^.]+$/.exec(Pt&&Pt.keys&&Pt.keys.IE_PROTO||""))?"Symbol(src)_1."+Mr:"",Es=Function.prototype.toString;function Re(r){if(r!=null){try{return Es.call(r)}catch{}try{return r+""}catch{}}return""}var ks=/^\[object .+?Constructor\]$/,Ms=RegExp("^"+Function.prototype.toString.call(Object.prototype.hasOwnProperty).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function ze(r,e){var t=function(n,s){return n==null?void 0:n[s]}(r,e);return function(n){return!(!Be(n)||(s=n,Ar&&Ar in s))&&(_n(n)?Ms:ks).test(Re(n));var s}(t)?t:void 0}var Ir,Bt,Rt,Vt=ze(_e,"WeakMap"),Lr=Object.create,As=function(){function r(){}return function(e){if(!Be(e))return{};if(Lr)return Lr(e);r.prototype=e;var t=new r;return r.prototype=void 0,t}}(),Is=Date.now,Ls=function(){try{var r=ze(Object,"defineProperty");return r({},"",{}),r}catch{}}(),yt=Ls,js=yt?function(r,e){return yt(r,"toString",{configurable:!0,enumerable:!1,value:(t=e,function(){return t}),writable:!0});var t}:St,Fs=(Ir=js,Bt=0,Rt=0,function(){var r=Is(),e=16-(r-Rt);if(Rt=r,e>0){if(++Bt>=800)return arguments[0]}else Bt=0;return Ir.apply(void 0,arguments)});function Os(r){return r!=r}function Ns(r,e){return!(r==null||!r.length)&&function(t,n,s){return n==n?function(i,o,a){for(var l=-1,u=i.length;++l<u;)if(i[l]===o)return l;return-1}(t,n):function(i,o,a,l){for(var u=i.length,f=-1;++f<u;)if(o(i[f],f,i))return f;return-1}(t,Os)}(r,e)>-1}var $s=9007199254740991,Ps=/^(?:0|[1-9]\d*)$/;function nr(r,e){var t=typeof r;return!!(e=e??$s)&&(t=="number"||t!="symbol"&&Ps.test(r))&&r>-1&&r%1==0&&r<e}function sr(r,e,t){e=="__proto__"&&yt?yt(r,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):r[e]=t}function Ct(r,e){return r===e||r!=r&&e!=e}var Bs=Object.prototype.hasOwnProperty;function Sn(r,e,t){var n=r[e];Bs.call(r,e)&&Ct(n,t)&&(t!==void 0||e in r)||sr(r,e,t)}function ut(r,e,t,n){var s=!t;t||(t={});for(var i=-1,o=e.length;++i<o;){var a=e[i],l=void 0;l===void 0&&(l=r[a]),s?sr(t,a,l):Sn(t,a,l)}return t}var jr=Math.max;function Cn(r,e){return Fs(function(t,n,s){return n=jr(n===void 0?t.length-1:n,0),function(){for(var i=arguments,o=-1,a=jr(i.length-n,0),l=Array(a);++o<a;)l[o]=i[n+o];o=-1;for(var u=Array(n+1);++o<n;)u[o]=i[o];return u[n]=s(l),function(f,v,m){switch(m.length){case 0:return f.call(v);case 1:return f.call(v,m[0]);case 2:return f.call(v,m[0],m[1]);case 3:return f.call(v,m[0],m[1],m[2])}return f.apply(v,m)}(t,this,u)}}(r,e,St),r+"")}var Rs=9007199254740991;function ir(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=Rs}function Ze(r){return r!=null&&ir(r.length)&&!_n(r)}function Fr(r,e,t){if(!Be(t))return!1;var n=typeof e;return!!(n=="number"?Ze(t)&&nr(e,t.length):n=="string"&&e in t)&&Ct(t[e],r)}var zs=Object.prototype;function or(r){var e=r&&r.constructor;return r===(typeof e=="function"&&e.prototype||zs)}function Or(r){return ke(r)&&Ge(r)=="[object Arguments]"}var En=Object.prototype,Ts=En.hasOwnProperty,Ds=En.propertyIsEnumerable,ar=Or(function(){return arguments}())?Or:function(r){return ke(r)&&Ts.call(r,"callee")&&!Ds.call(r,"callee")},kn=typeof fe=="object"&&fe&&!fe.nodeType&&fe,Nr=kn&&typeof pe=="object"&&pe&&!pe.nodeType&&pe,$r=Nr&&Nr.exports===kn?_e.Buffer:void 0,wt=($r?$r.isBuffer:void 0)||function(){return!1},W={};function Et(r){return function(e){return r(e)}}W["[object Float32Array]"]=W["[object Float64Array]"]=W["[object Int8Array]"]=W["[object Int16Array]"]=W["[object Int32Array]"]=W["[object Uint8Array]"]=W["[object Uint8ClampedArray]"]=W["[object Uint16Array]"]=W["[object Uint32Array]"]=!0,W["[object Arguments]"]=W["[object Array]"]=W["[object ArrayBuffer]"]=W["[object Boolean]"]=W["[object DataView]"]=W["[object Date]"]=W["[object Error]"]=W["[object Function]"]=W["[object Map]"]=W["[object Number]"]=W["[object Object]"]=W["[object RegExp]"]=W["[object Set]"]=W["[object String]"]=W["[object WeakMap]"]=!1;var Mn=typeof fe=="object"&&fe&&!fe.nodeType&&fe,et=Mn&&typeof pe=="object"&&pe&&!pe.nodeType&&pe,zt=et&&et.exports===Mn&&yn.process,We=function(){try{return et&&et.require&&et.require("util").types||zt&&zt.binding&&zt.binding("util")}catch{}}(),Pr=We&&We.isTypedArray,An=Pr?Et(Pr):function(r){return ke(r)&&ir(r.length)&&!!W[Ge(r)]},Hs=Object.prototype.hasOwnProperty;function In(r,e){var t=ie(r),n=!t&&ar(r),s=!t&&!n&&wt(r),i=!t&&!n&&!s&&An(r),o=t||n||s||i,a=o?function(f,v){for(var m=-1,d=Array(f);++m<f;)d[m]=v(m);return d}(r.length,String):[],l=a.length;for(var u in r)!e&&!Hs.call(r,u)||o&&(u=="length"||s&&(u=="offset"||u=="parent")||i&&(u=="buffer"||u=="byteLength"||u=="byteOffset")||nr(u,l))||a.push(u);return a}function Ln(r,e){return function(t){return r(e(t))}}var Us=Ln(Object.keys,Object),Vs=Object.prototype.hasOwnProperty;function it(r){return Ze(r)?In(r):function(e){if(!or(e))return Us(e);var t=[];for(var n in Object(e))Vs.call(e,n)&&n!="constructor"&&t.push(n);return t}(r)}var qs=Object.prototype.hasOwnProperty;function Ws(r){return Ze(r)?In(r,!0):function(e){if(!Be(e))return function(i){var o=[];if(i!=null)for(var a in Object(i))o.push(a);return o}(e);var t=or(e),n=[];for(var s in e)(s!="constructor"||!t&&qs.call(e,s))&&n.push(s);return n}(r)}var Gs=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Zs=/^\w*$/;function qt(r,e){if(ie(r))return!1;var t=typeof r;return!(t!="number"&&t!="symbol"&&t!="boolean"&&r!=null&&!qe(r))||Zs.test(r)||!Gs.test(r)||e!=null&&r in Object(e)}var Ke=ze(Object,"create"),Ys=Object.prototype.hasOwnProperty,Js=Object.prototype.hasOwnProperty;function $e(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function dt(r,e){for(var t=r.length;t--;)if(Ct(r[t][0],e))return t;return-1}$e.prototype.clear=function(){this.__data__=Ke?Ke(null):{},this.size=0},$e.prototype.delete=function(r){var e=this.has(r)&&delete this.__data__[r];return this.size-=e?1:0,e},$e.prototype.get=function(r){var e=this.__data__;if(Ke){var t=e[r];return t==="__lodash_hash_undefined__"?void 0:t}return Ys.call(e,r)?e[r]:void 0},$e.prototype.has=function(r){var e=this.__data__;return Ke?e[r]!==void 0:Js.call(e,r)},$e.prototype.set=function(r,e){var t=this.__data__;return this.size+=this.has(r)?0:1,t[r]=Ke&&e===void 0?"__lodash_hash_undefined__":e,this};var Qs=Array.prototype.splice;function Ee(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}Ee.prototype.clear=function(){this.__data__=[],this.size=0},Ee.prototype.delete=function(r){var e=this.__data__,t=dt(e,r);return!(t<0||(t==e.length-1?e.pop():Qs.call(e,t,1),--this.size,0))},Ee.prototype.get=function(r){var e=this.__data__,t=dt(e,r);return t<0?void 0:e[t][1]},Ee.prototype.has=function(r){return dt(this.__data__,r)>-1},Ee.prototype.set=function(r,e){var t=this.__data__,n=dt(t,r);return n<0?(++this.size,t.push([r,e])):t[n][1]=e,this};var rt=ze(_e,"Map");function ht(r,e){var t,n,s=r.__data__;return((n=typeof(t=e))=="string"||n=="number"||n=="symbol"||n=="boolean"?t!=="__proto__":t===null)?s[typeof e=="string"?"string":"hash"]:s.map}function Ce(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function lr(r,e){if(typeof r!="function"||e!=null&&typeof e!="function")throw new TypeError("Expected a function");var t=function(){var n=arguments,s=e?e.apply(this,n):n[0],i=t.cache;if(i.has(s))return i.get(s);var o=r.apply(this,n);return t.cache=i.set(s,o)||i,o};return t.cache=new(lr.Cache||Ce),t}Ce.prototype.clear=function(){this.size=0,this.__data__={hash:new $e,map:new(rt||Ee),string:new $e}},Ce.prototype.delete=function(r){var e=ht(this,r).delete(r);return this.size-=e?1:0,e},Ce.prototype.get=function(r){return ht(this,r).get(r)},Ce.prototype.has=function(r){return ht(this,r).has(r)},Ce.prototype.set=function(r,e){var t=ht(this,r),n=t.size;return t.set(r,e),this.size+=t.size==n?0:1,this},lr.Cache=Ce;var Tt,Dt,Xs=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Ks=/\\(\\)?/g,ei=(Tt=lr(function(r){var e=[];return r.charCodeAt(0)===46&&e.push(""),r.replace(Xs,function(t,n,s,i){e.push(s?i.replace(Ks,"$1"):n||t)}),e},function(r){return Dt.size===500&&Dt.clear(),r}),Dt=Tt.cache,Tt);function jn(r,e){return ie(r)?r:qt(r,e)?[r]:ei(function(t){return t==null?"":xn(t)}(r))}function mt(r){if(typeof r=="string"||qe(r))return r;var e=r+"";return e=="0"&&1/r==-1/0?"-0":e}function Wt(r,e){for(var t=0,n=(e=jn(e,r)).length;r!=null&&t<n;)r=r[mt(e[t++])];return t&&t==n?r:void 0}function cr(r,e){for(var t=-1,n=e.length,s=r.length;++t<n;)r[s+t]=e[t];return r}var Br=me?me.isConcatSpreadable:void 0;function ti(r){return ie(r)||ar(r)||!!(Br&&r&&r[Br])}function ri(r,e,t,n,s){var i=-1,o=r.length;for(t||(t=ti),s||(s=[]);++i<o;){var a=r[i];t(a)?cr(s,a):s[s.length]=a}return s}var Fn=Ln(Object.getPrototypeOf,Object);function xe(r){var e=this.__data__=new Ee(r);this.size=e.size}xe.prototype.clear=function(){this.__data__=new Ee,this.size=0},xe.prototype.delete=function(r){var e=this.__data__,t=e.delete(r);return this.size=e.size,t},xe.prototype.get=function(r){return this.__data__.get(r)},xe.prototype.has=function(r){return this.__data__.has(r)},xe.prototype.set=function(r,e){var t=this.__data__;if(t instanceof Ee){var n=t.__data__;if(!rt||n.length<199)return n.push([r,e]),this.size=++t.size,this;t=this.__data__=new Ce(n)}return t.set(r,e),this.size=t.size,this};var On=typeof fe=="object"&&fe&&!fe.nodeType&&fe,Rr=On&&typeof pe=="object"&&pe&&!pe.nodeType&&pe,zr=Rr&&Rr.exports===On?_e.Buffer:void 0,Tr=zr?zr.allocUnsafe:void 0;function Nn(){return[]}var ni=Object.prototype.propertyIsEnumerable,Dr=Object.getOwnPropertySymbols,si=Dr?function(r){return r==null?[]:(r=Object(r),function(e,t){for(var n=-1,s=e==null?0:e.length,i=0,o=[];++n<s;){var a=e[n];ni.call(r,a)&&(o[i++]=a)}return o}(Dr(r)))}:Nn,ur=si,ii=Object.getOwnPropertySymbols?function(r){for(var e=[];r;)cr(e,ur(r)),r=Fn(r);return e}:Nn;function oi(r,e,t){var n=e(r);return ie(r)?n:cr(n,t(r))}function Gt(r){return oi(r,it,ur)}var Zt=ze(_e,"DataView"),Yt=ze(_e,"Promise"),Jt=ze(_e,"Set"),Hr="[object Map]",Ur="[object Promise]",Vr="[object Set]",qr="[object WeakMap]",Wr="[object DataView]",ai=Re(Zt),li=Re(rt),ci=Re(Yt),ui=Re(Jt),di=Re(Vt),Ne=Ge;(Zt&&Ne(new Zt(new ArrayBuffer(1)))!=Wr||rt&&Ne(new rt)!=Hr||Yt&&Ne(Yt.resolve())!=Ur||Jt&&Ne(new Jt)!=Vr||Vt&&Ne(new Vt)!=qr)&&(Ne=function(r){var e=Ge(r),t=e=="[object Object]"?r.constructor:void 0,n=t?Re(t):"";if(n)switch(n){case ai:return Wr;case li:return Hr;case ci:return Ur;case ui:return Vr;case di:return qr}return e});var nt=Ne,hi=Object.prototype.hasOwnProperty,xt=_e.Uint8Array;function fi(r){var e=new r.constructor(r.byteLength);return new xt(e).set(new xt(r)),e}var pi=/\w*$/,Gr=me?me.prototype:void 0,Zr=Gr?Gr.valueOf:void 0,gi="[object Boolean]",mi="[object Date]",vi="[object Map]",bi="[object Number]",yi="[object RegExp]",wi="[object Set]",xi="[object String]",_i="[object Symbol]",Si="[object ArrayBuffer]",Ci="[object DataView]",Ei="[object Float32Array]",ki="[object Float64Array]",Mi="[object Int8Array]",Ai="[object Int16Array]",Ii="[object Int32Array]",Li="[object Uint8Array]",ji="[object Uint8ClampedArray]",Fi="[object Uint16Array]",Oi="[object Uint32Array]",Yr=We&&We.isMap,Ni=Yr?Et(Yr):function(r){return ke(r)&&nt(r)=="[object Map]"},Jr=We&&We.isSet,$i=Jr?Et(Jr):function(r){return ke(r)&&nt(r)=="[object Set]"},Pi=2,$n="[object Arguments]",Pn="[object Function]",Bi="[object GeneratorFunction]",Bn="[object Object]",q={};function vt(r,e,t,n,s,i){var o,a=e&Pi;if(o!==void 0)return o;if(!Be(r))return r;var l=ie(r);if(l)return o=function(d){var y=d.length,x=new d.constructor(y);return y&&typeof d[0]=="string"&&hi.call(d,"index")&&(x.index=d.index,x.input=d.input),x}(r),function(d,y){var x=-1,C=d.length;for(y||(y=Array(C));++x<C;)y[x]=d[x];return y}(r,o);var u=nt(r),f=u==Pn||u==Bi;if(wt(r))return function(d,y){var x=d.length,C=Tr?Tr(x):new d.constructor(x);return d.copy(C),C}(r);if(u==Bn||u==$n||f&&!s)return o=f?{}:function(d){return typeof d.constructor!="function"||or(d)?{}:As(Fn(d))}(r),a?function(d,y){return ut(d,ii(d),y)}(r,function(d,y){return d&&ut(y,Ws(y),d)}(o,r)):function(d,y){return ut(d,ur(d),y)}(r,function(d,y){return d&&ut(y,it(y),d)}(o,r));if(!q[u])return s?r:{};o=function(d,y,x){var C,j,$=d.constructor;switch(y){case Si:return fi(d);case gi:case mi:return new $(+d);case Ci:return function(R,B){var G=R.buffer;return new R.constructor(G,R.byteOffset,R.byteLength)}(d);case Ei:case ki:case Mi:case Ai:case Ii:case Li:case ji:case Fi:case Oi:return function(R,B){var G=R.buffer;return new R.constructor(G,R.byteOffset,R.length)}(d);case vi:return new $;case bi:case xi:return new $(d);case yi:return(j=new(C=d).constructor(C.source,pi.exec(C))).lastIndex=C.lastIndex,j;case wi:return new $;case _i:return Zr?Object(Zr.call(d)):{}}}(r,u),i||(i=new xe);var v=i.get(r);if(v)return v;i.set(r,o),$i(r)?r.forEach(function(d){o.add(vt(d,e,t,d,r,i))}):Ni(r)&&r.forEach(function(d,y){o.set(y,vt(d,e,t,y,r,i))});var m=l?void 0:Gt(r);return function(d,y){for(var x=-1,C=d==null?0:d.length;++x<C&&y(d[x],x)!==!1;);}(m||r,function(d,y){m&&(d=r[y=d]),Sn(o,y,vt(d,e,t,y,r,i))}),o}function Ht(r){return vt(r,4)}function tt(r){var e=-1,t=r==null?0:r.length;for(this.__data__=new Ce;++e<t;)this.add(r[e])}function Ri(r,e){for(var t=-1,n=r==null?0:r.length;++t<n;)if(e(r[t],t,r))return!0;return!1}function Qt(r,e){return r.has(e)}q[$n]=q["[object Array]"]=q["[object ArrayBuffer]"]=q["[object DataView]"]=q["[object Boolean]"]=q["[object Date]"]=q["[object Float32Array]"]=q["[object Float64Array]"]=q["[object Int8Array]"]=q["[object Int16Array]"]=q["[object Int32Array]"]=q["[object Map]"]=q["[object Number]"]=q[Bn]=q["[object RegExp]"]=q["[object Set]"]=q["[object String]"]=q["[object Symbol]"]=q["[object Uint8Array]"]=q["[object Uint8ClampedArray]"]=q["[object Uint16Array]"]=q["[object Uint32Array]"]=!0,q["[object Error]"]=q[Pn]=q["[object WeakMap]"]=!1,tt.prototype.add=tt.prototype.push=function(r){return this.__data__.set(r,"__lodash_hash_undefined__"),this},tt.prototype.has=function(r){return this.__data__.has(r)};var zi=1,Ti=2;function Qr(r,e,t,n,s,i){var o=t&zi,a=r.length,l=e.length;if(a!=l&&!(o&&l>a))return!1;var u=i.get(r),f=i.get(e);if(u&&f)return u==e&&f==r;var v=-1,m=!0,d=t&Ti?new tt:void 0;for(i.set(r,e),i.set(e,r);++v<a;){var y=r[v],x=e[v];if(n)var C=o?n(x,y,v,e,r,i):n(y,x,v,r,e,i);if(C!==void 0){if(C)continue;m=!1;break}if(d){if(!Ri(e,function(j,$){if(!Qt(d,$)&&(y===j||s(y,j,t,n,i)))return d.push($)})){m=!1;break}}else if(y!==x&&!s(y,x,t,n,i)){m=!1;break}}return i.delete(r),i.delete(e),m}function Di(r){var e=-1,t=Array(r.size);return r.forEach(function(n,s){t[++e]=[s,n]}),t}function Hi(r){var e=-1,t=Array(r.size);return r.forEach(function(n){t[++e]=n}),t}var Ui=1,Vi=2,qi="[object Boolean]",Wi="[object Date]",Gi="[object Error]",Zi="[object Map]",Yi="[object Number]",Ji="[object RegExp]",Qi="[object Set]",Xi="[object String]",Ki="[object Symbol]",eo="[object ArrayBuffer]",to="[object DataView]",Xr=me?me.prototype:void 0,Ut=Xr?Xr.valueOf:void 0,ro=1,no=Object.prototype.hasOwnProperty,so=1,Kr="[object Arguments]",en="[object Array]",ft="[object Object]",tn=Object.prototype.hasOwnProperty;function Xt(r,e,t,n,s){return r===e||(r==null||e==null||!ke(r)&&!ke(e)?r!=r&&e!=e:function(i,o,a,l,u,f){var v=ie(i),m=ie(o),d=v?en:nt(i),y=m?en:nt(o),x=(d=d==Kr?ft:d)==ft,C=(y=y==Kr?ft:y)==ft,j=d==y;if(j&&wt(i)){if(!wt(o))return!1;v=!0,x=!1}if(j&&!x)return f||(f=new xe),v||An(i)?Qr(i,o,a,l,u,f):function(F,N,J,ce,be,te,le){switch(J){case to:if(F.byteLength!=N.byteLength||F.byteOffset!=N.byteOffset)return!1;F=F.buffer,N=N.buffer;case eo:return!(F.byteLength!=N.byteLength||!te(new xt(F),new xt(N)));case qi:case Wi:case Yi:return Ct(+F,+N);case Gi:return F.name==N.name&&F.message==N.message;case Ji:case Xi:return F==N+"";case Zi:var ue=Di;case Qi:if(ue||(ue=Hi),F.size!=N.size&&!(ce&Ui))return!1;var ge=le.get(F);if(ge)return ge==N;ce|=Vi,le.set(F,N);var de=Qr(ue(F),ue(N),ce,be,te,le);return le.delete(F),de;case Ki:if(Ut)return Ut.call(F)==Ut.call(N)}return!1}(i,o,d,a,l,u,f);if(!(a&so)){var $=x&&tn.call(i,"__wrapped__"),R=C&&tn.call(o,"__wrapped__");if($||R){var B=$?i.value():i,G=R?o.value():o;return f||(f=new xe),u(B,G,a,l,f)}}return!!j&&(f||(f=new xe),function(F,N,J,ce,be,te){var le=J&ro,ue=Gt(F),ge=ue.length;if(ge!=Gt(N).length&&!le)return!1;for(var de=ge;de--;){var w=ue[de];if(!(le?w in N:no.call(N,w)))return!1}var c=te.get(F),p=te.get(N);if(c&&p)return c==N&&p==F;var _=!0;te.set(F,N),te.set(N,F);for(var E=le;++de<ge;){var A=F[w=ue[de]],I=N[w];if(ce)var T=le?ce(I,A,w,N,F,te):ce(A,I,w,F,N,te);if(!(T===void 0?A===I||be(A,I,J,ce,te):T)){_=!1;break}E||(E=w=="constructor")}if(_&&!E){var X=F.constructor,D=N.constructor;X==D||!("constructor"in F)||!("constructor"in N)||typeof X=="function"&&X instanceof X&&typeof D=="function"&&D instanceof D||(_=!1)}return te.delete(F),te.delete(N),_}(i,o,a,l,u,f))}(r,e,t,n,Xt,s))}var io=1,oo=2;function rn(r){return r==r&&!Be(r)}function nn(r,e){return function(t){return t!=null&&t[r]===e&&(e!==void 0||r in Object(t))}}function ao(r,e){return r!=null&&e in Object(r)}var lo=1,co=2;function Te(r){return typeof r=="function"?r:r==null?St:typeof r=="object"?ie(r)?function(i,o){return qt(i)&&rn(o)?nn(mt(i),o):function(a){var l=function(u,f,v){var m=u==null?void 0:Wt(u,f);return m===void 0?void 0:m}(a,i);return l===void 0&&l===o?function(u,f){return u!=null&&function(v,m,d){for(var y=-1,x=(m=jn(m,v)).length,C=!1;++y<x;){var j=mt(m[y]);if(!(C=v!=null&&d(v,j)))break;v=v[j]}return C||++y!=x?C:!!(x=v==null?0:v.length)&&ir(x)&&nr(j,x)&&(ie(v)||ar(v))}(u,f,ao)}(a,i):Xt(o,l,lo|co)}}(r[0],r[1]):(s=function(i){for(var o=it(i),a=o.length;a--;){var l=o[a],u=i[l];o[a]=[l,u,rn(u)]}return o}(n=r),s.length==1&&s[0][2]?nn(s[0][0],s[0][1]):function(i){return i===n||function(o,a,l,u){var f=l.length,v=f;if(o==null)return!v;for(o=Object(o);f--;){var m=l[f];if(m[2]?m[1]!==o[m[0]]:!(m[0]in o))return!1}for(;++f<v;){var d=(m=l[f])[0],y=o[d],x=m[1];if(m[2]){if(y===void 0&&!(d in o))return!1}else{var C=new xe;if(!Xt(x,y,io|oo,void 0,C))return!1}}return!0}(i,0,s)}):qt(e=r)?(t=mt(e),function(i){return i==null?void 0:i[t]}):function(i){return function(o){return Wt(o,i)}}(e);var e,t,n,s}var uo=function(r,e,t){for(var n=-1,s=Object(r),i=t(r),o=i.length;o--;){var a=i[++n];if(e(s[a],a,s)===!1)break}return r};function Rn(r,e){return r&&uo(r,e,it)}var sn,ho=(sn=Rn,function(r,e){if(r==null)return r;if(!Ze(r))return sn(r,e);for(var t=r.length,n=-1,s=Object(r);++n<t&&e(s[n],n,s)!==!1;);return r});function zn(r,e){var t=-1,n=Ze(r)?Array(r.length):[];return ho(r,function(s,i,o){n[++t]=e(s,i,o)}),n}function fo(r,e){return r>e}var po=Math.min;function go(r){return function(e){return ke(e)&&Ze(e)}(r)?r:[]}var mo=Cn(function(r){var e=Ve(r,go);return e.length&&e[0]===r[0]?function(t,n,s){for(var i=Ns,o=t[0].length,a=t.length,l=a,u=Array(a),f=1/0,v=[];l--;){var m=t[l];f=po(m.length,f),u[l]=o>=120&&m.length>=120?new tt(l&&m):void 0}m=t[0];var d=-1,y=u[0];e:for(;++d<o&&v.length<f;){var x=m[d],C=x;if(x=x!==0?x:0,!(y?Qt(y,C):i(v,C,s))){for(l=a;--l;){var j=u[l];if(!(j?Qt(j,C):i(t[l],C,s)))continue e}y&&y.push(C),v.push(x)}}return v}(e):[]}),vo=mo;function bo(r,e){return r<e}function z(r,e){var t={};return e=Te(e),Rn(r,function(n,s,i){sr(t,s,e(n,s,i))}),t}function Tn(r,e,t){for(var n=-1,s=r.length;++n<s;){var i=r[n],o=e(i);if(o!=null&&(a===void 0?o==o&&!qe(o):t(o,a)))var a=o,l=i}return l}function yo(r,e){return r&&r.length?Tn(r,Te(e),fo):void 0}function Dn(r,e){for(var t,n=-1,s=r.length;++n<s;){var i=e(r[n]);i!==void 0&&(t=t===void 0?i:t+i)}return t}function wo(r,e){return function(t,n){var s=t==null?0:t.length;return s?Dn(t,n)/s:NaN}(r,Te(e))}function xo(r,e){if(r!==e){var t=r!==void 0,n=r===null,s=r==r,i=qe(r),o=e!==void 0,a=e===null,l=e==e,u=qe(e);if(!a&&!u&&!i&&r>e||i&&o&&l&&!a&&!u||n&&o&&l||!t&&l||!s)return 1;if(!n&&!i&&!u&&r<e||u&&t&&s&&!n&&!i||a&&t&&s||!o&&s||!l)return-1}return 0}function Hn(r,e,t){e=e.length?Ve(e,function(s){return ie(s)?function(i){return Wt(i,s.length===1?s[0]:s)}:s}):[St];var n=-1;return e=Ve(e,Et(Te)),function(s,i){var o=s.length;for(s.sort(function(a,l){return function(u,f,v){for(var m=-1,d=u.criteria,y=f.criteria,x=d.length,C=v.length;++m<x;){var j=xo(d[m],y[m]);if(j)return m>=C?j:j*(v[m]=="desc"?-1:1)}return u.index-f.index}(a,l,t)});o--;)s[o]=s[o].value;return s}(zn(r,function(s,i,o){return{criteria:Ve(e,function(a){return a(s)}),index:++n,value:s}}))}function dr(r,e,t,n){return r==null?[]:(ie(e)||(e=e==null?[]:[e]),ie(t=t)||(t=t==null?[]:[t]),Hn(r,e,t))}var _o=Cn(function(r,e){if(r==null)return[];var t=e.length;return t>1&&Fr(r,e[0],e[1])?e=[]:t>2&&Fr(e[0],e[1],e[2])&&(e=[e[0]]),Hn(r,ri(e),[])});function So(r,e){return r&&r.length?Dn(r,Te(e)):0}function P(r){if(this.words=[],r)if(Symbol&&Symbol.iterator&&r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();let t=e.next();for(;!t.done;)this.add(t.value),t=e.next()}else for(let e=0;e<r.length;e++)this.add(r[e])}P.fromWords=function(r){const e=Object.create(P.prototype);return e.words=r,e},P.prototype.add=function(r){this.resize(r),this.words[r>>>5]|=1<<r},P.prototype.flip=function(r){this.resize(r),this.words[r>>>5]^=1<<r},P.prototype.clear=function(){this.words.length=0},P.prototype.remove=function(r){this.resize(r),this.words[r>>>5]&=~(1<<r)},P.prototype.isEmpty=function(r){const e=this.words.length;for(let t=0;t<e;t++)if(this.words[t]!==0)return!1;return!0},P.prototype.has=function(r){return(this.words[r>>>5]&1<<r)!=0},P.prototype.checkedAdd=function(r){this.resize(r);const e=this.words[r>>>5],t=e|1<<r;return this.words[r>>>5]=t,(t^e)>>>r},P.prototype.trim=function(r){let e=this.words.length;for(;e>0&&this.words[e-1]===0;)e--;this.words.length=e},P.prototype.resize=function(r){const e=r+32>>>5;for(let t=this.words.length;t<e;t++)this.words[t]=0},P.prototype.hammingWeight=function(r){return 16843009*((r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)>>>24},P.prototype.hammingWeight4=function(r,e,t,n){return 16843009*((r=(r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)+(e=(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)+(t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)+(n=(n=(858993459&(n-=n>>>1&1431655765))+(n>>>2&858993459))+(n>>>4)&252645135))>>>24},P.prototype.size=function(){let r=0;const e=this.words.length,t=this.words;for(let n=0;n<e;n++)r+=this.hammingWeight(t[n]);return r},P.prototype.array=function(){const r=new Array(this.size());let e=0;const t=this.words.length;for(let n=0;n<t;++n){let s=this.words[n];for(;s!=0;){const i=s&-s;r[e++]=(n<<5)+this.hammingWeight(i-1|0),s^=i}}return r},P.prototype.forEach=function(r){const e=this.words.length;for(let t=0;t<e;++t){let n=this.words[t];for(;n!=0;){const s=n&-n;r((t<<5)+this.hammingWeight(s-1|0)),n^=s}}},P.prototype[Symbol.iterator]=function(){const r=this.words.length;let e=0,t=this.words[e],n=this.hammingWeight,s=this.words;return{[Symbol.iterator](){return this},next(){for(;e<r;){if(t!==0){const i=t&-t,o=(e<<5)+n(i-1|0);return t^=i,{done:!1,value:o}}e++,e<r&&(t=s[e])}return{done:!0,value:void 0}}}},P.prototype.clone=function(){const r=Object.create(P.prototype);return r.words=this.words.slice(),r},P.prototype.intersects=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]&r.words[t])return!0;return!1},P.prototype.intersection=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=r.words[t],this.words[t+1]&=r.words[t+1],this.words[t+2]&=r.words[t+2],this.words[t+3]&=r.words[t+3],this.words[t+4]&=r.words[t+4],this.words[t+5]&=r.words[t+5],this.words[t+6]&=r.words[t+6],this.words[t+7]&=r.words[t+7];for(;t<e;++t)this.words[t]&=r.words[t];const n=this.words.length;for(t=e;t<n;++t)this.words[t]=0;return this},P.prototype.intersection_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]&r.words[n]);return t},P.prototype.new_intersection=function(r){const e=Object.create(P.prototype),t=Math.min(this.words.length,r.words.length);e.words=new Array(t);let n=0;for(;n+7<t;n+=8)e.words[n]=this.words[n]&r.words[n],e.words[n+1]=this.words[n+1]&r.words[n+1],e.words[n+2]=this.words[n+2]&r.words[n+2],e.words[n+3]=this.words[n+3]&r.words[n+3],e.words[n+4]=this.words[n+4]&r.words[n+4],e.words[n+5]=this.words[n+5]&r.words[n+5],e.words[n+6]=this.words[n+6]&r.words[n+6],e.words[n+7]=this.words[n+7]&r.words[n+7];for(;n<t;++n)e.words[n]=this.words[n]&r.words[n];return e},P.prototype.equals=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]!=r.words[t])return!1;if(this.words.length<r.words.length){const t=r.words.length;for(let n=this.words.length;n<t;++n)if(r.words[n]!=0)return!1}else if(r.words.length<this.words.length){const t=this.words.length;for(let n=r.words.length;n<t;++n)if(this.words[n]!=0)return!1}return!0},P.prototype.difference=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=~r.words[t],this.words[t+1]&=~r.words[t+1],this.words[t+2]&=~r.words[t+2],this.words[t+3]&=~r.words[t+3],this.words[t+4]&=~r.words[t+4],this.words[t+5]&=~r.words[t+5],this.words[t+6]&=~r.words[t+6],this.words[t+7]&=~r.words[t+7];for(;t<e;++t)this.words[t]&=~r.words[t];return this},P.prototype.new_difference=function(r){return this.clone().difference(r)},P.prototype.difference2=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)r.words[t]=this.words[t]&~r.words[t],r.words[t+1]=this.words[t+1]&~r.words[t+1],r.words[t+2]=this.words[t+2]&~r.words[t+2],r.words[t+3]=this.words[t+3]&~r.words[t+3],r.words[t+4]=this.words[t+4]&~r.words[t+4],r.words[t+5]=this.words[t+5]&~r.words[t+5],r.words[t+6]=this.words[t+6]&~r.words[t+6],r.words[t+7]=this.words[t+7]&~r.words[t+7];for(;t<e;++t)r.words[t]=this.words[t]&~r.words[t];for(t=this.words.length-1;t>=e;--t)r.words[t]=this.words[t];return r.words.length=this.words.length,r},P.prototype.difference_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]&~r.words[n]);const s=this.words.length;for(;n<s;++n)t+=this.hammingWeight(this.words[n]);return t},P.prototype.change=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]^=r.words[t],this.words[t+1]^=r.words[t+1],this.words[t+2]^=r.words[t+2],this.words[t+3]^=r.words[t+3],this.words[t+4]^=r.words[t+4],this.words[t+5]^=r.words[t+5],this.words[t+6]^=r.words[t+6],this.words[t+7]^=r.words[t+7];for(;t<e;++t)this.words[t]^=r.words[t];for(t=r.words.length-1;t>=e;--t)this.words[t]=r.words[t];return this},P.prototype.new_change=function(r){const e=Object.create(P.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let s=0;for(;s+7<n;s+=8)e.words[s]=this.words[s]^r.words[s],e.words[s+1]=this.words[s+1]^r.words[s+1],e.words[s+2]=this.words[s+2]^r.words[s+2],e.words[s+3]=this.words[s+3]^r.words[s+3],e.words[s+4]=this.words[s+4]^r.words[s+4],e.words[s+5]=this.words[s+5]^r.words[s+5],e.words[s+6]=this.words[s+6]^r.words[s+6],e.words[s+7]=this.words[s+7]^r.words[s+7];for(;s<n;++s)e.words[s]=this.words[s]^r.words[s];const i=this.words.length;for(s=n;s<i;++s)e.words[s]=this.words[s];const o=r.words.length;for(s=n;s<o;++s)e.words[s]=r.words[s];return e},P.prototype.change_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]^r.words[n]);const s=this.words.length>r.words.length?this:r,i=s.words.length;for(;n<i;++n)t+=this.hammingWeight(s.words[n]);return t},P.prototype.toString=function(){return"{"+this.array().join(",")+"}"},P.prototype.union=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]|=r.words[t],this.words[t+1]|=r.words[t+1],this.words[t+2]|=r.words[t+2],this.words[t+3]|=r.words[t+3],this.words[t+4]|=r.words[t+4],this.words[t+5]|=r.words[t+5],this.words[t+6]|=r.words[t+6],this.words[t+7]|=r.words[t+7];for(;t<e;++t)this.words[t]|=r.words[t];if(this.words.length<r.words.length){this.resize((r.words.length<<5)-1);const n=r.words.length;for(let s=e;s<n;++s)this.words[s]=r.words[s]}return this},P.prototype.new_union=function(r){const e=Object.create(P.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let s=0;for(;s+7<n;s+=8)e.words[s]=this.words[s]|r.words[s],e.words[s+1]=this.words[s+1]|r.words[s+1],e.words[s+2]=this.words[s+2]|r.words[s+2],e.words[s+3]=this.words[s+3]|r.words[s+3],e.words[s+4]=this.words[s+4]|r.words[s+4],e.words[s+5]=this.words[s+5]|r.words[s+5],e.words[s+6]=this.words[s+6]|r.words[s+6],e.words[s+7]=this.words[s+7]|r.words[s+7];for(;s<n;++s)e.words[s]=this.words[s]|r.words[s];const i=this.words.length;for(s=n;s<i;++s)e.words[s]=this.words[s];const o=r.words.length;for(s=n;s<o;++s)e.words[s]=r.words[s];return e},P.prototype.union_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]|r.words[n]);if(this.words.length<r.words.length){const n=r.words.length;for(let s=this.words.length;s<n;++s)t+=this.hammingWeight(0|r.words[s])}else{const n=this.words.length;for(let s=r.words.length;s<n;++s)t+=this.hammingWeight(0|this.words[s])}return t};var ae=P;function Kt(){return Kt=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Kt.apply(this,arguments)}function Co(r,e){var t=[];return r.forEach(function(n){e.forEach(function(s){t.push(n.concat(s))})}),t}function Un(r){return!!~r.search(/\(|\)/)}function on(r,e){for(var t=e.split(" "+r+" "),n=[],s=[],i=0;i<t.length;i++)if(Un(t[i])||s.length>0){s.push(t[i]);var o=""+s;(o.match(/\(/g)||[]).length===(o.match(/\)/g)||[]).length&&(n.push(s.join(" "+r+" ")),s=[])}else n.push(t[i]);return n}var Eo=function r(e){return function(n){for(var s=n[0],i=1;i<n.length;i++)s=s.concat(n[i]);return s}(on("OR",(t=e=function(n){if(n.charAt(0)==="("){for(var s=0,i=0;i<n.length;i++)if(n.charAt(i)==="("?s++:n.charAt(i)===")"&&s--,s===0)return i!==n.length-1?n:n.substring(1,n.length-1)}return n}(e),e=t.replace(/[\s]+/g," "))).map(function(n){for(var s=on("AND",n),i=[],o=[],a=0;a<s.length;a++)Un(s[a])?i.push(r(s[a])):o.push(s[a]);return i.push([o]),function(l){for(var u=[[]],f=0;f<l.length;f++)u=Co(u,l[f]);return u}(i)}));var t};const an=function(r){try{return structuredClone(r)}catch{try{return JSON.parse(JSON.stringify(r))}catch{return r}}},ln=function(r,e){let t=new ae([]),n=0;return z(e,function(s,i){s.forEach(o=>{++n,t=t.new_union(r[i][o]||new ae([]))})}),n===0?null:t},ko=function(r,e,t){let n=1;return z(r.bits_data_temp,(s,i)=>{let o,a,l,u,f,v,m;t[i]&&(o=t[i].order,a=t[i].sort,l=t[i].size,u=t[i].title,f=t[i].show_facet_stats||!1,v=t[i].chosen_filters_on_top!==!1,m=t[i].hide_zero_doc_count||!1);let d,y,x,C,j=Object.entries(s).map(B=>{let G=[];e&&e.filters&&e.filters[i]&&(G=e.filters[i]);const F=B[1].array().length;if(!m||F!==0||G.indexOf(B[0])!==-1)return{key:B[0],doc_count:F,selected:G.indexOf(B[0])!==-1}}).filter(Boolean);var $,R;return ie(a)?(d=a||["key"],y=o||["asc"]):(a==="term"||a==="key"?(d=["key"],y=[o||"asc"]):(d=["doc_count","key"],y=[o||"desc","asc"]),v&&(d.unshift("selected"),y.unshift("desc"))),j=dr(j,d,y),j=j.slice(0,l||10),f&&(x=[],Object.entries(s).forEach(B=>{if(isNaN(B[0]))throw new Error("You cant use chars to calculate the facet_stats.");B[1].array().length>0&&B[1].forEach(()=>{x.push(parseInt(B[0]))})}),C={min:($=x,$&&$.length?Tn($,Te(void 0),bo):void 0),max:yo(x),avg:wo(x),sum:So(x)}),Kt({name:i,title:u||(R=i,R.replace(/^[\s_]+|[\s_]+$/g,"").replace(/[_\s]+/g," ").replace(/^[a-z]/,function(B){return B.toUpperCase()})),position:n++,buckets:j},f&&{facet_stats:C})})};function cn(r,e,t,n,s){e=e||Object.create(null);const i=parseInt(e.per_page||12),o=parseInt(e.page||1),a=e.is_all_filtered_items||!1;if(t.native_search_enabled===!1&&(e.query||e.filter))throw new Error('"query" and "filter" options are not working once native search is disabled');let l=0;const u=new Date().getTime();let f,v,m,d=s.bits_ids();if(e._ids)f=new ae(e._ids),v=e._ids;else if(e.ids)v=s.internal_ids_from_ids_map(e.ids),f=new ae(v);else if(n&&(e.query||e.filter)){const F=new Date().getTime();v=n.search(e.query,e.filter),l=new Date().getTime()-F,f=new ae(v)}let y=new Date().getTime();const x=s.search(e,{query_ids:f});y=new Date().getTime()-y,f&&(d=f),x.ids&&(d=d.new_intersection(x.ids)),x.not_ids&&(d=d.new_difference(x.not_ids));let C=d.array(),j=C.map(F=>s.get_item(F)),$=!1;const R=new Date().getTime();let B=0;e.sort?j=function(F,N,J){return J&&J[N]&&(N=J[N]),N.field?dr(F,N.field,N.order||"asc"):F}(j,e.sort,t.sortings):v&&(C=v.filter(F=>d.has(F)),j=C.slice((o-1)*i,o*i).map(F=>s.get_item(F)),$=!0),$||(m=a?j:null,j=j.slice((o-1)*i,o*i)),B=new Date().getTime()-R;const G=new Date().getTime()-u;return{pagination:{per_page:i,page:o,total:C.length},timings:{total:G,facets:y,search:l,sorting:B},data:{items:j,allFilteredItems:m,aggregations:ko(x,e,t.aggregations)}}}var pt=function(r){var e={exports:{}};return function(t,n){(function(){var s,i,o,a,l,u,f,v,m,d,y,x,C,j,$,R,B,G,F,N,J,ce,be,te,le,ue,ge,de,w=function(c){var p=new w.Index;return p.pipeline.add(w.trimmer,w.stopWordFilter,w.stemmer),c&&c.call(p,p),p};w.version="1.0.0",w.utils={},w.utils.warn=function(c){return function(p){c.console&&console.warn&&console.warn(p)}}(this),w.utils.asString=function(c){return c==null?"":c.toString()},w.EventEmitter=function(){this.events={}},w.EventEmitter.prototype.addListener=function(){var c=Array.prototype.slice.call(arguments),p=c.pop(),_=c;if(typeof p!="function")throw new TypeError("last argument must be a function");_.forEach(function(E){this.hasHandler(E)||(this.events[E]=[]),this.events[E].push(p)},this)},w.EventEmitter.prototype.removeListener=function(c,p){if(this.hasHandler(c)){var _=this.events[c].indexOf(p);this.events[c].splice(_,1),this.events[c].length||delete this.events[c]}},w.EventEmitter.prototype.emit=function(c){if(this.hasHandler(c)){var p=Array.prototype.slice.call(arguments,1);this.events[c].forEach(function(_){_.apply(void 0,p)})}},w.EventEmitter.prototype.hasHandler=function(c){return c in this.events},w.tokenizer=function(c){return arguments.length&&c!=null&&c!=null?Array.isArray(c)?c.map(function(p){return w.utils.asString(p).toLowerCase()}):c.toString().trim().toLowerCase().split(w.tokenizer.separator):[]},w.tokenizer.separator=/[\s\-]+/,w.tokenizer.load=function(c){var p=this.registeredFunctions[c];if(!p)throw new Error("Cannot load un-registered function: "+c);return p},w.tokenizer.label="default",w.tokenizer.registeredFunctions={default:w.tokenizer},w.tokenizer.registerFunction=function(c,p){p in this.registeredFunctions&&w.utils.warn("Overwriting existing tokenizer: "+p),c.label=p,this.registeredFunctions[p]=c},w.Pipeline=function(){this._stack=[]},w.Pipeline.registeredFunctions={},w.Pipeline.registerFunction=function(c,p){p in this.registeredFunctions&&w.utils.warn("Overwriting existing registered function: "+p),c.label=p,w.Pipeline.registeredFunctions[c.label]=c},w.Pipeline.warnIfFunctionNotRegistered=function(c){c.label&&c.label in this.registeredFunctions||w.utils.warn(`Function is not registered with pipeline. This may cause problems when serialising the index.
`,c)},w.Pipeline.load=function(c){var p=new w.Pipeline;return c.forEach(function(_){var E=w.Pipeline.registeredFunctions[_];if(!E)throw new Error("Cannot load un-registered function: "+_);p.add(E)}),p},w.Pipeline.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(c){w.Pipeline.warnIfFunctionNotRegistered(c),this._stack.push(c)},this)},w.Pipeline.prototype.after=function(c,p){w.Pipeline.warnIfFunctionNotRegistered(p);var _=this._stack.indexOf(c);if(_==-1)throw new Error("Cannot find existingFn");this._stack.splice(_+=1,0,p)},w.Pipeline.prototype.before=function(c,p){w.Pipeline.warnIfFunctionNotRegistered(p);var _=this._stack.indexOf(c);if(_==-1)throw new Error("Cannot find existingFn");this._stack.splice(_,0,p)},w.Pipeline.prototype.remove=function(c){var p=this._stack.indexOf(c);p!=-1&&this._stack.splice(p,1)},w.Pipeline.prototype.run=function(c){for(var p=[],_=c.length,E=this._stack.length,A=0;A<_;A++){for(var I=c[A],T=0;T<E&&(I=this._stack[T](I,A,c))!==void 0&&I!=="";T++);I!==void 0&&I!==""&&p.push(I)}return p},w.Pipeline.prototype.reset=function(){this._stack=[]},w.Pipeline.prototype.toJSON=function(){return this._stack.map(function(c){return w.Pipeline.warnIfFunctionNotRegistered(c),c.label})},w.Vector=function(){this._magnitude=null,this.list=void 0,this.length=0},w.Vector.Node=function(c,p,_){this.idx=c,this.val=p,this.next=_},w.Vector.prototype.insert=function(c,p){this._magnitude=void 0;var _=this.list;if(!_)return this.list=new w.Vector.Node(c,p,_),this.length++;if(c<_.idx)return this.list=new w.Vector.Node(c,p,_),this.length++;for(var E=_,A=_.next;A!=null;){if(c<A.idx)return E.next=new w.Vector.Node(c,p,A),this.length++;E=A,A=A.next}return E.next=new w.Vector.Node(c,p,A),this.length++},w.Vector.prototype.magnitude=function(){if(this._magnitude)return this._magnitude;for(var c,p=this.list,_=0;p;)_+=(c=p.val)*c,p=p.next;return this._magnitude=Math.sqrt(_)},w.Vector.prototype.dot=function(c){for(var p=this.list,_=c.list,E=0;p&&_;)p.idx<_.idx?p=p.next:(p.idx>_.idx||(E+=p.val*_.val,p=p.next),_=_.next);return E},w.Vector.prototype.similarity=function(c){return this.dot(c)/(this.magnitude()*c.magnitude())},w.SortedSet=function(){this.length=0,this.elements=[]},w.SortedSet.load=function(c){var p=new this;return p.elements=c,p.length=c.length,p},w.SortedSet.prototype.add=function(){var c,p;for(c=0;c<arguments.length;c++)~this.indexOf(p=arguments[c])||this.elements.splice(this.locationFor(p),0,p);this.length=this.elements.length},w.SortedSet.prototype.toArray=function(){return this.elements.slice()},w.SortedSet.prototype.map=function(c,p){return this.elements.map(c,p)},w.SortedSet.prototype.forEach=function(c,p){return this.elements.forEach(c,p)},w.SortedSet.prototype.indexOf=function(c){for(var p=0,_=this.elements.length,E=_-p,A=p+Math.floor(E/2),I=this.elements[A];E>1;){if(I===c)return A;I<c&&(p=A),I>c&&(_=A),E=_-p,A=p+Math.floor(E/2),I=this.elements[A]}return I===c?A:-1},w.SortedSet.prototype.locationFor=function(c){for(var p=0,_=this.elements.length,E=_-p,A=p+Math.floor(E/2),I=this.elements[A];E>1;)I<c&&(p=A),I>c&&(_=A),E=_-p,A=p+Math.floor(E/2),I=this.elements[A];return I>c?A:I<c?A+1:void 0},w.SortedSet.prototype.intersect=function(c){for(var p=new w.SortedSet,_=0,E=0,A=this.length,I=c.length,T=this.elements,X=c.elements;!(_>A-1||E>I-1);)T[_]!==X[E]?T[_]<X[E]?_++:T[_]>X[E]&&E++:(p.add(T[_]),_++,E++);return p},w.SortedSet.prototype.clone=function(){var c=new w.SortedSet;return c.elements=this.toArray(),c.length=c.elements.length,c},w.SortedSet.prototype.union=function(c){var p,_,E;this.length>=c.length?(p=this,_=c):(p=c,_=this),E=p.clone();for(var A=0,I=_.toArray();A<I.length;A++)E.add(I[A]);return E},w.SortedSet.prototype.toJSON=function(){return this.toArray()},w.Index=function(){this._fields=[],this._ref="id",this.pipeline=new w.Pipeline,this.documentStore=new w.Store,this.tokenStore=new w.TokenStore,this.corpusTokens=new w.SortedSet,this.eventEmitter=new w.EventEmitter,this.tokenizerFn=w.tokenizer,this._idfCache={},this.on("add","remove","update",(function(){this._idfCache={}}).bind(this))},w.Index.prototype.on=function(){var c=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,c)},w.Index.prototype.off=function(c,p){return this.eventEmitter.removeListener(c,p)},w.Index.load=function(c){c.version!==w.version&&w.utils.warn("version mismatch: current "+w.version+" importing "+c.version);var p=new this;return p._fields=c.fields,p._ref=c.ref,p.tokenizer(w.tokenizer.load(c.tokenizer)),p.documentStore=w.Store.load(c.documentStore),p.tokenStore=w.TokenStore.load(c.tokenStore),p.corpusTokens=w.SortedSet.load(c.corpusTokens),p.pipeline=w.Pipeline.load(c.pipeline),p},w.Index.prototype.field=function(c,p){return this._fields.push({name:c,boost:(p=p||{}).boost||1}),this},w.Index.prototype.ref=function(c){return this._ref=c,this},w.Index.prototype.tokenizer=function(c){return c.label&&c.label in w.tokenizer.registeredFunctions||w.utils.warn("Function is not a registered tokenizer. This may cause problems when serialising the index"),this.tokenizerFn=c,this},w.Index.prototype.add=function(c,p){var _={},E=new w.SortedSet,A=c[this._ref];p=p===void 0||p,this._fields.forEach(function(De){var Me=this.pipeline.run(this.tokenizerFn(c[De.name]));_[De.name]=Me;for(var Ae=0;Ae<Me.length;Ae++){var Ie=Me[Ae];E.add(Ie),this.corpusTokens.add(Ie)}},this),this.documentStore.set(A,E);for(var I=0;I<E.length;I++){for(var T=E.elements[I],X=0,D=0;D<this._fields.length;D++){var ye=this._fields[D],Fe=_[ye.name],he=Fe.length;if(he){for(var we=0,Se=0;Se<he;Se++)Fe[Se]===T&&we++;X+=we/he*ye.boost}}this.tokenStore.add(T,{ref:A,tf:X})}p&&this.eventEmitter.emit("add",c,this)},w.Index.prototype.remove=function(c,p){var _=c[this._ref];if(p=p===void 0||p,this.documentStore.has(_)){var E=this.documentStore.get(_);this.documentStore.remove(_),E.forEach(function(A){this.tokenStore.remove(A,_)},this),p&&this.eventEmitter.emit("remove",c,this)}},w.Index.prototype.update=function(c,p){p=p===void 0||p,this.remove(c,!1),this.add(c,!1),p&&this.eventEmitter.emit("update",c,this)},w.Index.prototype.idf=function(c){var p="@"+c;if(Object.prototype.hasOwnProperty.call(this._idfCache,p))return this._idfCache[p];var _=this.tokenStore.count(c),E=1;return _>0&&(E=1+Math.log(this.documentStore.length/_)),this._idfCache[p]=E},w.Index.prototype.search=function(c){var p=this.pipeline.run(this.tokenizerFn(c)),_=new w.Vector,E=[],A=this._fields.reduce(function(I,T){return I+T.boost},0);return p.some(function(I){return this.tokenStore.has(I)},this)?(p.forEach(function(I,T,X){var D=1/X.length*this._fields.length*A,ye=this,Fe=this.tokenStore.expand(I).reduce(function(he,we){var Se=ye.corpusTokens.indexOf(we),De=ye.idf(we),Me=1,Ae=new w.SortedSet;if(we!==I){var Ie=Math.max(3,we.length-I.length);Me=1/Math.log(Ie)}Se>-1&&_.insert(Se,D*De*Me);for(var He=ye.tokenStore.get(we),ot=Object.keys(He),At=ot.length,Ye=0;Ye<At;Ye++)Ae.add(He[ot[Ye]].ref);return he.union(Ae)},new w.SortedSet);E.push(Fe)},this),E.reduce(function(I,T){return I.intersect(T)}).map(function(I){return{ref:I,score:_.similarity(this.documentVector(I))}},this).sort(function(I,T){return T.score-I.score})):[]},w.Index.prototype.documentVector=function(c){for(var p=this.documentStore.get(c),_=p.length,E=new w.Vector,A=0;A<_;A++){var I=p.elements[A],T=this.tokenStore.get(I)[c].tf,X=this.idf(I);E.insert(this.corpusTokens.indexOf(I),T*X)}return E},w.Index.prototype.toJSON=function(){return{version:w.version,fields:this._fields,ref:this._ref,tokenizer:this.tokenizerFn.label,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},w.Index.prototype.use=function(c){var p=Array.prototype.slice.call(arguments,1);p.unshift(this),c.apply(this,p)},w.Store=function(){this.store={},this.length=0},w.Store.load=function(c){var p=new this;return p.length=c.length,p.store=Object.keys(c.store).reduce(function(_,E){return _[E]=w.SortedSet.load(c.store[E]),_},{}),p},w.Store.prototype.set=function(c,p){this.has(c)||this.length++,this.store[c]=p},w.Store.prototype.get=function(c){return this.store[c]},w.Store.prototype.has=function(c){return c in this.store},w.Store.prototype.remove=function(c){this.has(c)&&(delete this.store[c],this.length--)},w.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},w.stemmer=(s={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},i={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},u="^("+(a="[^aeiou][^aeiouy]*")+")?"+(l=(o="[aeiouy]")+"[aeiou]*")+a+"("+l+")?$",f="^("+a+")?"+l+a+l+a,v="^("+a+")?"+o,m=new RegExp("^("+a+")?"+l+a),d=new RegExp(f),y=new RegExp(u),x=new RegExp(v),C=/^(.+?)(ss|i)es$/,j=/^(.+?)([^s])s$/,$=/^(.+?)eed$/,R=/^(.+?)(ed|ing)$/,B=/.$/,G=/(at|bl|iz)$/,F=new RegExp("([^aeiouylsz])\\1$"),N=new RegExp("^"+a+o+"[^aeiouwxy]$"),J=/^(.+?[^aeiou])y$/,ce=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,be=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,te=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,le=/^(.+?)(s|t)(ion)$/,ue=/^(.+?)e$/,ge=/ll$/,de=new RegExp("^"+a+o+"[^aeiouwxy]$"),function(c){var p,_,E,A,I,T,X;if(c.length<3)return c;if((E=c.substr(0,1))=="y"&&(c=E.toUpperCase()+c.substr(1)),I=j,(A=C).test(c)?c=c.replace(A,"$1$2"):I.test(c)&&(c=c.replace(I,"$1$2")),I=R,(A=$).test(c)){var D=A.exec(c);(A=m).test(D[1])&&(c=c.replace(A=B,""))}else I.test(c)&&(D=I.exec(c),(I=x).test(p=D[1])&&(T=F,X=N,(I=G).test(c=p)?c+="e":T.test(c)?c=c.replace(A=B,""):X.test(c)&&(c+="e")));return(A=J).test(c)&&(c=(p=(D=A.exec(c))[1])+"i"),(A=ce).test(c)&&(_=(D=A.exec(c))[2],(A=m).test(p=D[1])&&(c=p+s[_])),(A=be).test(c)&&(_=(D=A.exec(c))[2],(A=m).test(p=D[1])&&(c=p+i[_])),I=le,(A=te).test(c)?(D=A.exec(c),(A=d).test(p=D[1])&&(c=p)):I.test(c)&&(D=I.exec(c),(I=d).test(p=D[1]+D[2])&&(c=p)),(A=ue).test(c)&&(D=A.exec(c),I=y,T=de,((A=d).test(p=D[1])||I.test(p)&&!T.test(p))&&(c=p)),I=d,(A=ge).test(c)&&I.test(c)&&(c=c.replace(A=B,"")),E=="y"&&(c=E.toLowerCase()+c.substr(1)),c}),w.Pipeline.registerFunction(w.stemmer,"stemmer"),w.generateStopWordFilter=function(c){var p=c.reduce(function(_,E){return _[E]=E,_},{});return function(_){if(_&&p[_]!==_)return _}},w.stopWordFilter=w.generateStopWordFilter(["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"]),w.Pipeline.registerFunction(w.stopWordFilter,"stopWordFilter"),w.trimmer=function(c){return c.replace(/^\W+/,"").replace(/\W+$/,"")},w.Pipeline.registerFunction(w.trimmer,"trimmer"),w.TokenStore=function(){this.root={docs:{}},this.length=0},w.TokenStore.load=function(c){var p=new this;return p.root=c.root,p.length=c.length,p},w.TokenStore.prototype.add=function(c,p,_){_=_||this.root;var E=c.charAt(0),A=c.slice(1);return E in _||(_[E]={docs:{}}),A.length===0?(_[E].docs[p.ref]=p,void(this.length+=1)):this.add(A,p,_[E])},w.TokenStore.prototype.has=function(c){if(!c)return!1;for(var p=this.root,_=0;_<c.length;_++){if(!p[c.charAt(_)])return!1;p=p[c.charAt(_)]}return!0},w.TokenStore.prototype.getNode=function(c){if(!c)return{};for(var p=this.root,_=0;_<c.length;_++){if(!p[c.charAt(_)])return{};p=p[c.charAt(_)]}return p},w.TokenStore.prototype.get=function(c,p){return this.getNode(c,p).docs||{}},w.TokenStore.prototype.count=function(c,p){return Object.keys(this.get(c,p)).length},w.TokenStore.prototype.remove=function(c,p){if(c){for(var _=this.root,E=0;E<c.length;E++){if(!(c.charAt(E)in _))return;_=_[c.charAt(E)]}delete _.docs[p]}},w.TokenStore.prototype.expand=function(c,p){var _=this.getNode(c);return p=p||[],Object.keys(_.docs||{}).length&&p.push(c),Object.keys(_).forEach(function(E){E!=="docs"&&p.concat(this.expand(c+E,p))},this),p},w.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}},t.exports=w})()}(e),e.exports}();class un{constructor(e,t){this.store=new Map,this.idx=pt(function(){this.field("name",{boost:10}),((t==null?void 0:t.searchableFields)||[]).forEach(s=>this.field(s)),this.ref("_id"),t!=null&&t.isExactSearch&&(this.pipeline.remove(pt.stemmer),this.pipeline.remove(pt.stopWordFilter)),t!=null&&t.removeStopWordFilter&&this.pipeline.remove(pt.stopWordFilter)});let n=1;(e||[]).map(s=>{s._id=n,++n,this.idx.add(s),this.store.set(s._id,s)})}search_full(e,t){return this.search(e,t).map(n=>this.store.get(n))}search(e,t){return t instanceof Function?(e?this.idx.search(e).map(n=>this.store.get(n.ref)):[...this.store.values()]).filter(t).map(n=>n._id):e?this.idx.search(e).map(n=>n.ref):[...this.store.keys()]}}class dn{constructor(e,t){(t=t||Object.create(null)).aggregations=t.aggregations||Object.create(null),this._items=e,this.config=t.aggregations,this.facets=function(o,a){a=a||[];const l={data:Object.create(null),bits_data:Object.create(null),bits_data_temp:Object.create(null)};let u=1;return a.forEach(f=>{l.data[f]=Object.create(null)}),o&&o.map(f=>(f._id||(f._id=u,++u),f)),o&&o.map(f=>(a.forEach(v=>{if(f){if(Array.isArray(f[v]))f[v].forEach(m=>{f[v]&&(l.data[v][m]||(l.data[v][m]=[]),l.data[v][m].push(parseInt(f._id)))});else if(f[v]!==void 0){const m=f[v];l.data[v][m]||(l.data[v][m]=[]),l.data[v][m].push(parseInt(f._id))}}}),f)),l.data=z(l.data,function(f,v){return l.bits_data[v]||(l.bits_data[v]=Object.create(null),l.bits_data_temp[v]=Object.create(null)),z(f,function(m,d){const y=_o(m);return l.bits_data[v][d]=new ae(y),y})}),l}(e,it(t.aggregations)),this._items_map=Object.create(null),this._ids=[];let n=1;var s,i;i=o=>{this._ids.push(n),this._items_map[n]=o,o._id=n,++n},(ie(s=e)?Ve:zn)(s,Te(i)),this.ids_map=Object.create(null),e&&e.forEach(o=>{const a=t.custom_id_field||"id";o[a]&&o._id&&(this.ids_map[o[a]]=o._id)}),this._bits_ids=new ae(this._ids)}items(){return this._items}bits_ids(e){return e?new ae(e):this._bits_ids}internal_ids_from_ids_map(e){return e.map(t=>this.ids_map[t])}index(){return this.facets}get_item(e){return this._items_map[e]}search(e,t){const n=this.config;t=t||Object.create(null);const s=Ht(this.facets);let i;s.not_ids=ln(s.bits_data,e.not_filters);const o=function(a,l){const u=[];return z(a.filters,function(f,v){if(f&&f.length)if(l[v].conjunction!==!1)z(f,function(m){u.push([v,m])});else{const m=[];z(f,function(d){m.push([v,d])}),u.push(m)}}),z(a.not_filters,function(f,v){f&&f.length&&z(f,function(m){u.push([v,"-",m])})}),u}(e,n);return i=function(a,l){const u=Ht(a);let f;l=l||[],z(u.bits_data,function(m,d){z(u.bits_data[d],function(y,x){u.bits_data_temp[d][x]=u.bits_data[d][x]})}),u.is_temp_copied=!0;const v=function(m,d){const y=Object.create(null);return z(d,function(x){if(Array.isArray(x[0])){let C=new ae([]);z(x,function(j){const $=j[0];C=C.new_union(m.bits_data[$][j[1]]||new ae([])),y[$]=C})}}),y}(a,l);return z(l,function(m){if(!Array.isArray(m[0])){const d=m[0],y=m[1];f=f&&u.bits_data_temp[d][y]?u.bits_data_temp[d][y].new_intersection(f):f&&!u.bits_data_temp[d][y]?new ae([]):u.bits_data_temp[d][y]}}),f&&z(u.bits_data_temp,function(m,d){z(u.bits_data_temp[d],function(y,x){u.bits_data_temp[d][x]=u.bits_data_temp[d][x].new_intersection(f)})}),z(l,function(m){if(m.length===3&&m[1]==="-"){const d=u.bits_data_temp[m[0]][m[2]].clone();z(u.bits_data_temp,function(y,x){z(u.bits_data_temp[x],function(C,j){u.bits_data_temp[x][j]=u.bits_data_temp[x][j].new_difference(d)})})}}),z(u.bits_data_temp,function(m,d){z(u.bits_data_temp[d],function(y,x){z(v,function(C,j){j!==d&&(u.bits_data_temp[d][x]=u.bits_data_temp[d][x].new_intersection(C))})})}),u}(this.facets,o),e.filters_query&&(i=function(a,l){const u=Ht(a);u.is_temp_copied||z(u.bits_data,function(v,m){z(u.bits_data[m],function(d,y){u.bits_data_temp[m][y]=u.bits_data[m][y]})});let f=null;return z(l,function(v){let m=null;z(v,function(d){const y=d[0],x=d[1];if(!u.bits_data_temp[y])throw new Error("Panic. The key does not exist in facets lists.");m=m&&u.bits_data_temp[y][x]?u.bits_data_temp[y][x].new_intersection(m):m&&!u.bits_data_temp[y][x]?new ae([]):u.bits_data_temp[y][x]}),f=(f||new ae([])).new_union(m||new ae([]))}),f!==null&&z(u.bits_data_temp,function(v,m){z(u.bits_data_temp[m],function(d,y){u.bits_data_temp[m][y]=u.bits_data_temp[m][y].new_intersection(f)})}),u}(i,Eo(e.filters_query).map(a=>Array.isArray(a)?a.map(l=>Array.isArray(l)?l.map(u=>u):l.split(":")):a.split(":")))),s.bits_data_temp=i.bits_data_temp,z(s.bits_data_temp,function(a,l){z(s.bits_data_temp[l],function(u,f){t.query_ids&&(s.bits_data_temp[l][f]=t.query_ids.new_intersection(s.bits_data_temp[l][f])),t.test&&(s.data[l][f]=s.bits_data_temp[l][f].array())})}),s.ids=e.filters_query?function(a){let l=new ae([]);return z(a,function(u,f){z(a[f],function(v,m){l=l.new_union(a[f][m])})}),l}(s.bits_data_temp):ln(s.bits_data_temp,e.filters),s}}function Mo(r,e){let t;(e=e||Object.create(null)).native_search_enabled!==!1&&(t=new un(r,e));let n=new dn(r,e);return{search:function(s){return(s=s||Object.create(null)).aggregations=function(i,o){return z(an(i),(a,l)=>{a.field||(a.field=l);let u=[];o.filters&&o.filters[l]&&(u=o.filters[l]),a.filters=u;let f=[];return o.not_filters&&o.not_filters[l]&&(f=o.not_filters[l]),o.exclude_filters&&o.exclude_filters[l]&&(f=o.exclude_filters[l]),a.not_filters=f,a})}(e.aggregations,s),cn(0,s,e,t,n)},similar:function(s,i){return function(o,a,l){const u=l.per_page||10,f=l.minimum||0,v=l.page||1;let m;for(let x=0;x<o.length;++x)if(o[x].id==a){m=o[x];break}if(!l.field)throw new Error("Please define field in options");const d=l.field;let y=[];for(let x=0;x<o.length;++x)if(o[x].id!==a){const C=vo(m[d],o[x][d]);C.length>=f&&(y.push(o[x]),y[y.length-1].intersection_length=C.length)}return y=dr(y,["intersection_length"],["desc"]),{pagination:{per_page:u,page:v,total:y.length},data:{items:y.slice((v-1)*u,v*u)}}}(r,s,i)},aggregation:function(s){return function(i,o,a,l,u){const f=o.per_page||10,v=o.page||1;if(o.name&&(!a.aggregations||!a.aggregations[o.name]))throw new Error('Please define aggregation "'.concat(o.name,'" in config'));const m=an(o);if(m.page=1,m.per_page=0,!o.name)throw new Error("field name is required");a.aggregations[o.name].size=1e4;const d=cn(0,m,a,l,u).data.aggregations[o.name].buckets;return{pagination:{per_page:f,page:v,total:d.length},data:{buckets:d.slice((v-1)*f,v*f)}}}(0,s,e,t,n)},reindex:function(s){t=new un(r=s,e),n=new dn(r,e)}}}class Ao{constructor(e){this.config=e,this.state={query:"",filters:{},sort:"",bounds:null},this.state.sort=this.config.searchConfig.defaultSort,this.state.filters=this.createEmptyFilters()}createEmptyFilters(){const e={};for(const[t]of Object.entries(this.config.aggregations))e[t]=[];return e}hasActiveFilters(){if(!this.state.filters)return!1;for(const[e,t]of Object.entries(this.state.filters))if(Array.isArray(t)&&t.length>0||!Array.isArray(t)&&t)return!0;return!1}updateFilters(e,t,n){var s;console.log(`Updating filter: ${e}, value: ${t}, checked: ${n}`),n?(this.state.filters[e]||(this.state.filters[e]=[]),this.state.filters[e].includes(t)||this.state.filters[e].push(t)):this.state.filters[e]=((s=this.state.filters[e])==null?void 0:s.filter(i=>i!==t))||[]}async handleStateChange(e,t){console.log("handleStateChange called with action:",e);try{switch(e.type){case"FACET_CHANGE":this.updateFilters(e.facetType,e.value,e.checked);break;case"RANGE_CHANGE":this.state.filters[e.facetKey]=e.value;break;case"QUERY_CHANGE":this.state.query=e.query;break;case"SORT_CHANGE":this.state.sort=e.sort;break}console.log("State updated, triggering search. New state:",this.state),t&&t.onStateChange&&await t.onStateChange(this.state)}catch(n){console.error("Error in handleStateChange:",n)}}getState(){return this.state}setState(e){this.state={...this.state,...e}}}class Io{static debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}static parseCoordinates(e){if(!e||typeof e!="string")return{lat:null,lng:null};const t=e.split(",");return t.length===2?{lat:parseFloat(t[0].trim()),lng:parseFloat(t[1].trim())}:{lat:null,lng:null}}static encodeForAttribute(e){return encodeURIComponent(e||"")}static createUniqueId(e="element"){return`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static isEmpty(e){return e==null?!0:typeof e=="string"?e.trim()==="":Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1}}class Lo{constructor(e,t){this.searchHandler=e,this.config=t,this.isLoading=!1,this.debouncedSearch=Io.debounce(async(n,s)=>{await this.performSearch(n,s)},300)}async performSearch(e,t){var n,s;try{const i=this.searchHandler.performSearch(e,{onMarkersUpdate:t.onMarkersUpdate,onResultsUpdate:t.onResultsUpdate,onAggregationsUpdate:t.onAggregationsUpdate}),o=this.calculateUniqueResultsCount(i.items);return t.onNavBarUpdate&&t.onNavBarUpdate(((n=i.items)==null?void 0:n.length)||0,{uniqueResultsCount:o}),console.log("Search completed:",((s=i.items)==null?void 0:s.length)||0,"items found"),i}catch(i){console.error("Search error:",i),t.onError&&t.onError("Search failed","error")}}calculateUniqueResultsCount(e){if(!e||!Array.isArray(e))return 0;const t=new Set;return e.forEach(n=>{var i,o,a,l,u,f;const s=n.pivot_ID||n.pivotID||n.pivot_id||((i=n._source)==null?void 0:i.pivot_ID)||((o=n._source)==null?void 0:o.pivotID)||((a=n._source)==null?void 0:a.pivot_id)||((l=n.source)==null?void 0:l.pivot_ID)||((u=n.source)==null?void 0:u.pivotID)||((f=n.source)==null?void 0:f.pivot_id);s!=null&&s!==""&&t.add(s)}),t.size}getLoadingStatus(){return{isLoading:this.isLoading}}}class jo{constructor(){this.fullScreenLoader=null}showFullScreenLoader(){this.fullScreenLoader||(this.fullScreenLoader=document.createElement("div"),this.fullScreenLoader.className="fixed inset-0 z-[9999] bg-white flex items-center justify-center",this.fullScreenLoader.innerHTML=`
        <div class="text-center">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary-500 mx-auto mb-4"></div>
          <h2 class="text-xl font-semibold text-gray-700 mb-2">Loading LEDA Search</h2>
          <p class="text-gray-500">Initializing map, data, and components...</p>
        </div>
      `,document.body.appendChild(this.fullScreenLoader)),this.fullScreenLoader.style.display="flex"}hideFullScreenLoader(){this.fullScreenLoader&&(this.fullScreenLoader.style.opacity="0",this.fullScreenLoader.style.transition="opacity 0.3s ease-out",setTimeout(()=>{this.fullScreenLoader&&(this.fullScreenLoader.style.display="none")},300))}showNotification(e,t="info"){const n=document.createElement("div");n.className=`fixed top-4 right-4 z-50 p-3 rounded-lg shadow-lg max-w-sm text-white transition-all duration-300 ${t==="error"?"bg-red-500":t==="warning"?"bg-yellow-500":"bg-blue-500"}`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},3e3)}showFilterNotification(e,t){const n=document.createElement("div");n.className="fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300",n.style.transform="translateX(100%)",n.innerHTML=`
      <div class="flex items-center space-x-3">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
        </svg>
        <span>Filtro applicato: <strong>${e}</strong> = "${t}"</span>
        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    `,document.body.appendChild(n),setTimeout(()=>{n.style.transform="translateX(0)"},100),setTimeout(()=>{n.style.transform="translateX(100%)",setTimeout(()=>{n.parentElement&&n.parentElement.removeChild(n)},300)},5e3)}}class Fo{constructor(e,t){this.stateManager=e,this.config=t}applyUrlFilters(e){const t=new URLSearchParams(window.location.search),n=t.get("filter"),s=t.get("value");if(console.log("Checking URL parameters:",{filterKey:n,filterValue:s}),n&&s)if(console.log(`Applying URL filter: ${n} = ${s}`),this.config.aggregations&&this.config.aggregations[n]){const i=this.config.aggregations[n];let o=s;if(i.type==="range"){const l=s.includes("-")?s.split("-").map(u=>parseInt(u.trim(),10)):s.split(",").map(u=>parseInt(u.trim(),10));if(l.length===2&&!isNaN(l[0])&&!isNaN(l[1]))o=l;else{console.error(`Invalid range format: ${s}`);return}}const a=this.stateManager.getState();i.type==="range"?a.filters[n]=o:(a.filters[n]||(a.filters[n]=[]),a.filters[n].includes(o)||a.filters[n].push(o)),this.stateManager.setState(a),console.log("State filters after URL application:",a.filters),setTimeout(async()=>{e.onApplyFilters&&await e.onApplyFilters(),console.log(`Filter applied and search completed: ${n} = ${s}`),e.onShowNotification&&e.onShowNotification(n,s)},1500)}else console.warn(`Filter key '${n}' not found in configuration`),e.onError&&e.onError(`Filtro '${n}' non trovato`,"warning")}clearAllFilters(){const e=this.stateManager.getState();e.query="",e.filters=this.stateManager.createEmptyFilters(),this.stateManager.setState(e);const t=document.getElementById("search-input");t&&(t.value="")}removeFilter(e,t){const n=this.stateManager.getState();n.filters[e]&&(t?n.filters[e]=n.filters[e].filter(s=>s!==t):n.filters[e]=[],this.stateManager.setState(n))}clearSearchQuery(){const e=this.stateManager.getState();e.query="",this.stateManager.setState(e);const t=document.getElementById("search-input");t&&(t.value="")}}class Oo{constructor(e,t,n){this.stateManager=e,this.config=t,this.callbacks=n}bindEvents(){this.setupSearchInput(),this.setupSortSelect()}bindNavBarEvents(e){e.addEventListener("clearAllFilters",()=>{this.callbacks.onClearAllFilters&&this.callbacks.onClearAllFilters()}),e.addEventListener("removeFilter",t=>{const{facetKey:n,value:s}=t.detail;this.callbacks.onRemoveFilter&&this.callbacks.onRemoveFilter(n,s)}),e.addEventListener("clearSearchQuery",()=>{this.callbacks.onClearSearchQuery&&this.callbacks.onClearSearchQuery()})}setupSearchInput(){const e=document.getElementById("search-input");e&&e.addEventListener("input",()=>{const t=this.stateManager.getState();t.query=e.value,this.stateManager.setState(t),this.callbacks.onSearch&&this.callbacks.onSearch()})}setupSortSelect(){const e=document.getElementById("sort-select");e&&this.config.searchConfig.sortOptions&&(e.innerHTML=this.config.searchConfig.sortOptions.map(t=>`<option value="${t.value}">${t.label}</option>`).join(""),e.addEventListener("change",t=>{const n=this.stateManager.getState();n.sort=t.target.value,this.stateManager.setState(n),this.callbacks.onSortChange&&this.callbacks.onSortChange()}))}}class No{constructor(){this.activeFiltersCount=0,this.resultsCount=0,this.uniqueResultsCount=0,this.isFiltersOpen=!0,this.isResultsOpen=!0,this.listeners=new Map}update(e){const t={};Object.entries(e).forEach(([n,s])=>{this[n]!==s&&(t[n]={old:this[n],new:s},this[n]=s)}),Object.keys(t).length>0&&this.notify(t)}subscribe(e){const t=Math.random().toString(36);return this.listeners.set(t,e),()=>this.listeners.delete(t)}notify(e){this.listeners.forEach(t=>t(e))}}const Ue={MOBILE_BREAKPOINT:768,DEBOUNCE_DELAY:150,HAMBURGER_ID:"hamburger-btn",MOBILE_MENU_ID:"bottom-nav-mobile-menu"},$o=["toggle-filters","active-filters-badge","clear-all-btn","map-layer-selector","map-markers-selector","toggle-legend-btn","results-counter","unique-results-counter","toggle-results"];class Po{constructor(e){this.elements=e,this.isOpen=!1,this.hamburgerBtn=null,this.mobileMenu=null,this.resizeHandler=null,this.clickHandler=null,this.init()}init(){this.createUI(),this.setupEventHandlers(),this.handleResize()}setupEventHandlers(){this.resizeHandler=this.debounce(()=>this.handleResize(),Ue.DEBOUNCE_DELAY),window.addEventListener("resize",this.resizeHandler)}createUI(){this.createHamburgerButton(),this.createMobileMenu()}createHamburgerButton(){const e=document.getElementById(Ue.HAMBURGER_ID);if(e){this.hamburgerBtn=e;return}this.hamburgerBtn=document.createElement("button"),this.hamburgerBtn.id=Ue.HAMBURGER_ID,this.hamburgerBtn.className="md:hidden p-2 z-60 text-gray-700 hover:text-gray-900",this.hamburgerBtn.setAttribute("aria-label","Apri menu"),this.hamburgerBtn.setAttribute("aria-expanded","false"),this.hamburgerBtn.innerHTML=`
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="5" y1="7" x2="19" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line x1="5" y1="17" x2="19" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        `,this.clickHandler=()=>this.toggleMenu(),this.hamburgerBtn.addEventListener("click",this.clickHandler),(this.elements.bottomNav||document.querySelector("nav")||document.body).appendChild(this.hamburgerBtn)}createMobileMenu(){const e=document.getElementById(Ue.MOBILE_MENU_ID);if(e){this.mobileMenu=e;return}this.mobileMenu=document.createElement("div"),this.mobileMenu.id=Ue.MOBILE_MENU_ID,this.mobileMenu.className="md:hidden fixed bottom-14 left-4 right-4 bg-white shadow-lg p-3 rounded-lg flex-col gap-2 z-50",this.mobileMenu.setAttribute("data-open","false"),document.body.appendChild(this.mobileMenu)}toggleMenu(){this.isOpen=!this.isOpen,this.mobileMenu&&this.mobileMenu.setAttribute("data-open",this.isOpen?"true":"false"),this.hamburgerBtn&&this.hamburgerBtn.setAttribute("aria-expanded",this.isOpen?"true":"false")}handleResize(){window.innerWidth<Ue.MOBILE_BREAKPOINT?this.switchToMobile():this.switchToDesktop()}switchToMobile(){const e=this.elements.bottomNavContent;e&&(e.classList.remove("flex"),e.classList.add("hidden")),$o.forEach(t=>{const n=document.getElementById(t);n&&this.mobileMenu&&n.parentNode!==this.mobileMenu&&(n.classList.add("w-full","block"),this.mobileMenu.appendChild(n))}),this.closeMenu(),this.closePanels()}switchToDesktop(){const e=this.elements.bottomNavContent;e&&(e.classList.remove("hidden"),e.classList.add("flex")),this.mobileMenu&&Array.from(this.mobileMenu.childNodes).forEach(n=>{n instanceof HTMLElement&&e&&(n.classList.remove("w-full","block"),e.appendChild(n))}),this.closeMenu()}closeMenu(){this.isOpen=!1,this.mobileMenu&&this.mobileMenu.setAttribute("data-open","false"),this.hamburgerBtn&&this.hamburgerBtn.setAttribute("aria-expanded","false")}closePanels(){this.elements.filtersPanel&&this.elements.filtersPanel.setAttribute("data-open","false"),this.elements.resultsPanel&&this.elements.resultsPanel.setAttribute("data-open","false"),this.elements.toggleFilters&&this.elements.toggleFilters.setAttribute("data-active","false"),this.elements.toggleResults&&this.elements.toggleResults.setAttribute("data-active","false")}debounce(e,t){let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,s),t)}}destroy(){this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.clickHandler&&this.hamburgerBtn&&this.hamburgerBtn.removeEventListener("click",this.clickHandler),this.hamburgerBtn&&this.hamburgerBtn.parentNode&&this.hamburgerBtn.remove(),this.mobileMenu&&this.mobileMenu.parentNode&&this.mobileMenu.remove(),this.hamburgerBtn=null,this.mobileMenu=null,this.resizeHandler=null,this.clickHandler=null}}const er={showElement(r){r&&(r.classList.remove("hidden"),r.style.opacity="1")},hideElement(r){r&&(r.classList.add("hidden"),r.style.opacity="0")},escapeHtml(r){const e=document.createElement("div");return e.textContent=r,e.innerHTML},waitForGlobal(r,e,t=1e4){if(window[r]){e(window[r]);return}const n=Date.now(),s=setInterval(()=>{window[r]?(clearInterval(s),e(window[r])):Date.now()-n>t&&(clearInterval(s),console.warn(`Timeout waiting for ${r}`))},100)}},Bo={positionPopup(r,e,t={}){const{offset:n=10,maxWidth:s=288,placement:i="above"}=t,o=e.getBoundingClientRect();r.style.left=`${o.left}px`,i==="above"?r.style.bottom=`${window.innerHeight-o.top+n}px`:r.style.top=`${o.bottom+n}px`,o.left+s>window.innerWidth&&(r.style.left=`${window.innerWidth-s-16}px`)}},Ro={calculateActiveFiltersCount(r){if(!r||typeof r!="object")return 0;let e=0;for(const t of Object.values(r))Array.isArray(t)?t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number"?e+=1:e+=t.length:t&&typeof t=="object"&&(t.min!==void 0||t.max!==void 0)&&(e+=1);return e},formatRangeFilter(r){return r.min!==void 0&&r.max!==void 0?`${r.min} - ${r.max}`:r.min!==void 0?` ${r.min}`:r.max!==void 0?` ${r.max}`:"Range filter"},getFacetLabel(r,e){var t,n;return(n=(t=e==null?void 0:e.aggregations)==null?void 0:t[r])!=null&&n.title?e.aggregations[r].title:r.replace(/[_-]/g," ").replace(/\b\w/g,s=>s.toUpperCase())}},hn={getNotificationClasses(r){const e={success:"bg-green-500 text-white",error:"bg-red-500 text-white",warning:"bg-yellow-500 text-white",info:"bg-primary-500 text-white"};return e[r]||e.info},show(r,e="info",t=3e3){const n=document.createElement("div");n.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg ${this.getNotificationClasses(e)} transition-opacity duration-300`,n.textContent=r,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},t)}},gt={resetFacetsInterface(){const r=document.getElementById("facets-container");r&&(r.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=!1}),r.querySelectorAll('[id$="-slider"]').forEach(e=>{if(e.noUiSlider)try{const t=e.noUiSlider.options.range;e.noUiSlider.set([t.min,t.max]);const n=e.id.replace("-slider",""),s=document.getElementById(`${n}-min-input`),i=document.getElementById(`${n}-max-input`);s&&(s.value=t.min),i&&(i.value=t.max)}catch(t){console.warn(`Failed to reset slider ${e.id}:`,t)}}),r.querySelectorAll(".toggle-btn").forEach(e=>{const t=e.dataset.path,n=r.querySelector(`[data-parent="${t}"]`);n&&n.style.display!=="none"&&(n.style.display="none",e.textContent="")}))},clearSearchInput(){const r=["#search-input","#query-input",".search-input",'input[type="search"]','input[placeholder*="search" i]','input[placeholder*="cerca" i]'];for(const e of r){const t=document.querySelector(e);if(t){t.value="",t.dispatchEvent(new Event("input",{bubbles:!0}));return}}}};class Vn{constructor(e){this.config=e||{},console.log(e)}render(e){if(!e||!e.filters)return"";const t=[];return e.query&&e.query.trim()&&t.push(`
        <div class="inline-flex items-center gap-2 px-3 py-1 bg-secondary-100 text-secondary-800 rounded-full text-sm font-medium">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span>Ricerca: "${er.escapeHtml(e.query)}"</span>
        </div>
      `),Object.entries(e.filters).forEach(([n,s])=>{var l,u;if(!s)return;const i=(u=(l=this.config)==null?void 0:l.aggregations)==null?void 0:u[n],o=(i==null?void 0:i.title)||n,a=(i==null?void 0:i.type)||"value";if(Array.isArray(s))s.forEach(f=>{t.push(this._buildBadge(o,f,a))});else if(typeof s=="object"){const f=this._formatRangeFilter(s);t.push(this._buildBadge(o,f,"range"))}}),t.length?`<div class="flex flex-wrap gap-2">${t.join("")}</div>`:""}_buildBadge(e,t,n){const s={simple:"bg-blue-100 text-blue-800",taxonomy:"bg-green-100 text-green-800",range:"bg-purple-100 text-purple-800",value:"bg-primary-100 text-primary-800"};return`
      <div class="inline-flex items-center gap-2 px-3 py-1 ${s[n]||s.value} rounded-full text-sm font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
          <path d="M2 3h12v1l-5 5v4l-2 2v-6L2 4z"/>
        </svg>
        <span>${e}: ${er.escapeHtml(t)}</span>
      </div>
    `}_formatRangeFilter(e){return e.min!==void 0&&e.max!==void 0?`${e.min} - ${e.max}`:e.min!==void 0?` ${e.min}`:e.max!==void 0?` ${e.max}`:"Range"}}const Pe={zIndex:"9999",maxHeight:"max-h-96",contentMaxHeight:"max-h-64",defaultWidth:"w-72"},hr={close:`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
    </svg>`,check:`<svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
    </svg>`};class kt{constructor(e,t){this.triggerId=e,this.popupId=t,this.trigger=null,this.isOpen=!1,this.cleanup=null}init(){return this.trigger=document.getElementById(this.triggerId),this.trigger?(this.trigger.style.cursor="pointer",this.trigger.onclick=e=>{e.stopPropagation(),this.toggle()},!0):(console.warn(`Trigger element ${this.triggerId} not found`),!1)}toggle(){this.isOpen?this.hide():this.show()}show(){if(this.isOpen)return;const e=this.createPopup();e&&(document.body.appendChild(e),this.isOpen=!0,this.bindEvents(e))}hide(){var t;const e=document.getElementById(this.popupId);e==null||e.remove(),(t=this.cleanup)==null||t.call(this),this.cleanup=null,this.isOpen=!1}bindEvents(e){const t=s=>{(s.key==="Escape"||s.type==="click"&&!e.contains(s.target)&&!this.trigger.contains(s.target))&&this.hide()};document.addEventListener("keydown",t),document.addEventListener("click",t);const n=e.querySelector(`#close-${this.popupId}`);n==null||n.addEventListener("click",()=>this.hide()),this.cleanup=()=>{document.removeEventListener("keydown",t),document.removeEventListener("click",t)}}createBasePopup(e){const t=document.createElement("div");t.id=this.popupId,t.className=`fixed p-2 ${Pe.defaultWidth} max-w-sm bg-white rounded-lg shadow-2xl border border-gray-200 ${Pe.maxHeight} overflow-hidden`,t.style.zIndex=Pe.zIndex,Bo.positionPopup(t,this.trigger);const n=document.createElement("div");return n.className="flex items-center justify-between mb-2",n.innerHTML=`
            <h3 class="p-2 text-sm font-semibold text-gray-800">${e}</h3>
            <button id="close-${this.popupId}" class="absolute top-2 right-2 p-1.5 bg-pink-100 hover:bg-pink-200 rounded-full text-red-500 shadow-md">
                ${hr.close}
            </button>
        `,t.appendChild(n),t}createPopup(){throw new Error("createPopup must be implemented by subclass")}destroy(){this.hide()}}class zo extends kt{constructor(e){super("active-filters-badge","active-filters-popup"),this.navBar=e}init(){const e=super.init();return e&&this.trigger&&(this.trigger.title="Clicca per vedere i filtri attivi"),e}createPopup(){const e=this.createBasePopup("Filtri Attivi"),t=document.createElement("div");t.className=`space-y-1 ${Pe.contentMaxHeight} overflow-y-auto overflow-x-hidden`;const n=this.getSearchState(),i=new Vn(this.navBar.config).render(n);return!i||i.trim()===""?t.innerHTML='<div class="p-3 text-sm text-gray-500 italic">Nessun filtro applicato</div>':t.innerHTML=i,e.appendChild(t),e}getSearchState(){var e;return(e=window.ledaSearch)!=null&&e.state?window.ledaSearch.state:{query:this.navBar.currentQuery||"",filters:this.navBar.currentFilters||{}}}}class To extends kt{constructor(e){super("toggle-legend-btn","map-legend-popup"),this.navBar=e}init(){const e=super.init();return e&&this.trigger&&(this.trigger.title="Clicca per leggere la legenda"),e}createPopup(){const e=this.createBasePopup("Legenda"),t=document.createElement("div");return t.className=`space-y-4 ${Pe.contentMaxHeight} overflow-y-auto overflow-x-visible mb-3 p-3`,t.appendChild(this.createIntroSection()),t.appendChild(this.createPinSection()),t.appendChild(this.createFiltersSection()),t.appendChild(this.createReferencesSection()),t.appendChild(this.createPopupSection()),e.appendChild(t),e}getElement(e,t=""){const n=document.querySelector(e);if(!n)return document.createTextNode(t);const s=n.cloneNode(!0);return s.querySelectorAll("[id]").forEach(i=>i.removeAttribute("id")),s.hasAttribute("id")&&s.removeAttribute("id"),s}tooltip(e,t,n="top"){const s=document.createElement("span");s.className="relative inline-block group cursor-help";const i=document.createElement("span");i.className="text-blue-600 underline decoration-dotted underline-offset-2 hover:text-blue-800 transition-colors",i.textContent=e,s.appendChild(i);const o={top:"bottom-full left-1/2 -translate-x-1/2 mb-2",bottom:"top-full left-1/2 -translate-x-1/2 mt-2",left:"right-full top-1/2 -translate-y-1/2 mr-2",right:"left-full top-1/2 -translate-y-1/2 ml-2"},a={top:"top-full left-1/2 -translate-x-1/2 border-l-8 border-r-8 border-t-8 border-transparent border-t-gray-900",bottom:"bottom-full left-1/2 -translate-x-1/2 border-l-8 border-r-8 border-b-8 border-transparent border-b-gray-900",left:"left-full top-1/2 -translate-y-1/2 border-t-8 border-b-8 border-l-8 border-transparent border-l-gray-900",right:"right-full top-1/2 -translate-y-1/2 border-t-8 border-b-8 border-r-8 border-transparent border-r-gray-900"},l=document.createElement("div");l.className=`absolute ${o[n]} z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 delay-100`;const u=document.createElement("div");u.className="bg-gray-900 text-white text-sm rounded-lg py-2 px-3 max-w-xs shadow-xl whitespace-normal relative",u.appendChild(t.cloneNode(!0));const f=document.createElement("div");return f.className=`absolute w-0 h-0 ${a[n]}`,u.appendChild(f),l.appendChild(u),s.appendChild(l),s}createIntroSection(){const e=document.createElement("div");return e.className="space-y-2",e.innerHTML=`
            <p class="text-sm font-medium text-gray-800">Legenda della mappa</p>
            <p class="text-xs text-gray-600">Mostra i diversi elementi presenti sulla mappa.</p>
        `,e}createPinSection(){const e=document.createElement("div");e.className="border-t border-gray-200 pt-3 space-y-2";const t=document.createElement("p");return t.className="text-sm text-gray-700 leading-relaxed",t.textContent="I ",t.appendChild(this.tooltip("pin della mappa",this.getElement(".leaflet-marker-icon svg"),"top")),t.appendChild(document.createTextNode(" indicano i luoghi presenti sulla mappa.")),e.appendChild(t),e}createFiltersSection(){const e=document.createElement("div");e.className="border-t border-gray-200 pt-3 space-y-2";const t=document.createElement("p");return t.className="text-sm text-gray-700 leading-relaxed",t.appendChild(document.createTextNode("I ")),t.appendChild(this.tooltip("filtri",this.getElement("#toggle-filters"),"right")),t.appendChild(document.createTextNode(" intervengono sul filtraggio sia dei luoghi sulla mappa sia dei riferimenti ad essi associati. Il numero di occorrenze dei filtri rappresenta il numero di volte in cui ciascun luogo  stato menzionato. ")),e.appendChild(t),e}createReferencesSection(){const e=document.createElement("div");e.className="border-t border-gray-200 pt-3 space-y-2";const t=document.createElement("p");return t.className="text-sm text-gray-700 leading-relaxed",t.appendChild(document.createTextNode("La sezione ")),t.appendChild(this.tooltip("riferimenti",this.getElement("#toggle-results"),"top")),t.appendChild(document.createTextNode(" mostra tutti i riferimenti ai luoghi presenti nella mappa.")),e.appendChild(t),e}createPopupSection(){const e=document.createElement("div");e.className="border-t border-gray-200 pt-3";const t=document.createElement("p");return t.className="text-sm text-gray-700 leading-relaxed",t.appendChild(document.createTextNode("Ogni pin sulla mappa apre un ")),t.appendChild(this.tooltip("popup informativo",this.getElement(".bg-gradient-to-r"),"top")),t.appendChild(document.createTextNode(" con dettagli specifici del luogo.")),e.appendChild(t),e}}class Do extends kt{constructor(e){super("map-layer-selector","layer-selection-popup"),this.layers=e,this.currentLayerName="Default",this.currentTileLayer=null}init(){const e=super.init();return e&&this.trigger&&(this.trigger.title="Clicca per cambiare layer"),e}createPopup(){const e=this.createBasePopup("Seleziona uno strato cartografico"),t=document.createElement("div");return t.className=`space-y-1 ${Pe.contentMaxHeight} overflow-y-auto overflow-x-hidden mb-3 p-3`,t.innerHTML=this.buildLayersHTML(),t.querySelectorAll(".layer-item").forEach(n=>{n.addEventListener("click",()=>{const{layerName:s,layerUrl:i,layerAttribution:o}=n.dataset;this.selectLayer(s,i,o),this.hide()})}),e.appendChild(t),e}buildLayersHTML(){return Object.entries(this.layers).map(([e,t])=>`
            <div class="layer-item flex items-center justify-between p-2 rounded hover:bg-gray-100 cursor-pointer" 
                data-layer-name="${e}" 
                data-layer-url="${t.tileLayer}"
                data-layer-attribution="${t.attribution}">
                <span class="text-sm text-gray-700">${e}</span>
                ${e===this.currentLayerName?hr.check:""}
            </div>
        `).join("")}selectLayer(e,t,n){this.currentTileLayer&&window.map&&window.map.removeLayer(this.currentTileLayer),window.L&&window.map&&(this.currentTileLayer=window.L.tileLayer(t,{attribution:n,maxZoom:18}),this.currentTileLayer.addTo(window.map)),this.currentLayerName=e,document.dispatchEvent(new CustomEvent("layerChanged",{detail:{layerName:e,layerUrl:t,attribution:n}}))}}class Ho extends kt{constructor(e){super("map-markers-selector","markers-selection-popup"),this.mapInstance=e,this.currentMarkerType="clusters",this.markerTypes={clusters:{name:"Clusters geografici",description:"Raggruppamenti dinamici dei luoghi",icon:this.getClusterIcon()},pins:{name:"Pin con numeri",description:"Pin con numero dei riferimenti",icon:this.getPinIcon()},circles:{name:"Cerchi Proporzionali",description:"Cerchi con diametro basato sui riferimenti",icon:this.getCircleIcon()}}}init(){const e=super.init();return e&&this.trigger&&(this.trigger.title="Clicca per cambiare tipo di marcatore"),e}createPopup(){const e=this.createBasePopup("Seleziona un tipo di marcatore"),t=document.createElement("div");return t.className=`space-y-1 ${Pe.contentMaxHeight} overflow-y-auto overflow-x-hidden`,t.innerHTML=this.buildMarkersHTML(),t.querySelectorAll(".marker-item").forEach(n=>{n.addEventListener("click",()=>{this.selectMarkerType(n.dataset.markerType),this.hide()})}),e.appendChild(t),e}buildMarkersHTML(){return Object.entries(this.markerTypes).map(([e,t])=>`
            <div class="marker-item flex items-center justify-between p-2 rounded hover:bg-gray-50 hover:shadow-md cursor-pointer" 
                 data-marker-type="${e}">
                <div class="flex items-center space-x-3">
                    ${t.icon}
                    <div>
                        <span class="text-sm font-medium text-gray-700">${t.name}</span>
                        <p class="text-xs text-gray-500">${t.description}</p>
                    </div>
                </div>
                ${e===this.currentMarkerType?hr.check:""}
            </div>
        `).join("")}selectMarkerType(e){var n;this.currentMarkerType=e;const t=window.switchMarkerType||((n=this.mapInstance)==null?void 0:n.switchMarkerType);t&&(typeof t=="function"?t(e):t.call(this.mapInstance,e)),document.dispatchEvent(new CustomEvent("markerTypeChanged",{detail:{markerType:e,markerName:this.markerTypes[e].name}}))}getClusterIcon(){return`<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 32 32">
            <path d="M27 21.75c-0.795 0.004-1.538 0.229-2.169 0.616l0.018-0.010-2.694-2.449c0.724-1.105 1.154-2.459 1.154-3.913 0-1.572-0.503-3.027-1.358-4.212l0.015 0.021 3.062-3.062c0.57 0.316 1.249 0.503 1.971 0.508h0.002c2.347 0 4.25-1.903 4.25-4.25s-1.903-4.25-4.25-4.25c-2.347 0-4.25 1.903-4.25 4.25v0c0.005 0.724 0.193 1.403 0.519 1.995l-0.011-0.022-3.062 3.062c-1.147-0.84-2.587-1.344-4.144-1.344-0.868 0-1.699 0.157-2.467 0.443l0.049-0.016-0.644-1.17c0.726-0.757 1.173-1.787 1.173-2.921 0-2.332-1.891-4.223-4.223-4.223s-4.223 1.891-4.223 4.223c0 2.332 1.891 4.223 4.223 4.223 0.306 0 0.605-0.033 0.893-0.095l-0.028 0.005 0.642 1.166c-1.685 1.315-2.758 3.345-2.758 5.627 0 0.605 0.076 1.193 0.218 1.754l-0.011-0.049-0.667 0.283c-0.78-0.904-1.927-1.474-3.207-1.474-2.334 0-4.226 1.892-4.226 4.226s1.892 4.226 4.226 4.226c2.334 0 4.226-1.892 4.226-4.226 0-0.008-0-0.017-0-0.025v0.001c-0.008-0.159-0.023-0.307-0.046-0.451l0.003 0.024 0.667-0.283c1.303 2.026 3.547 3.349 6.1 3.349 1.703 0 3.268-0.589 4.503-1.574l-0.015 0.011 2.702 2.455c-0.258 0.526-0.41 1.144-0.414 1.797v0.001c0 2.347 1.903 4.25 4.25 4.25s4.25-1.903 4.25-4.25c0-2.347-1.903-4.25-4.25-4.25v0z"></path>
        </svg>`}getPinIcon(){return`<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
        </svg>`}getCircleIcon(){return`<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd"></path>
        </svg>`}}const fn={filtersPanel:"filters-panel",resultsPanel:"results-panel",toggleFilters:"toggle-filters",toggleResults:"toggle-results",activeFiltersBadge:"active-filters-badge",activeFiltersCount:"active-filters-count",resultsCounter:"results-counter",resultsCount:"results-count",uniqueResultsCounter:"unique-results-counter",uniqueResultsCount:"unique-results-count",clearAllBtn:"clear-all-btn",layerButton:"map-layer-selector",markersButton:"map-markers-selector",bottomNav:"bottom-nav",bottomNavContent:"bottom-nav-content",toggleLegendBtn:"toggle-legend-btn"};class Uo{constructor(){this.state=new No,this.elements={},this.popups={},this.mobileMenu=null,this.cleanupFns=[],this.init()}get config(){var e;return(e=window.ledaSearch)==null?void 0:e.config}get mapInstance(){var e;return(e=window.ledaSearch)==null?void 0:e.mapInstance}get currentFilters(){var t,n,s,i,o;const e=((n=(t=window.ledaSearch)==null?void 0:t.stateManager)==null?void 0:n.state)||((o=(i=(s=window.ledaSearch)==null?void 0:s.filterManager)==null?void 0:i.stateManager)==null?void 0:o.state);return(e==null?void 0:e.filters)||{}}get currentQuery(){var t,n,s,i,o;const e=((n=(t=window.ledaSearch)==null?void 0:t.stateManager)==null?void 0:n.state)||((o=(i=(s=window.ledaSearch)==null?void 0:s.filterManager)==null?void 0:i.stateManager)==null?void 0:o.state);return(e==null?void 0:e.query)||""}init(){try{this.initElements(),this.initState(),this.bindEvents(),this.initPopups(),this.initMobileMenu()}catch(e){console.error("NavBarRenderer: Initialization error",e)}}initElements(){this.elements=Object.fromEntries(Object.entries(fn).map(([e,t])=>[e,document.getElementById(t)]))}initState(){var t,n,s,i,o,a;const e=this.state.subscribe(l=>this.onStateChange(l));this.cleanupFns.push(e),(t=this.elements.filtersPanel)==null||t.setAttribute("data-open","true"),(n=this.elements.resultsPanel)==null||n.setAttribute("data-open","true"),(s=this.elements.toggleFilters)==null||s.setAttribute("data-active","true"),(i=this.elements.toggleResults)==null||i.setAttribute("data-active","true"),this.state.activeFiltersCount===0&&((o=this.elements.activeFiltersBadge)==null||o.classList.add("hidden"),(a=this.elements.clearAllBtn)==null||a.classList.add("hidden"))}onStateChange(e){"activeFiltersCount"in e&&this.updateFiltersUI(e.activeFiltersCount.new),("resultsCount"in e||"uniqueResultsCount"in e)&&this.updateResultsUI(this.state.resultsCount,this.state.uniqueResultsCount),"isFiltersOpen"in e&&this.updatePanelUI("filters",e.isFiltersOpen.new),"isResultsOpen"in e&&this.updatePanelUI("results",e.isResultsOpen.new),this.emitStateChanges(e)}updateFiltersUI(e){var t,n;this.elements.activeFiltersCount&&(this.elements.activeFiltersCount.textContent=e),(t=this.elements.activeFiltersBadge)==null||t.setAttribute("data-visible",e>0),(n=this.elements.clearAllBtn)==null||n.setAttribute("data-visible",e>0)}updateResultsUI(e,t){var s;this.elements.resultsCount&&(this.elements.resultsCount.textContent=e),(s=this.elements.resultsCounter)==null||s.setAttribute("data-visible",e>0);let n=this.elements.uniqueResultsCount;!n&&t>0&&this.elements.resultsCounter&&(n=document.createElement("span"),n.id=fn.uniqueResultsCount,n.className="ml-2 text-xs text-gray-600 bg-blue-100 px-2 py-1 rounded-full",this.elements.resultsCounter.appendChild(n),this.elements.uniqueResultsCount=n),n&&(n.textContent=`${t}`,n.setAttribute("data-visible",t>0))}updatePanelUI(e,t){var s,i;const n=this.getPanelConfig(e);n&&((s=n.panel)==null||s.setAttribute("data-open",t),(i=n.button)==null||i.setAttribute("data-active",t))}emitStateChanges(e){Object.entries(e).forEach(([t,n])=>{const i={activeFiltersCount:"activeFiltersChanged",resultsCount:"resultsCountChanged",isFiltersOpen:"panelToggled",isResultsOpen:"panelToggled"}[t];i&&document.dispatchEvent(new CustomEvent(`navbar:${i}`,{detail:{type:t.replace("is","").replace("Open","").toLowerCase(),...n}}))})}bindEvents(){this.bindElement(this.elements.toggleFilters,()=>this.togglePanel("filters")),this.bindElement(this.elements.toggleResults,()=>this.togglePanel("results")),this.bindElement(this.elements.clearAllBtn,()=>this.clearAllFilters())}bindElement(e,t){e&&(e.addEventListener("click",t),this.cleanupFns.push(()=>e.removeEventListener("click",t)))}initPopups(){er.waitForGlobal("ledaSearch",()=>{var e,t;this.popups.activeFilters=new zo(this),this.popups.activeFilters.init(),(t=(e=this.config)==null?void 0:e.map)!=null&&t.tileLayers&&(this.popups.layers=new Do(this.config.map.tileLayers),this.popups.layers.init()),this.mapInstance&&(this.popups.markers=new Ho(this.mapInstance),this.popups.markers.init(),setTimeout(()=>{this.popups.legend=new To(this),this.popups.legend.init()},5e3))})}initMobileMenu(){this.mobileMenu=new Po(this.elements),this.cleanupFns.push(()=>{var e;return(e=this.mobileMenu)==null?void 0:e.destroy()})}updateFromSearchState(e,t=0,n={}){var i;if(!e)return;let s=Ro.calculateActiveFiltersCount(e.filters);(i=e.query)!=null&&i.trim()&&(s+=1),this.state.update({activeFiltersCount:s,resultsCount:t,uniqueResultsCount:n.uniqueResultsCount||0})}updateFilters(e){this.state.update({activeFiltersCount:e})}updateResults(e,t=0){this.state.update({resultsCount:e,uniqueResultsCount:t})}togglePanel(e){const t=`is${e.charAt(0).toUpperCase()+e.slice(1)}Open`;this.state.update({[t]:!this.state[t]})}getPanelConfig(e){return{filters:{panel:this.elements.filtersPanel,button:this.elements.toggleFilters},results:{panel:this.elements.resultsPanel,button:this.elements.toggleResults}}[e]}closeAllPanels(){this.state.update({isFiltersOpen:!1,isResultsOpen:!1})}clearAllFilters(){Object.values(this.popups).forEach(e=>e==null?void 0:e.hide()),this.state.update({activeFiltersCount:0,resultsCount:0,uniqueResultsCount:0}),document.dispatchEvent(new CustomEvent("navbar:clearAllFilters",{detail:{resetInterface:!0,clearSearch:!0,clearFacets:!0,clearMap:!0}})),setTimeout(()=>{gt.resetFacetsInterface(),gt.clearSearchInput()},100),hn.show("Tutti i filtri sono stati rimossi","success",2e3)}getState(){return{...this.state.getSnapshot(),currentFilters:this.currentFilters,currentQuery:this.currentQuery,config:this.config,mapInstance:this.mapInstance}}setState(e){const t={};Object.entries(e).forEach(([n,s])=>{this.state.hasOwnProperty(n)?t[n]=s:["currentFilters","currentQuery","config","mapInstance"].includes(n)&&console.warn(`NavBarRenderer: ${n}  read-only`)}),Object.keys(t).length>0&&this.state.update(t)}addEventListener(e,t){document.addEventListener(`navbar:${e}`,t)}removeEventListener(e,t){document.removeEventListener(`navbar:${e}`,t)}showNotification(e,t="info",n=3e3){hn.show(e,t,n)}resetInterface(){this.state.reset(),Object.values(this.popups).forEach(e=>e==null?void 0:e.hide()),gt.resetFacetsInterface(),gt.clearSearchInput()}destroy(){this.cleanupFns.forEach(e=>e()),Object.values(this.popups).forEach(e=>e==null?void 0:e.destroy()),this.cleanupFns=[],this.elements={},this.popups={},this.mobileMenu=null}}const Vo=new Uo;class qn{constructor(){this.originalFacetData=null}renderTaxonomy(e,t,n,s){const o=(s.filters||{})[n]||[];this.originalFacetData||(this.originalFacetData=JSON.parse(JSON.stringify(t)));const a=o.length>0?this.originalFacetData:t,l=this._buildHierarchy(a);this._calculateTotalCounts(l),e.className="taxonomy-container max-w-full overflow-x-auto max-h-80 overflow-y-auto",e.innerHTML=this._createTaxonomyHTML(l,[],0,n,o),this._setCheckboxStates(e,l,o),this._addEventListeners(e,l,n)}resetOriginalData(){this.originalFacetData=null}_buildHierarchy(e){const t={};return Array.isArray(e)&&e.forEach(n=>{const s=n.key.split(" > ");let i=t;s.forEach((o,a)=>{i[o]||(i[o]={children:{},docCount:0,selfCount:0}),a===s.length-1&&(i[o].selfCount=n.doc_count),i=i[o].children})}),t}_calculateTotalCounts(e){const t=n=>{let s=n.selfCount||0;return Object.values(n.children||{}).forEach(i=>{s+=t(i)}),n.docCount=s,s};Object.values(e).forEach(t)}_setCheckboxStates(e,t,n){const s=(i,o=[])=>{Object.entries(i).forEach(([a,l])=>{if(this._isMetadataKey(a))return;const u=[...o,a].join(" > "),f=e.querySelector(`input[value="${u}"]`);if(!f)return;f.checked=n.includes(u);const m=this._getAllChildPaths(l.children||{},[...o,a]).some(d=>n.includes(d));f.indeterminate=m&&!f.checked,s(l.children,[...o,a])})};s(t)}_createTaxonomyHTML(e,t=[],n=0,s,i){let o='<div class="space-y-1">';return Object.entries(e).forEach(([a,l])=>{if(this._isMetadataKey(a))return;const u=[...t,a],f=u.join(" > "),v=Object.keys(l.children).length>0,m=i.includes(f),d=v&&this._hasSelectedChild(l.children,i,u),y=m||d,x=l.docCount===0;o+=`
        <div class="taxonomy-item">
          <label class="block facet-option ${x?"text-gray-400 cursor-not-allowed opacity-50":"cursor-pointer"}" data-search-text="${a.toLowerCase()}">
            <div></div>
            ${this._createToggleButton(v,f,y)}
            <div class="flex items-center gap-2 min-w-0">
              <input type="checkbox" value="${f}" data-facet-type="${s}" class="form-checkbox flex-shrink-0" ${m?"checked":""} ${x?"disabled":""}>
              <span class="text-sm">${a}</span>
            </div>
            <span class="text-xs px-2 py-0.5 rounded-full flex-shrink-0 ${x?"text-gray-400 bg-gray-100":"text-secondary-500 bg-secondary-100"}">${l.docCount}</span>
          </label>
          ${this._createChildrenContainer(v,f,y,l.children,u,n+1,s,i)}
        </div>`}),o+"</div>"}_createToggleButton(e,t,n){return e?`<button class="toggle-btn flex-shrink-0 w-5 h-5 flex items-center justify-center rounded hover:bg-gray-200 transition-colors" data-path="${t}">
        <svg class="w-3 h-3 text-gray-600 transform transition-transform duration-200 ${n?"rotate-90":""}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>`:'<div class="w-5 h-5 flex-shrink-0"></div>'}_createChildrenContainer(e,t,n,s,i,o,a,l){return e?`<div class="children ${n?"":"hidden"}" data-parent="${t}">
        ${this._createTaxonomyHTML(s,i,o,a,l)}
      </div>`:""}_isMetadataKey(e){return["children","docCount","selfCount"].includes(e)}_hasSelectedChild(e,t,n=[]){for(const[s,i]of Object.entries(e)){if(this._isMetadataKey(s))continue;const o=[...n,s].join(" > ");if(t.includes(o)||Object.keys(i.children).length>0&&this._hasSelectedChild(i.children,t,[...n,s]))return!0}return!1}_getParentPaths(e){const t=e.split(" > "),n=[];for(let s=1;s<t.length;s++)n.push(t.slice(0,s).join(" > "));return n}_getAllChildPaths(e,t=[]){const n=[];return Object.entries(e).forEach(([s,i])=>{if(this._isMetadataKey(s))return;const o=[...t,s].join(" > ");n.push(o),Object.keys(i.children).length>0&&n.push(...this._getAllChildPaths(i.children,[...t,s]))}),n}_getChildPathsForNode(e,t){const n=t.split(" > ");let s=e;for(const i of n)if(s[i])s=s[i];else return[];return this._getAllChildPaths(s.children,n)}_addEventListeners(e,t,n){e._hierarchy=t,this._addToggleListeners(e),this._addCheckboxListeners(e,t,n)}_addToggleListeners(e){e.addEventListener("click",t=>{const n=t.target.closest(".toggle-btn");if(!n)return;const s=n.dataset.path,i=e.querySelector(`[data-parent="${s}"]`),o=n.querySelector("svg");if(i&&o){const a=i.classList.contains("hidden");i.classList.toggle("hidden"),o.classList.toggle("rotate-90",a)}})}_addCheckboxListeners(e,t,n){e.addEventListener("change",s=>{if(s.target.type!=="checkbox")return;const i=s.target;if(i.disabled){s.preventDefault();return}const o=i.value,a=i.checked;s.stopPropagation();const l=this._getParentPaths(o),u=this._getChildPathsForNode(t,o);this._updateRelatedCheckboxes(e,t,o,a,l,u),e.dispatchEvent(new CustomEvent("taxonomyChange",{detail:{facetKey:n,path:o,checked:a,action:a?"add":"remove"}}))})}_updateRelatedCheckboxes(e,t,n,s,i,o){s?(this._updateCheckboxes(e,i,!0),this._updateCheckboxes(e,o,!0)):(this._updateCheckboxes(e,o,!1),this._updateParentCheckboxes(e,t,i)),this._updateCheckboxVisuals(e.querySelector(`input[value="${n}"]`),s)}_updateCheckboxes(e,t,n){t==null||t.forEach(s=>{const i=e.querySelector(`input[value="${s}"]`);i&&i.checked!==n&&!i.disabled&&(i.checked=n,this._updateCheckboxVisuals(i,n))})}_updateParentCheckboxes(e,t,n){n==null||n.forEach(s=>{const i=e.querySelector(`input[value="${s}"]`);if(!(i!=null&&i.checked)||i.disabled)return;this._getChildPathsForNode(t,s).some(l=>{const u=e.querySelector(`input[value="${l}"]`);return u==null?void 0:u.checked})||(i.checked=!1,this._updateCheckboxVisuals(i,!1))})}_updateCheckboxVisuals(e,t){var s;if(!e)return;const n=(s=e.closest("label"))==null?void 0:s.querySelector("span.text-sm");n&&(n.classList.toggle("font-medium",t),n.classList.toggle("text-primary-700",t))}_renderTaxonomyFacet(e,t,n,s,i,o,a){const l=document.createElement("div"),u=s[t]||[];this.renderTaxonomy(l,u,t,o),l.addEventListener("taxonomyChange",f=>{const{facetKey:v,path:m,checked:d}=f.detail;a({type:"FACET_CHANGE",facetType:v,value:m,checked:d})}),e.appendChild(l)}}var je;(function(r){r.Range="range",r.Steps="steps",r.Positions="positions",r.Count="count",r.Values="values"})(je||(je={}));var oe;(function(r){r[r.None=-1]="None",r[r.NoValue=0]="NoValue",r[r.LargeValue=1]="LargeValue",r[r.SmallValue=2]="SmallValue"})(oe||(oe={}));function qo(r){return _t(r)&&typeof r.from=="function"}function _t(r){return typeof r=="object"&&typeof r.to=="function"}function pn(r){r.parentElement.removeChild(r)}function tr(r){return r!=null}function gn(r){r.preventDefault()}function Wo(r){return r.filter(function(e){return this[e]?!1:this[e]=!0},{})}function Go(r,e){return Math.round(r/e)*e}function Zo(r,e){var t=r.getBoundingClientRect(),n=r.ownerDocument,s=n.documentElement,i=Wn(n);return/webkit.*Chrome.*Mobile/i.test(navigator.userAgent)&&(i.x=0),e?t.top+i.y-s.clientTop:t.left+i.x-s.clientLeft}function ve(r){return typeof r=="number"&&!isNaN(r)&&isFinite(r)}function mn(r,e,t){t>0&&(se(r,e),setTimeout(function(){bt(r,e)},t))}function vn(r){return Math.max(Math.min(r,100),0)}function Mt(r){return Array.isArray(r)?r:[r]}function Yo(r){r=String(r);var e=r.split(".");return e.length>1?e[1].length:0}function se(r,e){r.classList&&!/\s/.test(e)?r.classList.add(e):r.className+=" "+e}function bt(r,e){r.classList&&!/\s/.test(e)?r.classList.remove(e):r.className=r.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")}function Jo(r,e){return r.classList?r.classList.contains(e):new RegExp("\\b"+e+"\\b").test(r.className)}function Wn(r){var e=window.pageXOffset!==void 0,t=(r.compatMode||"")==="CSS1Compat",n=e?window.pageXOffset:t?r.documentElement.scrollLeft:r.body.scrollLeft,s=e?window.pageYOffset:t?r.documentElement.scrollTop:r.body.scrollTop;return{x:n,y:s}}function Qo(){return window.navigator.pointerEnabled?{start:"pointerdown",move:"pointermove",end:"pointerup"}:window.navigator.msPointerEnabled?{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:{start:"mousedown touchstart",move:"mousemove touchmove",end:"mouseup touchend"}}function Xo(){var r=!1;try{var e=Object.defineProperty({},"passive",{get:function(){r=!0}});window.addEventListener("test",null,e)}catch{}return r}function Ko(){return window.CSS&&CSS.supports&&CSS.supports("touch-action","none")}function fr(r,e){return 100/(e-r)}function rr(r,e,t){return e*100/(r[t+1]-r[t])}function ea(r,e){return rr(r,r[0]<0?e+Math.abs(r[0]):e-r[0],0)}function ta(r,e){return e*(r[1]-r[0])/100+r[0]}function st(r,e){for(var t=1;r>=e[t];)t+=1;return t}function ra(r,e,t){if(t>=r.slice(-1)[0])return 100;var n=st(t,r),s=r[n-1],i=r[n],o=e[n-1],a=e[n];return o+ea([s,i],t)/fr(o,a)}function na(r,e,t){if(t>=100)return r.slice(-1)[0];var n=st(t,e),s=r[n-1],i=r[n],o=e[n-1],a=e[n];return ta([s,i],(t-o)*fr(o,a))}function sa(r,e,t,n){if(n===100)return n;var s=st(n,r),i=r[s-1],o=r[s];return t?n-i>(o-i)/2?o:i:e[s-1]?r[s-1]+Go(n-r[s-1],e[s-1]):n}var Gn=function(){function r(e,t,n){this.xPct=[],this.xVal=[],this.xSteps=[],this.xNumSteps=[],this.xHighestCompleteStep=[],this.xSteps=[n||!1],this.xNumSteps=[!1],this.snap=t;var s,i=[];for(Object.keys(e).forEach(function(o){i.push([Mt(e[o]),o])}),i.sort(function(o,a){return o[0][0]-a[0][0]}),s=0;s<i.length;s++)this.handleEntryPoint(i[s][1],i[s][0]);for(this.xNumSteps=this.xSteps.slice(0),s=0;s<this.xNumSteps.length;s++)this.handleStepPoint(s,this.xNumSteps[s])}return r.prototype.getDistance=function(e){for(var t=[],n=0;n<this.xNumSteps.length-1;n++)t[n]=rr(this.xVal,e,n);return t},r.prototype.getAbsoluteDistance=function(e,t,n){var s=0;if(e<this.xPct[this.xPct.length-1])for(;e>this.xPct[s+1];)s++;else e===this.xPct[this.xPct.length-1]&&(s=this.xPct.length-2);!n&&e===this.xPct[s+1]&&s++,t===null&&(t=[]);var i,o=1,a=t[s],l=0,u=0,f=0,v=0;for(n?i=(e-this.xPct[s])/(this.xPct[s+1]-this.xPct[s]):i=(this.xPct[s+1]-e)/(this.xPct[s+1]-this.xPct[s]);a>0;)l=this.xPct[s+1+v]-this.xPct[s+v],t[s+v]*o+100-i*100>100?(u=l*i,o=(a-100*i)/t[s+v],i=1):(u=t[s+v]*l/100*o,o=0),n?(f=f-u,this.xPct.length+v>=1&&v--):(f=f+u,this.xPct.length-v>=1&&v++),a=t[s+v]*o;return e+f},r.prototype.toStepping=function(e){return e=ra(this.xVal,this.xPct,e),e},r.prototype.fromStepping=function(e){return na(this.xVal,this.xPct,e)},r.prototype.getStep=function(e){return e=sa(this.xPct,this.xSteps,this.snap,e),e},r.prototype.getDefaultStep=function(e,t,n){var s=st(e,this.xPct);return(e===100||t&&e===this.xPct[s-1])&&(s=Math.max(s-1,1)),(this.xVal[s]-this.xVal[s-1])/n},r.prototype.getNearbySteps=function(e){var t=st(e,this.xPct);return{stepBefore:{startValue:this.xVal[t-2],step:this.xNumSteps[t-2],highestStep:this.xHighestCompleteStep[t-2]},thisStep:{startValue:this.xVal[t-1],step:this.xNumSteps[t-1],highestStep:this.xHighestCompleteStep[t-1]},stepAfter:{startValue:this.xVal[t],step:this.xNumSteps[t],highestStep:this.xHighestCompleteStep[t]}}},r.prototype.countStepDecimals=function(){var e=this.xNumSteps.map(Yo);return Math.max.apply(null,e)},r.prototype.hasNoSize=function(){return this.xVal[0]===this.xVal[this.xVal.length-1]},r.prototype.convert=function(e){return this.getStep(this.toStepping(e))},r.prototype.handleEntryPoint=function(e,t){var n;if(e==="min"?n=0:e==="max"?n=100:n=parseFloat(e),!ve(n)||!ve(t[0]))throw new Error("noUiSlider: 'range' value isn't numeric.");this.xPct.push(n),this.xVal.push(t[0]);var s=Number(t[1]);n?this.xSteps.push(isNaN(s)?!1:s):isNaN(s)||(this.xSteps[0]=s),this.xHighestCompleteStep.push(0)},r.prototype.handleStepPoint=function(e,t){if(t){if(this.xVal[e]===this.xVal[e+1]){this.xSteps[e]=this.xHighestCompleteStep[e]=this.xVal[e];return}this.xSteps[e]=rr([this.xVal[e],this.xVal[e+1]],t,0)/fr(this.xPct[e],this.xPct[e+1]);var n=(this.xVal[e+1]-this.xVal[e])/this.xNumSteps[e],s=Math.ceil(Number(n.toFixed(3))-1),i=this.xVal[e]+this.xNumSteps[e]*s;this.xHighestCompleteStep[e]=i}},r}(),bn={to:function(r){return r===void 0?"":r.toFixed(2)},from:Number},Zn={target:"target",base:"base",origin:"origin",handle:"handle",handleLower:"handle-lower",handleUpper:"handle-upper",touchArea:"touch-area",horizontal:"horizontal",vertical:"vertical",background:"background",connect:"connect",connects:"connects",ltr:"ltr",rtl:"rtl",textDirectionLtr:"txt-dir-ltr",textDirectionRtl:"txt-dir-rtl",draggable:"draggable",drag:"state-drag",tap:"state-tap",active:"active",tooltip:"tooltip",pips:"pips",pipsHorizontal:"pips-horizontal",pipsVertical:"pips-vertical",marker:"marker",markerHorizontal:"marker-horizontal",markerVertical:"marker-vertical",markerNormal:"marker-normal",markerLarge:"marker-large",markerSub:"marker-sub",value:"value",valueHorizontal:"value-horizontal",valueVertical:"value-vertical",valueNormal:"value-normal",valueLarge:"value-large",valueSub:"value-sub"},Le={tooltips:".__tooltips",aria:".__aria"};function ia(r,e){if(!ve(e))throw new Error("noUiSlider: 'step' is not numeric.");r.singleStep=e}function oa(r,e){if(!ve(e))throw new Error("noUiSlider: 'keyboardPageMultiplier' is not numeric.");r.keyboardPageMultiplier=e}function aa(r,e){if(!ve(e))throw new Error("noUiSlider: 'keyboardMultiplier' is not numeric.");r.keyboardMultiplier=e}function la(r,e){if(!ve(e))throw new Error("noUiSlider: 'keyboardDefaultStep' is not numeric.");r.keyboardDefaultStep=e}function ca(r,e){if(typeof e!="object"||Array.isArray(e))throw new Error("noUiSlider: 'range' is not an object.");if(e.min===void 0||e.max===void 0)throw new Error("noUiSlider: Missing 'min' or 'max' in 'range'.");r.spectrum=new Gn(e,r.snap||!1,r.singleStep)}function ua(r,e){if(e=Mt(e),!Array.isArray(e)||!e.length)throw new Error("noUiSlider: 'start' option is incorrect.");r.handles=e.length,r.start=e}function da(r,e){if(typeof e!="boolean")throw new Error("noUiSlider: 'snap' option must be a boolean.");r.snap=e}function ha(r,e){if(typeof e!="boolean")throw new Error("noUiSlider: 'animate' option must be a boolean.");r.animate=e}function fa(r,e){if(typeof e!="number")throw new Error("noUiSlider: 'animationDuration' option must be a number.");r.animationDuration=e}function Yn(r,e){var t=[!1],n;if(e==="lower"?e=[!0,!1]:e==="upper"&&(e=[!1,!0]),e===!0||e===!1){for(n=1;n<r.handles;n++)t.push(e);t.push(!1)}else{if(!Array.isArray(e)||!e.length||e.length!==r.handles+1)throw new Error("noUiSlider: 'connect' option doesn't match handle count.");t=e}r.connect=t}function pa(r,e){switch(e){case"horizontal":r.ort=0;break;case"vertical":r.ort=1;break;default:throw new Error("noUiSlider: 'orientation' option is invalid.")}}function Jn(r,e){if(!ve(e))throw new Error("noUiSlider: 'margin' option must be numeric.");e!==0&&(r.margin=r.spectrum.getDistance(e))}function ga(r,e){if(!ve(e))throw new Error("noUiSlider: 'limit' option must be numeric.");if(r.limit=r.spectrum.getDistance(e),!r.limit||r.handles<2)throw new Error("noUiSlider: 'limit' option is only supported on linear sliders with 2 or more handles.")}function ma(r,e){var t;if(!ve(e)&&!Array.isArray(e))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(Array.isArray(e)&&!(e.length===2||ve(e[0])||ve(e[1])))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(e!==0){for(Array.isArray(e)||(e=[e,e]),r.padding=[r.spectrum.getDistance(e[0]),r.spectrum.getDistance(e[1])],t=0;t<r.spectrum.xNumSteps.length-1;t++)if(r.padding[0][t]<0||r.padding[1][t]<0)throw new Error("noUiSlider: 'padding' option must be a positive number(s).");var n=e[0]+e[1],s=r.spectrum.xVal[0],i=r.spectrum.xVal[r.spectrum.xVal.length-1];if(n/(i-s)>1)throw new Error("noUiSlider: 'padding' option must not exceed 100% of the range.")}}function va(r,e){switch(e){case"ltr":r.dir=0;break;case"rtl":r.dir=1;break;default:throw new Error("noUiSlider: 'direction' option was not recognized.")}}function ba(r,e){if(typeof e!="string")throw new Error("noUiSlider: 'behaviour' must be a string containing options.");var t=e.indexOf("tap")>=0,n=e.indexOf("drag")>=0,s=e.indexOf("fixed")>=0,i=e.indexOf("snap")>=0,o=e.indexOf("hover")>=0,a=e.indexOf("unconstrained")>=0,l=e.indexOf("invert-connects")>=0,u=e.indexOf("drag-all")>=0,f=e.indexOf("smooth-steps")>=0;if(s){if(r.handles!==2)throw new Error("noUiSlider: 'fixed' behaviour must be used with 2 handles");Jn(r,r.start[1]-r.start[0])}if(l&&r.handles!==2)throw new Error("noUiSlider: 'invert-connects' behaviour must be used with 2 handles");if(a&&(r.margin||r.limit))throw new Error("noUiSlider: 'unconstrained' behaviour cannot be used with margin or limit");r.events={tap:t||i,drag:n,dragAll:u,smoothSteps:f,fixed:s,snap:i,hover:o,unconstrained:a,invertConnects:l}}function ya(r,e){if(e!==!1)if(e===!0||_t(e)){r.tooltips=[];for(var t=0;t<r.handles;t++)r.tooltips.push(e)}else{if(e=Mt(e),e.length!==r.handles)throw new Error("noUiSlider: must pass a formatter for all handles.");e.forEach(function(n){if(typeof n!="boolean"&&!_t(n))throw new Error("noUiSlider: 'tooltips' must be passed a formatter or 'false'.")}),r.tooltips=e}}function wa(r,e){if(e.length!==r.handles)throw new Error("noUiSlider: must pass a attributes for all handles.");r.handleAttributes=e}function xa(r,e){if(!_t(e))throw new Error("noUiSlider: 'ariaFormat' requires 'to' method.");r.ariaFormat=e}function _a(r,e){if(!qo(e))throw new Error("noUiSlider: 'format' requires 'to' and 'from' methods.");r.format=e}function Sa(r,e){if(typeof e!="boolean")throw new Error("noUiSlider: 'keyboardSupport' option must be a boolean.");r.keyboardSupport=e}function Ca(r,e){r.documentElement=e}function Ea(r,e){if(typeof e!="string"&&e!==!1)throw new Error("noUiSlider: 'cssPrefix' must be a string or `false`.");r.cssPrefix=e}function ka(r,e){if(typeof e!="object")throw new Error("noUiSlider: 'cssClasses' must be an object.");typeof r.cssPrefix=="string"?(r.cssClasses={},Object.keys(e).forEach(function(t){r.cssClasses[t]=r.cssPrefix+e[t]})):r.cssClasses=e}function Qn(r){var e={margin:null,limit:null,padding:null,animate:!0,animationDuration:300,ariaFormat:bn,format:bn},t={step:{r:!1,t:ia},keyboardPageMultiplier:{r:!1,t:oa},keyboardMultiplier:{r:!1,t:aa},keyboardDefaultStep:{r:!1,t:la},start:{r:!0,t:ua},connect:{r:!0,t:Yn},direction:{r:!0,t:va},snap:{r:!1,t:da},animate:{r:!1,t:ha},animationDuration:{r:!1,t:fa},range:{r:!0,t:ca},orientation:{r:!1,t:pa},margin:{r:!1,t:Jn},limit:{r:!1,t:ga},padding:{r:!1,t:ma},behaviour:{r:!0,t:ba},ariaFormat:{r:!1,t:xa},format:{r:!1,t:_a},tooltips:{r:!1,t:ya},keyboardSupport:{r:!0,t:Sa},documentElement:{r:!1,t:Ca},cssPrefix:{r:!0,t:Ea},cssClasses:{r:!0,t:ka},handleAttributes:{r:!1,t:wa}},n={connect:!1,direction:"ltr",behaviour:"tap",orientation:"horizontal",keyboardSupport:!0,cssPrefix:"noUi-",cssClasses:Zn,keyboardPageMultiplier:5,keyboardMultiplier:1,keyboardDefaultStep:10};r.format&&!r.ariaFormat&&(r.ariaFormat=r.format),Object.keys(t).forEach(function(l){if(!tr(r[l])&&n[l]===void 0){if(t[l].r)throw new Error("noUiSlider: '"+l+"' is required.");return}t[l].t(e,tr(r[l])?r[l]:n[l])}),e.pips=r.pips;var s=document.createElement("div"),i=s.style.msTransform!==void 0,o=s.style.transform!==void 0;e.transformRule=o?"transform":i?"msTransform":"webkitTransform";var a=[["left","top"],["right","bottom"]];return e.style=a[e.dir][e.ort],e}function Ma(r,e,t){var n=Qo(),s=Ko(),i=s&&Xo(),o=r,a,l,u,f,v,m,d=e.spectrum,y=[],x=[],C=[],j=0,$={},R=!1,B=r.ownerDocument,G=e.documentElement||B.documentElement,F=B.body,N=B.dir==="rtl"||e.ort===1?0:100;function J(h,g){var b=B.createElement("div");return g&&se(b,g),h.appendChild(b),b}function ce(h,g){var b=J(h,e.cssClasses.origin),S=J(b,e.cssClasses.handle);if(J(S,e.cssClasses.touchArea),S.setAttribute("data-handle",String(g)),e.keyboardSupport&&(S.setAttribute("tabindex","0"),S.addEventListener("keydown",function(M){return Ye(M,g)})),e.handleAttributes!==void 0){var k=e.handleAttributes[g];Object.keys(k).forEach(function(M){S.setAttribute(M,k[M])})}return S.setAttribute("role","slider"),S.setAttribute("aria-orientation",e.ort?"vertical":"horizontal"),g===0?se(S,e.cssClasses.handleLower):g===e.handles-1&&se(S,e.cssClasses.handleUpper),b.handle=S,b}function be(h,g){return g?J(h,e.cssClasses.connect):!1}function te(h,g){l=J(g,e.cssClasses.connects),u=[],f=[],f.push(be(l,h[0]));for(var b=0;b<e.handles;b++)u.push(ce(g,b)),C[b]=b,f.push(be(l,h[b+1]))}function le(h){se(h,e.cssClasses.target),e.dir===0?se(h,e.cssClasses.ltr):se(h,e.cssClasses.rtl),e.ort===0?se(h,e.cssClasses.horizontal):se(h,e.cssClasses.vertical);var g=getComputedStyle(h).direction;return g==="rtl"?se(h,e.cssClasses.textDirectionRtl):se(h,e.cssClasses.textDirectionLtr),J(h,e.cssClasses.base)}function ue(h,g){return!e.tooltips||!e.tooltips[g]?!1:J(h.firstChild,e.cssClasses.tooltip)}function ge(){return o.hasAttribute("disabled")}function de(h){var g=u[h];return g.hasAttribute("disabled")}function w(h){h!=null?(u[h].setAttribute("disabled",""),u[h].handle.removeAttribute("tabindex")):(o.setAttribute("disabled",""),u.forEach(function(g){g.handle.removeAttribute("tabindex")}))}function c(h){h!=null?(u[h].removeAttribute("disabled"),u[h].handle.setAttribute("tabindex","0")):(o.removeAttribute("disabled"),u.forEach(function(g){g.removeAttribute("disabled"),g.handle.setAttribute("tabindex","0")}))}function p(){m&&(Je("update"+Le.tooltips),m.forEach(function(h){h&&pn(h)}),m=null)}function _(){p(),m=u.map(ue),It("update"+Le.tooltips,function(h,g,b){if(!(!m||!e.tooltips)&&m[g]!==!1){var S=h[g];e.tooltips[g]!==!0&&(S=e.tooltips[g].to(b[g])),m[g].innerHTML=S}})}function E(){Je("update"+Le.aria),It("update"+Le.aria,function(h,g,b,S,k){C.forEach(function(M){var O=u[M],L=at(x,M,0,!0,!0,!0),U=at(x,M,100,!0,!0,!0),V=k[M],Z=String(e.ariaFormat.to(b[M]));L=d.fromStepping(L).toFixed(1),U=d.fromStepping(U).toFixed(1),V=d.fromStepping(V).toFixed(1),O.children[0].setAttribute("aria-valuemin",L),O.children[0].setAttribute("aria-valuemax",U),O.children[0].setAttribute("aria-valuenow",V),O.children[0].setAttribute("aria-valuetext",Z)})})}function A(h){if(h.mode===je.Range||h.mode===je.Steps)return d.xVal;if(h.mode===je.Count){if(h.values<2)throw new Error("noUiSlider: 'values' (>= 2) required for mode 'count'.");for(var g=h.values-1,b=100/g,S=[];g--;)S[g]=g*b;return S.push(100),I(S,h.stepped)}return h.mode===je.Positions?I(h.values,h.stepped):h.mode===je.Values?h.stepped?h.values.map(function(k){return d.fromStepping(d.getStep(d.toStepping(k)))}):h.values:[]}function I(h,g){return h.map(function(b){return d.fromStepping(g?d.getStep(b):b)})}function T(h){function g(V,Z){return Number((V+Z).toFixed(7))}var b=A(h),S={},k=d.xVal[0],M=d.xVal[d.xVal.length-1],O=!1,L=!1,U=0;return b=Wo(b.slice().sort(function(V,Z){return V-Z})),b[0]!==k&&(b.unshift(k),O=!0),b[b.length-1]!==M&&(b.push(M),L=!0),b.forEach(function(V,Z){var Y,H,K,ne=V,ee=b[Z+1],re,Ft,Ot,Nt,xr,$t,_r,Sr=h.mode===je.Steps;for(Sr&&(Y=d.xNumSteps[Z]),Y||(Y=ee-ne),ee===void 0&&(ee=ne),Y=Math.max(Y,1e-7),H=ne;H<=ee;H=g(H,Y)){for(re=d.toStepping(H),Ft=re-U,xr=Ft/(h.density||1),$t=Math.round(xr),_r=Ft/$t,K=1;K<=$t;K+=1)Ot=U+K*_r,S[Ot.toFixed(5)]=[d.fromStepping(Ot),0];Nt=b.indexOf(H)>-1?oe.LargeValue:Sr?oe.SmallValue:oe.NoValue,!Z&&O&&H!==ee&&(Nt=0),H===ee&&L||(S[re.toFixed(5)]=[H,Nt]),U=re}}),S}function X(h,g,b){var S,k,M=B.createElement("div"),O=(S={},S[oe.None]="",S[oe.NoValue]=e.cssClasses.valueNormal,S[oe.LargeValue]=e.cssClasses.valueLarge,S[oe.SmallValue]=e.cssClasses.valueSub,S),L=(k={},k[oe.None]="",k[oe.NoValue]=e.cssClasses.markerNormal,k[oe.LargeValue]=e.cssClasses.markerLarge,k[oe.SmallValue]=e.cssClasses.markerSub,k),U=[e.cssClasses.valueHorizontal,e.cssClasses.valueVertical],V=[e.cssClasses.markerHorizontal,e.cssClasses.markerVertical];se(M,e.cssClasses.pips),se(M,e.ort===0?e.cssClasses.pipsHorizontal:e.cssClasses.pipsVertical);function Z(H,K){var ne=K===e.cssClasses.value,ee=ne?U:V,re=ne?O:L;return K+" "+ee[e.ort]+" "+re[H]}function Y(H,K,ne){if(ne=g?g(K,ne):ne,ne!==oe.None){var ee=J(M,!1);ee.className=Z(ne,e.cssClasses.marker),ee.style[e.style]=H+"%",ne>oe.NoValue&&(ee=J(M,!1),ee.className=Z(ne,e.cssClasses.value),ee.setAttribute("data-value",String(K)),ee.style[e.style]=H+"%",ee.innerHTML=String(b.to(K)))}}return Object.keys(h).forEach(function(H){Y(H,h[H][0],h[H][1])}),M}function D(){v&&(pn(v),v=null)}function ye(h){D();var g=T(h),b=h.filter,S=h.format||{to:function(k){return String(Math.round(k))}};return v=o.appendChild(X(g,b,S)),v}function Fe(){var h=a.getBoundingClientRect(),g="offset"+["Width","Height"][e.ort];return e.ort===0?h.width||a[g]:h.height||a[g]}function he(h,g,b,S){var k=function(O){var L=we(O,S.pageOffset,S.target||g);if(!L||ge()&&!S.doNotReject||Jo(o,e.cssClasses.tap)&&!S.doNotReject||h===n.start&&L.buttons!==void 0&&L.buttons>1||S.hover&&L.buttons)return!1;i||L.preventDefault(),L.calcPoint=L.points[e.ort],b(L,S)},M=[];return h.split(" ").forEach(function(O){g.addEventListener(O,k,i?{passive:!0}:!1),M.push([O,k])}),M}function we(h,g,b){var S=h.type.indexOf("touch")===0,k=h.type.indexOf("mouse")===0,M=h.type.indexOf("pointer")===0,O=0,L=0;if(h.type.indexOf("MSPointer")===0&&(M=!0),h.type==="mousedown"&&!h.buttons&&!h.touches)return!1;if(S){var U=function(Y){var H=Y.target;return H===b||b.contains(H)||h.composed&&h.composedPath().shift()===b};if(h.type==="touchstart"){var V=Array.prototype.filter.call(h.touches,U);if(V.length>1)return!1;O=V[0].pageX,L=V[0].pageY}else{var Z=Array.prototype.find.call(h.changedTouches,U);if(!Z)return!1;O=Z.pageX,L=Z.pageY}}return g=g||Wn(B),(k||M)&&(O=h.clientX+g.x,L=h.clientY+g.y),h.pageOffset=g,h.points=[O,L],h.cursor=k||M,h}function Se(h){var g=h-Zo(a,e.ort),b=g*100/Fe();return b=vn(b),e.dir?100-b:b}function De(h){var g=100,b=!1;return u.forEach(function(S,k){if(!de(k)){var M=x[k],O=Math.abs(M-h),L=O===100&&g===100,U=O<g,V=O<=g&&h>M;(U||V||L)&&(b=k,g=O)}}),b}function Me(h,g){h.type==="mouseout"&&h.target.nodeName==="HTML"&&h.relatedTarget===null&&Ie(h,g)}function Ae(h,g){if(navigator.appVersion.indexOf("MSIE 9")===-1&&h.buttons===0&&g.buttonsProperty!==0)return Ie(h,g);var b=(e.dir?-1:1)*(h.calcPoint-g.startCalcPoint),S=b*100/g.baseSize;gr(b>0,S,g.locations,g.handleNumbers,g.connect)}function Ie(h,g){g.handle&&(bt(g.handle,e.cssClasses.active),j-=1),g.listeners.forEach(function(b){G.removeEventListener(b[0],b[1])}),j===0&&(bt(o,e.cssClasses.drag),jt(),h.cursor&&(F.style.cursor="",F.removeEventListener("selectstart",gn))),e.events.smoothSteps&&(g.handleNumbers.forEach(function(b){Oe(b,x[b],!0,!0,!1,!1)}),g.handleNumbers.forEach(function(b){Q("update",b)})),g.handleNumbers.forEach(function(b){Q("change",b),Q("set",b),Q("end",b)})}function He(h,g){if(!g.handleNumbers.some(de)){var b;if(g.handleNumbers.length===1){var S=u[g.handleNumbers[0]];b=S.children[0],j+=1,se(b,e.cssClasses.active)}h.stopPropagation();var k=[],M=he(n.move,G,Ae,{target:h.target,handle:b,connect:g.connect,listeners:k,startCalcPoint:h.calcPoint,baseSize:Fe(),pageOffset:h.pageOffset,handleNumbers:g.handleNumbers,buttonsProperty:h.buttons,locations:x.slice()}),O=he(n.end,G,Ie,{target:h.target,handle:b,listeners:k,doNotReject:!0,handleNumbers:g.handleNumbers}),L=he("mouseout",G,Me,{target:h.target,handle:b,listeners:k,doNotReject:!0,handleNumbers:g.handleNumbers});k.push.apply(k,M.concat(O,L)),h.cursor&&(F.style.cursor=getComputedStyle(h.target).cursor,u.length>1&&se(o,e.cssClasses.drag),F.addEventListener("selectstart",gn,!1)),g.handleNumbers.forEach(function(U){Q("start",U)})}}function ot(h){h.stopPropagation();var g=Se(h.calcPoint),b=De(g);b!==!1&&(e.events.snap||mn(o,e.cssClasses.tap,e.animationDuration),Oe(b,g,!0,!0),jt(),Q("slide",b,!0),Q("update",b,!0),e.events.snap?He(h,{handleNumbers:[b]}):(Q("change",b,!0),Q("set",b,!0)))}function At(h){var g=Se(h.calcPoint),b=d.getStep(g),S=d.fromStepping(b);Object.keys($).forEach(function(k){k.split(".")[0]==="hover"&&$[k].forEach(function(M){M.call(ct,S)})})}function Ye(h,g){if(ge()||de(g))return!1;var b=["Left","Right"],S=["Down","Up"],k=["PageDown","PageUp"],M=["Home","End"];e.dir&&!e.ort?b.reverse():e.ort&&!e.dir&&(S.reverse(),k.reverse());var O=h.key.replace("Arrow",""),L=O===k[0],U=O===k[1],V=O===S[0]||O===b[0]||L,Z=O===S[1]||O===b[1]||U,Y=O===M[0],H=O===M[1];if(!V&&!Z&&!Y&&!H)return!0;h.preventDefault();var K;if(Z||V){var ne=V?0:1,ee=yr(g),re=ee[ne];if(re===null)return!1;re===!1&&(re=d.getDefaultStep(x[g],V,e.keyboardDefaultStep)),U||L?re*=e.keyboardPageMultiplier:re*=e.keyboardMultiplier,re=Math.max(re,1e-7),re=(V?-1:1)*re,K=y[g]+re}else H?K=e.spectrum.xVal[e.spectrum.xVal.length-1]:K=e.spectrum.xVal[0];return Oe(g,d.toStepping(K),!0,!0),Q("slide",g),Q("update",g),Q("change",g),Q("set",g),!1}function pr(h){h.fixed||u.forEach(function(g,b){he(n.start,g.children[0],He,{handleNumbers:[b]})}),h.tap&&he(n.start,a,ot,{}),h.hover&&he(n.move,a,At,{hover:!0}),h.drag&&f.forEach(function(g,b){if(!(g===!1||b===0||b===f.length-1)){var S=u[b-1],k=u[b],M=[g],O=[S,k],L=[b-1,b];se(g,e.cssClasses.draggable),h.fixed&&(M.push(S.children[0]),M.push(k.children[0])),h.dragAll&&(O=u,L=C),M.forEach(function(U){he(n.start,U,He,{handles:O,handleNumbers:L,connect:g})})}})}function It(h,g){$[h]=$[h]||[],$[h].push(g),h.split(".")[0]==="update"&&u.forEach(function(b,S){Q("update",S)})}function Kn(h){return h===Le.aria||h===Le.tooltips}function Je(h){var g=h&&h.split(".")[0],b=g?h.substring(g.length):h;Object.keys($).forEach(function(S){var k=S.split(".")[0],M=S.substring(k.length);(!g||g===k)&&(!b||b===M)&&(!Kn(M)||b===M)&&delete $[S]})}function Q(h,g,b){Object.keys($).forEach(function(S){var k=S.split(".")[0];h===k&&$[S].forEach(function(M){M.call(ct,y.map(e.format.to),g,y.slice(),b||!1,x.slice(),ct)})})}function at(h,g,b,S,k,M,O){var L;return u.length>1&&!e.events.unconstrained&&(S&&g>0&&(L=d.getAbsoluteDistance(h[g-1],e.margin,!1),b=Math.max(b,L)),k&&g<u.length-1&&(L=d.getAbsoluteDistance(h[g+1],e.margin,!0),b=Math.min(b,L))),u.length>1&&e.limit&&(S&&g>0&&(L=d.getAbsoluteDistance(h[g-1],e.limit,!1),b=Math.min(b,L)),k&&g<u.length-1&&(L=d.getAbsoluteDistance(h[g+1],e.limit,!0),b=Math.max(b,L))),e.padding&&(g===0&&(L=d.getAbsoluteDistance(0,e.padding[0],!1),b=Math.max(b,L)),g===u.length-1&&(L=d.getAbsoluteDistance(100,e.padding[1],!0),b=Math.min(b,L))),O||(b=d.getStep(b)),b=vn(b),b===h[g]&&!M?!1:b}function Lt(h,g){var b=e.ort;return(b?g:h)+", "+(b?h:g)}function gr(h,g,b,S,k){var M=b.slice(),O=S[0],L=e.events.smoothSteps,U=[!h,h],V=[h,!h];S=S.slice(),h&&S.reverse(),S.length>1?S.forEach(function(Y,H){var K=at(M,Y,M[Y]+g,U[H],V[H],!1,L);K===!1?g=0:(g=K-M[Y],M[Y]=K)}):U=V=[!0];var Z=!1;S.forEach(function(Y,H){Z=Oe(Y,b[Y]+g,U[H],V[H],!1,L)||Z}),Z&&(S.forEach(function(Y){Q("update",Y),Q("slide",Y)}),k!=null&&Q("drag",O))}function mr(h,g){return e.dir?100-h-g:h}function es(h,g){x[h]=g,y[h]=d.fromStepping(g);var b=mr(g,0)-N,S="translate("+Lt(b+"%","0")+")";if(u[h].style[e.transformRule]=S,e.events.invertConnects&&x.length>1){var k=x.every(function(M,O,L){return O===0||M>=L[O-1]});if(R!==!k){os();return}}Qe(h),Qe(h+1),R&&(Qe(h-1),Qe(h+2))}function jt(){C.forEach(function(h){var g=x[h]>50?-1:1,b=3+(u.length+g*h);u[h].style.zIndex=String(b)})}function Oe(h,g,b,S,k,M){return k||(g=at(x,h,g,b,S,!1,M)),g===!1?!1:(es(h,g),!0)}function Qe(h){if(f[h]){var g=x.slice();R&&g.sort(function(L,U){return L-U});var b=0,S=100;h!==0&&(b=g[h-1]),h!==f.length-1&&(S=g[h]);var k=S-b,M="translate("+Lt(mr(b,k)+"%","0")+")",O="scale("+Lt(k/100,"1")+")";f[h].style[e.transformRule]=M+" "+O}}function vr(h,g){return h===null||h===!1||h===void 0||(typeof h=="number"&&(h=String(h)),h=e.format.from(h),h!==!1&&(h=d.toStepping(h)),h===!1||isNaN(h))?x[g]:h}function lt(h,g,b){var S=Mt(h),k=x[0]===void 0;g=g===void 0?!0:g,e.animate&&!k&&mn(o,e.cssClasses.tap,e.animationDuration),C.forEach(function(L){Oe(L,vr(S[L],L),!0,!1,b)});var M=C.length===1?0:1;if(k&&d.hasNoSize()&&(b=!0,x[0]=0,C.length>1)){var O=100/(C.length-1);C.forEach(function(L){x[L]=L*O})}for(;M<C.length;++M)C.forEach(function(L){Oe(L,x[L],!0,!0,b)});jt(),C.forEach(function(L){Q("update",L),S[L]!==null&&g&&Q("set",L)})}function ts(h){lt(e.start,h)}function rs(h,g,b,S){if(h=Number(h),!(h>=0&&h<C.length))throw new Error("noUiSlider: invalid handle number, got: "+h);Oe(h,vr(g,h),!0,!0,S),Q("update",h),b&&Q("set",h)}function br(h){if(h===void 0&&(h=!1),h)return y.length===1?y[0]:y.slice(0);var g=y.map(e.format.to);return g.length===1?g[0]:g}function ns(){for(Je(Le.aria),Je(Le.tooltips),Object.keys(e.cssClasses).forEach(function(h){bt(o,e.cssClasses[h])});o.firstChild;)o.removeChild(o.firstChild);delete o.noUiSlider}function yr(h){var g=x[h],b=d.getNearbySteps(g),S=y[h],k=b.thisStep.step,M=null;if(e.snap)return[S-b.stepBefore.startValue||null,b.stepAfter.startValue-S||null];k!==!1&&S+k>b.stepAfter.startValue&&(k=b.stepAfter.startValue-S),S>b.thisStep.startValue?M=b.thisStep.step:b.stepBefore.step===!1?M=!1:M=S-b.stepBefore.highestStep,g===100?k=null:g===0&&(M=null);var O=d.countStepDecimals();return k!==null&&k!==!1&&(k=Number(k.toFixed(O))),M!==null&&M!==!1&&(M=Number(M.toFixed(O))),[M,k]}function ss(){return C.map(yr)}function is(h,g){var b=br(),S=["margin","limit","padding","range","animate","snap","step","format","pips","tooltips","connect"];S.forEach(function(M){h[M]!==void 0&&(t[M]=h[M])});var k=Qn(t);S.forEach(function(M){h[M]!==void 0&&(e[M]=k[M])}),d=k.spectrum,e.margin=k.margin,e.limit=k.limit,e.padding=k.padding,e.pips?ye(e.pips):D(),e.tooltips?_():p(),x=[],lt(tr(h.start)?h.start:b,g),h.connect&&wr()}function wr(){for(;l.firstChild;)l.removeChild(l.firstChild);for(var h=0;h<=e.handles;h++)f[h]=be(l,e.connect[h]),Qe(h);pr({drag:e.events.drag,fixed:!0})}function os(){R=!R,Yn(e,e.connect.map(function(h){return!h})),wr()}function as(){a=le(o),te(e.connect,a),pr(e.events),lt(e.start),e.pips&&ye(e.pips),e.tooltips&&_(),E()}as();var ct={destroy:ns,steps:ss,on:It,off:Je,get:br,set:lt,setHandle:rs,reset:ts,disable:w,enable:c,__moveHandles:function(h,g,b){gr(h,g,x,b)},options:t,updateOptions:is,target:o,removePips:D,removeTooltips:p,getPositions:function(){return x.slice()},getTooltips:function(){return m},getOrigins:function(){return u},pips:ye};return ct}function Aa(r,e){if(!r||!r.nodeName)throw new Error("noUiSlider: create requires a single element, got: "+r);if(r.noUiSlider)throw new Error("noUiSlider: Slider was already initialized.");var t=Qn(e),n=Ma(r,t,e);return r.noUiSlider=n,n}const Ia={__spectrum:Gn,cssClasses:Zn,create:Aa};class Xn{constructor(){this.playIntervals=new Map,this.playStates=new Map}_processRangeData(e,t,n){const s=e.map(d=>({value:parseInt(d.key,10),count:d.doc_count||0})).filter(d=>!isNaN(d.value)).sort((d,y)=>d.value-y.value),i=t.map(d=>({value:parseInt(d.key,10),count:d.doc_count||0})).filter(d=>!isNaN(d.value)).sort((d,y)=>d.value-y.value);if(s.length===0)throw new Error("No valid numeric values found in range data");const o=s.map(d=>d.value),a=i.map(d=>d.value),l=o[0],u=o[o.length-1],f=[...new Set(a)];let v,m;return n&&n.length===2?(v=Math.max(n[0],l),m=Math.min(n[1],u)):(v=f[0]||l,m=f[f.length-1]||u),{allBuckets:s,availableBuckets:i,sortedAvailableValues:f,minValue:l,maxValue:u,startValue:v,endValue:m}}_createRangeFacetDOM(e,t){const n=document.createElement("div");return n.className="facet-slider my-3",n.innerHTML=this._getRangeFacetHTML(e,t),n}_getRangeFacetHTML(e,{minValue:t,maxValue:n}){return`
      <div class="space-y-3">
        <!-- Play Controls -->
        <div class="play-controls flex items-center justify-center gap-2 pb-3 border-b border-gray-200">
          <button id="${e}-play-btn" class="group relative w-8 h-8 bg-gradient-to-r from-primary-400 to-primary-700 text-white text-xs rounded-full transition-colors duration-200 hover:from-primary-600 hover:to-primary-700 shadow-md hover:shadow-lg flex items-center justify-center" type="button">
            <div class="w-0 h-0 border-l-[5px] border-l-white border-y-[3px] border-y-transparent ml-0.5"></div>
            <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">Play</span>
          </button>
          <button id="${e}-pause-btn" class="group relative w-8 h-8 bg-gradient-to-r from-secondary-400 to-secondary-700 text-white text-xs rounded-full transition-colors duration-200 hover:from-secondary-600 hover:to-secondary-700 shadow-md hover:shadow-lg flex items-center justify-center" type="button">
            <div class="flex gap-0.5">
              <div class="w-0.5 h-3 bg-white rounded-sm"></div>
              <div class="w-0.5 h-3 bg-white rounded-sm"></div>
            </div>
            <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">Pause</span>
          </button>
        </div>

        <!-- Chart Container -->
        <div class="relative">
          <div id="${e}-chart" class="w-full h-16 mb-3 bg-gray-50 rounded-md p-2"></div>
        </div>
        
        <!-- Slider Container -->
        <div class="px-1">
          <div id="${e}-slider" class="slider-container"></div>
        </div>
        
        <!-- Value Display -->
        <div class="flex items-center justify-between text-xs text-gray-600 px-1">
          <span id="${e}-min-display" class="font-medium">${t}</span>
          <span id="${e}-max-display" class="font-medium">${n}</span>
        </div>
        
        <!-- Custom Range Inputs -->
        <div class="mt-4 pt-3 border-t border-gray-100">
          <div class="text-xs font-medium text-gray-700 mb-2">Custom range:</div>
          <div class="grid grid-cols-2 gap-2">
            <div class="min-w-0">
              <input id="${e}-min-input" type="number"
                    class="w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-primary-400 focus:border-primary-400 focus:outline-none"
                    value="${t}"
                    placeholder="Min">
            </div>
            <div class="min-w-0">
              <input id="${e}-max-input" type="number"
                    class="w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-primary-400 focus:border-primary-400 focus:outline-none"
                    value="${n}"
                    placeholder="Max">
            </div>
          </div>
        </div>
      </div>
    `}_getSliderElements(e,t){return{chartElement:e.querySelector(`#${t}-chart`),slider:e.querySelector(`#${t}-slider`),minInput:e.querySelector(`#${t}-min-input`),maxInput:e.querySelector(`#${t}-max-input`),minDisplay:e.querySelector(`#${t}-min-display`),maxDisplay:e.querySelector(`#${t}-max-display`),playBtn:e.querySelector(`#${t}-play-btn`),pauseBtn:e.querySelector(`#${t}-pause-btn`)}}_initializeSlider(e,t){Ia.create(e,{start:[t.startValue,t.endValue],connect:!0,step:1,range:{min:t.minValue,max:t.maxValue},format:{to:n=>Math.round(n),from:n=>parseInt(n,10)}}),e.classList.add("custom-slider")}_setupEventHandlers(e,t,n,s){t.slider.noUiSlider.on("update",i=>{const[o,a]=i.map(l=>Math.round(Number(l)));t.minDisplay.textContent=o.toString(),t.maxDisplay.textContent=a.toString(),document.activeElement!==t.minInput&&(t.minInput.value=o),document.activeElement!==t.maxInput&&(t.maxInput.value=a)}),t.slider.noUiSlider.on("change",i=>{const[o,a]=i.map(l=>Math.round(Number(l)));!isNaN(o)&&!isNaN(a)&&o>=n.minValue&&a<=n.maxValue&&this._updateRange(e,[o,a],s,t.chartElement,n.allBuckets,n)}),t.minInput.addEventListener("change",i=>{this._handleInputChange(i.target,!0,e,t,n,s)}),t.maxInput.addEventListener("change",i=>{this._handleInputChange(i.target,!1,e,t,n,s)}),[t.minInput,t.maxInput].forEach(i=>{i.addEventListener("keypress",o=>{o.key==="Enter"&&o.target.blur()})}),this.setupPlayControls(e,t.playBtn,t.pauseBtn,t.slider,n.sortedAvailableValues,s,t.chartElement,n.allBuckets)}_validateAndClampInput(e,t,n){const s=parseInt(e,10);return isNaN(s)?null:Math.max(t,Math.min(n,s))}_storeSliderReferences(e,t,n){e.slider=t.slider,e.sortedValues=n.sortedAvailableValues,Object.assign(e,t),e.cleanup=()=>{t.slider.noUiSlider&&t.slider.noUiSlider.destroy(),this.playStates.delete(e.facetKey)}}setupPlayControls(e,t,n,s,i,o,a,l){t.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),this.startPlay(e,t,n,s,i,o,a,l)}),n.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),this.pausePlay(e,t,n)})}startPlay(e,t,n,s,i,o,a,l){if(this.playIntervals.has(e))return;const[u,f]=s.noUiSlider.get().map(Number),v=this._findClosestDatasetValue(i,u),m=this._findClosestDatasetValue(i,f);let d=this.playStates.get(e);if(d)d.currentMaxIndex>=d.maxLimitIndex&&(d.currentMaxIndex=d.startMinIndex,this.playStates.set(e,d));else{const x=i.indexOf(v),C=i.indexOf(m);d={startMinIndex:x,currentMaxIndex:x,maxLimitIndex:C,originalMin:v,originalMax:m},this.playStates.set(e,d)}const y=setInterval(()=>{const x=this.playStates.get(e);if(!x){clearInterval(y),this.playIntervals.delete(e);return}let{startMinIndex:C,currentMaxIndex:j,maxLimitIndex:$}=x;if(j=Math.min(j+1,$),j>=$){const G=i[C],F=i[$];s.noUiSlider.set([G,F]);const N=s.closest(".facet-slider");N.minValue,N.maxValue,o({type:"RANGE_CHANGE",facetKey:e,value:[G,F]}),this.updateChartHighlight(a,l,G,F),this.playStates.delete(e),this.pausePlay(e,t,n);return}this.playStates.set(e,{...x,currentMaxIndex:j});const R=i[C],B=i[j];s.noUiSlider.set([R,B]),o({type:"RANGE_CHANGE",facetKey:e,value:[R,B]}),this.updateChartHighlight(a,l,R,B)},500);this.playIntervals.set(e,y)}pausePlay(e,t,n){const s=this.playIntervals.get(e);s&&(clearInterval(s),this.playIntervals.delete(e))}_updateRange(e,[t,n],s,i,o,a){this.playStates.delete(e);let l;t===a.minValue&&n===a.maxValue?l=null:l=[t,n],s({type:"RANGE_CHANGE",facetKey:e,value:l}),this.updateChartHighlight(i,o,t,n)}_handleInputChange(e,t,n,s,i,o){const a=this._validateAndClampInput(e.value,i.minValue,i.maxValue);if(a===null)return;const[l,u]=s.slider.noUiSlider.get().map(Number),f=t?[Math.max(i.minValue,Math.min(a,u)),u]:[l,Math.min(i.maxValue,Math.max(a,l))];this._updateRange(n,f,o,s.chartElement,i.allBuckets,i),s.slider.noUiSlider.set(f)}_findClosestDatasetValue(e,t){if(e.length===0)return t;if(t<=e[0])return e[0];if(t>=e[e.length-1])return e[e.length-1];let n=0,s=e.length-1;for(;n<=s;){const a=Math.floor((n+s)/2),l=e[a];if(l===t)return l;l<t?n=a+1:s=a-1}if(s<0)return e[0];if(n>=e.length)return e[e.length-1];const i=Math.abs(e[n]-t),o=Math.abs(e[s]-t);return i<=o?e[n]:e[s]}updateChartHighlight(e,t,n,s){const i=e.querySelector(".flex.items-end");if(!i){console.warn("Bars container not found");return}i.querySelectorAll("[data-value]").forEach(a=>{const l=parseInt(a.dataset.value),u=parseInt(a.dataset.count);l>=n&&l<=s?u>0?a.style.backgroundColor="#d1d5db":a.style.backgroundColor="#bfdbfe":a.style.backgroundColor="#d1d5db"})}renderBarChart(e,t,n,s,i,o=null){e.innerHTML="";const a=Math.max(...n.map(v=>v.count),1);this.sortedAllBuckets=[...t].sort((v,m)=>v.value-m.value);const l=document.createElement("div");l.className="w-full h-full flex flex-col",e.appendChild(l);const u=document.createElement("div");u.className="w-full flex-1 rounded px-1 overflow-hidden",u.style.height="150px",l.appendChild(u);const f=document.createElement("div");f.className="flex items-end w-full h-full",u.appendChild(f),this.sortedAllBuckets.forEach(v=>{const m=v.count>0?v.count/a*90:2,d=document.createElement("div");d.className="flex-1 mx-px transition-colors duration-200",d.style.height=`${Math.max(m,1)}%`,d.dataset.value=v.value,d.dataset.count=v.count,v.count>0?(d.title=`Value: ${v.value}, Count: ${v.count}`,d.style.backgroundColor="#3b82f6"):(d.title=`Value: ${v.value}, No data available`,d.style.backgroundColor="#d1d5db"),f.appendChild(d)})}_renderEmptyRangeFacet(e,t){const n=document.createElement("div");return n.className="facet-slider my-3 text-center text-gray-500 py-4",n.innerHTML='<p class="text-sm">No data available for this range</p>',e.appendChild(n),n}_renderRangeFacet(e,t,n,s,i,o,a){var x;const l=s[t]||[];console.log(`=== RangeRenderer for ${t} ===`),console.log("Received state:",o),console.log("state.filters:",o==null?void 0:o.filters),console.log("state.filters[facetKey]:",(x=o==null?void 0:o.filters)==null?void 0:x[t]),console.log("=====================================");const u=l.filter(C=>C.doc_count>0);if(!l||l.length===0)return this._renderEmptyRangeFacet(e,t);const f=this._processRangeData(l,u,o.filters[t]);if(f.sortedAvailableValues.length===0){const C=document.createElement("div");return C.className="facet-slider my-3 text-center text-gray-500 py-4",C.innerHTML=`
        <p class="text-sm">No values available with current filters</p>
        <p class="text-xs text-gray-400">Range: ${f.minValue} - ${f.maxValue}</p>
      `,e.appendChild(C),C}const v=f.sortedAvailableValues[0],m=f.sortedAvailableValues[f.sortedAvailableValues.length-1];if(v===m){const C=v+1;f.sliderMax=C,f.endValue=v}const d=this._createRangeFacetDOM(t,{minValue:f.minValue,maxValue:f.maxValue});e.appendChild(d);const y=this._getSliderElements(d,t);return this.renderBarChart(y.chartElement,f.allBuckets,f.availableBuckets,f.minValue,f.maxValue),this._initializeSlider(y.slider,f),this._setupEventHandlers(t,y,f,a),this.updateChartHighlight(y.chartElement,f.allBuckets,f.startValue,f.endValue),this._storeSliderReferences(d,y,f),d}}class La{constructor(e){this.config=e,this.taxonomyRenderer=new qn,this.rangeRenderer=new Xn,this.searchTerms={}}renderFacets(e,t,n){if(!e||!this.config.aggregations){console.error("No aggregations data or configuration available.");return}const s=document.getElementById("facets-container"),i=this._getCheckedState();s.innerHTML="";const o={};Object.entries(this.config.aggregations).forEach(([a,l])=>{const u=l.category||"Other";o[u]||(o[u]=[]),o[u].push({facetKey:a,facetConfig:l})}),Object.entries(o).forEach(([a,l])=>{const u=document.createElement("div");u.className="facet-category",u.setAttribute("data-category",a);const f=document.createElement("h3");f.className="facet-category-title",f.textContent=a,u.appendChild(f);const v=document.createElement("div");v.className="facet-category-content",l.forEach(({facetKey:m,facetConfig:d})=>{const y=this._createFacetGroup(m,d);d.type==="range"?this.rangeRenderer._renderRangeFacet(y,m,d,e,i,t,n):d.type==="taxonomy"?this.taxonomyRenderer._renderTaxonomyFacet(y,m,d,e,i,t,n):d.type==="simple"&&this._renderStandardFacet(y,m,d,e,i,t,n),v.appendChild(y)}),u.appendChild(v),s.appendChild(u)}),this._addFacetEventListeners(n)}_filterFacetOptions(e,t){const n=e.querySelectorAll("label");let s=0;n.forEach(i=>{const o=i.textContent.toLowerCase(),a=t===""||o.includes(t);i.classList.toggle("facet-hidden",!a),a&&s++}),this._showNoResultsMessage(e,s===0&&t!=="")}_showNoResultsMessage(e,t){let n=e.querySelector(".no-results-disclaimer");t?(n||(n=document.createElement("div"),n.className="no-results-disclaimer",n.textContent="Nessun risultato per questa ricerca",n.style.cssText="padding: 10px; color: #666; font-style: italic;",e.appendChild(n)),n.style.display="block"):n&&(n.style.display="none"),e.style.display="block"}_updateCategoryVisibility(){document.querySelectorAll(".facet-category").forEach(t=>{const n=t.querySelectorAll('.facet-group[style*="display: block"], .facet-group:not([style*="display: none"])'),s=Array.from(n).some(i=>i.style.display!=="none");t.style.display=s?"block":"none"})}_getCheckedState(){const e={};return Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&(e[t]=Array.from(n.querySelectorAll("input:checked")).map(s=>s.value))}),e}_createFacetGroup(e,t){const n=document.createElement("div");n.className="facet-group mb-4 p-4 bg-white rounded-lg shadow",n.id=`${e}-facet`;const s=document.createElement("div");s.className="facet-header mb-3";const i=document.createElement("h3");if(i.className="text-lg font-semibold mb-2",i.textContent=t.title||e,s.appendChild(i),t.type=="simple"){const o=document.createElement("div");o.className="facet-search mb-2";const a=document.createElement("input");a.type="text",a.className="facet-search-input w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary-500",a.placeholder="Cerca...",a.id=`search-${e}`;const l=this._debounce(u=>{this._searchWithinFacet(e,u)},300);a.addEventListener("input",u=>{l(u.target.value)}),o.appendChild(a),s.appendChild(o)}return n.appendChild(s),n}_searchWithinFacet(e,t){const n=document.getElementById(`${e}-facet`);n&&(this.searchTerms[e]=t.toLowerCase().trim(),this._filterFacetOptions(n,this.searchTerms[e]))}_renderStandardFacet(e,t,n,s,i,o,a){const l=document.createElement("div");l.className="facet-options space-y-2";const u=s[t]||[],f=o.filters||{};u.forEach(v=>{var R;const m=(R=f[t])==null?void 0:R.includes(v.key),d=v.doc_count===0,y=document.createElement("label");y.className="block facet-option flex items-center justify-between",y.style.display="flex",y.setAttribute("data-search-text",v.key.toLowerCase()),d?y.classList.add("text-gray-400","cursor-not-allowed","opacity-50"):y.classList.add("cursor-pointer");const x=document.createElement("div");x.className="flex items-center";const C=document.createElement("input");C.type="checkbox",C.value=v.key,C.dataset.facetType=t,C.checked=m,C.disabled=d,C.className="form-checkbox mr-2",x.appendChild(C);const j=document.createElement("span");j.textContent=v.key,j.className="text-sm";const $=document.createElement("span");$.textContent=v.doc_count,$.className=`text-xs px-2 py-0.5 rounded-full flex-shrink-0 ml-auto ${d?"text-gray-400 bg-gray-100":"text-secondary-500 bg-secondary-100"}`,x.appendChild(j),y.appendChild(x),y.appendChild($),l.appendChild(y)}),e.appendChild(l)}_addFacetEventListeners(e){if(!this.config.aggregations){console.error("Aggregations configuration not found");return}Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&n.querySelectorAll('input[type="checkbox"]').forEach(s=>{s.addEventListener("change",i=>{this._onFacetChange(i,e)})})})}_onFacetChange(e,t){const{value:n,checked:s}=e.target,i=e.target.dataset.facetType;t({type:"FACET_CHANGE",facetType:i,value:n,checked:s})}clearAllSearches(){this.searchTerms={},Object.keys(this.config.aggregations).forEach(s=>{const i=document.getElementById(`search-${s}`);i&&(i.value="")}),document.querySelectorAll(".facet-option, label").forEach(s=>{s.style.display="block"}),document.querySelectorAll(".facet-group").forEach(s=>{s.style.display="block"}),document.querySelectorAll(".facet-category").forEach(s=>{s.style.display="block"})}_debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}}class ja{constructor(e,t){this.searchEngine=e,this.config=t}performSearch(e,t={}){if(!this.searchEngine){console.error("Search engine not initialized");return}const{filters:n}=e,{regularFilters:s,dateFilters:i,taxonomyFilters:o}=this._separateFilters(n),a=this.searchEngine.search({query:e.query||"",filters:s,sort:e.sort||"title_asc",per_page:1e3,filter:u=>this._customFilter(u,i,o)}),l=this._extractCoordinates(a.data.items);if(t.onMarkersUpdate&&t.onMarkersUpdate(a.data.items),t.onResultsUpdate&&t.onResultsUpdate(a.data.items),t.onAggregationsUpdate){const u=this._formatAggregations(a.data.aggregations);t.onAggregationsUpdate(u)}return{items:a.data.items,coordinates:l,aggregations:this._formatAggregations(a.data.aggregations)}}_separateFilters(e){const t={},n={},s={};return Object.entries(e).forEach(([i,o])=>{if(!o||o.length===0)return;const a=this.config.aggregations[i];if(a)switch(a.type){case"range":n[i]=o;break;case"taxonomy":s[i]=o;break;default:t[i]=o}}),{regularFilters:t,dateFilters:n,taxonomyFilters:s}}_customFilter(e,t,n){for(const[s,i]of Object.entries(t))if(i.length===2){const[o,a]=i,l=new Date(e[s]).getTime();if(!(l>=o&&l<=a))return!1}for(const[s,i]of Object.entries(n)){if(!e[s])return!1;const o=e[s];let a;if(Array.isArray(o)?a=o.length>0?String(o[0]):"":typeof o=="string"?a=o:a=String(o||""),!i.some(u=>a===u||a.startsWith(u+" > ")))return!1}return!0}_extractCoordinates(e){return e.filter(t=>t.lat_long&&t.lat_long.length>0).map(t=>{const n=t.lat_long[0],[s,i]=n.split(",");return[parseFloat(s),parseFloat(i)]})}_formatAggregations(e){const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=e[n].buckets);return t}}class Fa{constructor(e,t=null){this.mapFocusCallback=e,this.config=t,this.allWorks=[],this.items=[],this.searchState=null,this.isModalOpen=!1,this.currentModalIndex=0,this.isAnimating=!1}setData(e,t){this.allWorks=e,this.items=t}setConfig(e){this.config=e}_getModalFields(){var e;return(e=this.config)!=null&&e.modal_information?this.config.modal_information:{}}_getFieldLabel(e){return this._getModalFields()[e]||e}setSearchState(e){this.searchState=e}_getCompleteWorkData(e){const t=this.items.filter(o=>o.pivot_ID===e);if(t.length===0)return null;const n=t[0],s={pivot_ID:e,Title:n[window.ledaSearch.config.result_cards.card_title],Subtitle:n[window.ledaSearch.config.result_cards.card_subtitle],Subtitle2:n[window.ledaSearch.config.result_cards.card_subtitle_2],Location:[],coordinates:[],allEntries:t,geodataBySpace:new Map},i=new Map;return t.forEach(o=>{o.Location&&(Array.isArray(o.Location)?o.Location:[o.Location]).forEach((l,u)=>{if(!i.has(l)){const f=this._extractCoordinates(o,u);i.set(l,f);const v=this._getGeodataFields(),m={};v.forEach(d=>{o[d]!==void 0&&o[d]!==null&&o[d]!==""&&(Array.isArray(o[d])&&o[d].length>u?m[d]=o[d][u]:Array.isArray(o[d])||(m[d]=o[d]))}),s.geodataBySpace.set(l,m)}})}),s.Location=Array.from(i.keys()),s.coordinates=Array.from(i.values()),s}_getCatalogueFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.catalogue)||[]}_getGeodataFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.geodata)||[]}_renderSelectedFilters(){const t=new Vn(this.config).render(this.searchState);return!t||t.trim()===""?'<div class="text-sm text-gray-500 italic">Nessun filtro applicato</div>':`
      <div class="flex items-center gap-2">
        <div class="flex items-center gap-2 flex-wrap max-h-[2.5rem] overflow-hidden" id="filter-badges-container">
          ${t}
        </div>
        <span id="more-filters-indicator" class="hidden text-xs font-semibold text-gray-600 bg-gray-100 px-2 py-1 rounded-full whitespace-nowrap">
          <!-- Dynamic content -->
        </span>
      </div>
    `}async toggleModal(e){this.isAnimating||(this.isModalOpen?await this._closeModal():(this.currentModalIndex=e,await this._openModal()))}async _openModal(){this.isAnimating=!0;let e=document.getElementById("works-modal");e||(e=this._createModal(),document.body.appendChild(e)),e.classList.remove("hidden"),e.style.opacity="0";const t=e.querySelector(".modal-container");t&&(t.style.transform="scale(0.8) translateY(20px)",t.style.opacity="0"),this._populateModal(),this.isModalOpen=!0,document.body.style.overflow="hidden",e.offsetHeight,e.style.transition="opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)",e.style.opacity="1",t&&(t.style.transition="all 400ms cubic-bezier(0.34, 1.56, 0.64, 1)",t.style.transform="scale(1) translateY(0)",t.style.opacity="1"),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},200)}async _closeModal(){if(!this.isModalOpen)return;this.isAnimating=!0;const e=document.getElementById("works-modal");if(e){const t=e.querySelector(".modal-container");e.style.transition="opacity 250ms cubic-bezier(0.4, 0, 1, 1)",e.style.opacity="0",t&&(t.style.transition="all 250ms cubic-bezier(0.4, 0, 1, 1)",t.style.transform="scale(0.95) translateY(-10px)",t.style.opacity="0"),await new Promise(n=>setTimeout(n,250)),e.classList.add("hidden"),e.style.opacity="",t&&(t.style.transform="",t.style.opacity="")}this.isModalOpen=!1,document.body.style.overflow="auto",this.isAnimating=!1}_animateContentItems(){const e=document.querySelector(".modal-header");e&&(e.style.opacity="0",e.style.transform="translateY(-20px)",e.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)"},100));const t=document.querySelector(".filters-section");t&&(t.style.opacity="0",t.style.transform="translateY(-10px)",t.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},150)),document.querySelectorAll(".metadata-card").forEach((i,o)=>{i.style.opacity="0",i.style.transform="translateY(20px)",i.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{i.style.opacity="1",i.style.transform="translateY(0)"},200+o*50)}),document.querySelectorAll(".space-card").forEach((i,o)=>{i.style.opacity="0",i.style.transform="translateX(-20px)",i.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{i.style.opacity="1",i.style.transform="translateX(0)"},300+o*75)})}_createModal(){const e=document.createElement("div");return e.id="works-modal",e.className="fixed inset-0 bg-gradient-to-br from-slate-900/90 to-gray-900/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4",e.innerHTML=`
      <div class="modal-container relative w-full max-w-7xl h-[90vh] overflow-hidden">
        <!-- Enhanced Header with Close Button and Filters -->
        <div class="absolute top-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-between gap-4">
            <!-- Filters section on the left with opaque container -->
            <div class="filters-section flex-1 bg-white/95 backdrop-blur-sm rounded-xl shadow-lg border border-gray-200/50 px-4 py-3 min-w-0">
              <!-- Filters are populated here -->
            </div>
            
            <!-- Close button on the right -->
            <button id="close-modal-btn" class="p-3 bg-white/90 hover:bg-white active:bg-gray-100 rounded-full text-gray-600 hover:text-red-500 shadow-lg hover:shadow-xl transition-all duration-300 group backdrop-blur-sm border border-gray-200/50 hover:border-red-200 flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Content Container with fixed width to prevent resizing -->
        <div id="modal-content" class="h-full pt-20 pb-16 rounded-2xl w-full max-w-none overflow-hidden"></div>
        
        <!-- Enhanced Footer with Progress Indicator and Mobile Navigation -->
        <div class="absolute bottom-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-center gap-3">
            <!-- Mobile Previous Button (hidden on desktop) -->
            <button id="mobile-prev-work-btn" class="lg:hidden group p-3 bg-white/90 hover:bg-white active:bg-gray-50 rounded-full text-gray-600 hover:text-secondary-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-secondary-200 backdrop-blur-sm border border-gray-200/30 disabled:opacity-40 disabled:cursor-not-allowed">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
              </svg>
            </button>
            
            <span id="modal-progress" class="text-sm font-semibold text-gray-700 bg-white/90 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg ring-1 ring-white/20 border border-gray-200/50 transition-all duration-300 hover:shadow-xl">
            </span>
            
            <!-- Mobile Next Button (hidden on desktop) -->
            <button id="mobile-next-work-btn" class="lg:hidden group p-3 bg-white/90 hover:bg-white active:bg-gray-50 rounded-full text-gray-600 hover:text-secondary-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-secondary-200 backdrop-blur-sm border border-gray-200/30 disabled:opacity-40 disabled:cursor-not-allowed">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    `,e.addEventListener("click",t=>{t.target===e&&this._closeModal()}),e.querySelector("#close-modal-btn").addEventListener("click",()=>{this._closeModal()}),document.addEventListener("keydown",t=>{!this.isModalOpen||this.isAnimating||(t.key==="Escape"?this._closeModal():t.key==="ArrowLeft"?this._navigateModal(-1):t.key==="ArrowRight"&&this._navigateModal(1))}),e}async _navigateModal(e){if(this.isAnimating)return;const t=this.currentModalIndex+e;if(t>=0&&t<this.allWorks.length){this.isAnimating=!0;const n=document.getElementById("modal-content");if(!n)return;const s=n.querySelector(".main-content-panel");if(!s)return;const i=document.createElement("div");i.className="relative w-full h-full overflow-hidden";const o=document.createElement("div");o.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20",o.innerHTML=s.innerHTML;const a=document.createElement("div");a.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20";const l="100%";a.style.transform=`translateX(${e>0?l:`-${l}`})`,this.currentModalIndex=t;const u=this.allWorks[this.currentModalIndex],f=this._getCompleteWorkData(u.pivot_ID);f&&(a.innerHTML=this._renderMainCard(f)),s.parentNode.replaceChild(i,s),i.appendChild(o),i.appendChild(a),this._updateNavigationButtons(),i.offsetHeight,o.style.transform=`translateX(${e>0?`-${l}`:l})`,a.style.transform="translateX(0)",o.style.opacity="0.8",a.style.opacity="1",await new Promise(d=>setTimeout(d,500));const v=document.createElement("div");v.className="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20 lg:mx-0 mx-2",v.innerHTML=a.innerHTML,i.parentNode.replaceChild(v,i);const m=document.getElementById("modal-progress");m&&(m.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addMapFocusListeners(),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},100)}}_updateNavigationButtons(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn"),n=document.getElementById("mobile-prev-work-btn"),s=document.getElementById("mobile-next-work-btn");e&&(this.currentModalIndex===0?(e.disabled=!0,e.className=e.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(e.disabled=!1,e.className=e.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),t&&(this.currentModalIndex===this.allWorks.length-1?(t.disabled=!0,t.className=t.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(t.disabled=!1,t.className=t.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),n&&(n.disabled=this.currentModalIndex===0),s&&(s.disabled=this.currentModalIndex===this.allWorks.length-1),this._updatePreviewCards()}_updatePreviewCards(){const e=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,t=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,n=e?this._getCompleteWorkData(e.pivot_ID):null,s=t?this._getCompleteWorkData(t.pivot_ID):null,i=document.querySelector(".left-nav-panel .preview-card");i&&(n?(i.className="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",i.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${n.Title}</h4>
          <p class="text-xs text-gray-600 font-medium">${n.Subtitle}</p>
          <p class="text-xs text-gray-500">(${n.Subtitle2})</p>
        `):(i.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",i.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>'));const o=document.querySelector(".right-nav-panel .preview-card");o&&(s?(o.className="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",o.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${s.Title}</h4>
          <p class="text-xs text-gray-600 font-medium">${s.Subtitle}</p>
          <p class="text-xs text-gray-500">(${s.Subtitle2})</p>
        `):(o.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",o.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>'))}_addNavigationListeners(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn"),n=document.getElementById("mobile-prev-work-btn"),s=document.getElementById("mobile-next-work-btn");e&&this.currentModalIndex>0&&e.addEventListener("click",()=>this._navigateModal(-1)),t&&this.currentModalIndex<this.allWorks.length-1&&t.addEventListener("click",()=>this._navigateModal(1)),n&&this.currentModalIndex>0&&n.addEventListener("click",()=>this._navigateModal(-1)),s&&this.currentModalIndex<this.allWorks.length-1&&s.addEventListener("click",()=>this._navigateModal(1))}_populateModal(){const e=document.getElementById("modal-content"),t=document.getElementById("modal-progress"),n=document.querySelector(".filters-section");if(!e)return;n&&(n.innerHTML=this._renderSelectedFilters(),setTimeout(()=>this._handleFilterOverflow(),100));const s=this.allWorks[this.currentModalIndex],i=this._getCompleteWorkData(s.pivot_ID),o=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,a=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,l=o?this._getCompleteWorkData(o.pivot_ID):null,u=a?this._getCompleteWorkData(a.pivot_ID):null;if(!i){e.innerHTML='<div class="flex items-center justify-center h-full text-gray-500 text-lg">Dati non disponibili</div>';return}e.innerHTML=`
      <div class="flex h-full w-full">
        <!-- Enhanced Left Navigation Panel with fixed width (hidden on mobile) -->
        <div class="left-nav-panel hidden lg:flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="prev-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-secondary-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-secondary-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===0?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===0?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:-translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
          </button>
          
          ${l?`
            <div class="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${l.Title}</h4>
              <p class="text-xs text-gray-600 font-medium">${l.Subtitle}</p>
              <p class="text-xs text-gray-500">(${l.Subtitle2})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>
            </div>
          `}
        </div>

        <!-- Enhanced Main Content Area with fixed flex properties (full width on mobile) -->
        <div class="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20 lg:mx-0 mx-2">
          ${this._renderMainCard(i)}
        </div>

        <!-- Enhanced Right Navigation Panel with fixed width (hidden on mobile) -->
        <div class="right-nav-panel hidden lg:flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="next-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-secondary-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-secondary-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===this.allWorks.length-1?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===this.allWorks.length-1?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
          
          ${u?`
            <div class="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${u.Title}</h4>
              <p class="text-xs text-gray-600 font-medium">${u.Subtitle}</p>
              <p class="text-xs text-gray-500">(${u.Subtitle2})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>
            </div>
          `}
        </div>
      </div>
    `,t&&(t.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addNavigationListeners(),this._addMapFocusListeners()}_renderMainCard(e){const t=e.allEntries[0],n=this._renderCombinedMetadata(t),s=this._renderGeographicalSpaces(e);return`
      <div class="p-8 space-y-8 w-full">
        <!-- Enhanced Header Section -->
        <div class="modal-header bg-gradient-to-r from-slate-50/90 to-gray-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-gray-200/50 border border-gray-200/30">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-12 bg-gradient-to-b from-secondary-500 to-secondary-600 rounded-full shadow-sm flex-shrink-0"></div>
                <div class="min-w-0 flex-1">
                  <h1 class="text-3xl font-bold text-gray-900 leading-tight word-break">${e.Title}</h1>
                  <div class="flex items-center gap-4 mt-2">
                    <p class="text-lg text-gray-700 font-medium truncate">${e.Subtitle?e.Subtitle:"Non specificato"}</p>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full flex-shrink-0"></span>
                    <p class="text-lg text-gray-600 font-mono flex-shrink-0">${e.Subtitle2?e.Subtitle2:"Non specificato"}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        ${n}
        ${s}
      </div>
    `}_renderCombinedMetadata(e){const t=this._getModalFields();if(!t||Object.keys(t).length===0)return"";const n=Object.keys(t).filter(s=>{const i=e[s];return i!=null&&i!==""}).map(s=>{const i=e[s],o=this._getFieldLabel(s);let a=i;return Array.isArray(i)?a=i.join(", "):typeof i=="string"&&i.length>150&&(a=i.substring(0,147)+"..."),`<div class="metadata-card group bg-white/90 hover:bg-white backdrop-blur-sm hover:shadow-lg rounded-xl p-5 ring-1 ring-gray-200/50 hover:ring-gray-300/70 transition-all duration-300 border border-gray-200/30 hover:border-gray-300/50 hover:-translate-y-0.5">
                  <div class="flex items-center gap-3 mb-3">
                      <div class="w-2 h-2 bg-gradient-to-r from-primary-400 to-primary-600 rounded-full group-hover:scale-125 transition-transform duration-300 shadow-sm"></div>
                      <h4 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">${o}</h4>
                  </div>
                  <div class="text-base text-gray-700 leading-relaxed pl-5">${a}</div>
              </div>`}).join("");return n?`<div>
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-primary-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0-1.125.504-1.125 1.125V11.25a9 9 0 0 0-9-9Z" />
              </svg>
              Informazioni su questo riferimento
          </h2>
          <div class="grid gap-4">
              ${n}
          </div>
      </div>`:""}_renderGeographicalSpaces(e){return!e.Location||e.Location.length===0?`
      <div class="bg-gradient-to-r from-secondary-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-secondary-200/50 border border-secondary-200/30">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-secondary-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          </svg>
          Location
        </h2>
        <div class="text-gray-500 italic">Nessun spazio geografico disponibile</div>
      </div>
    `:`
    <div class="bg-gradient-to-r from-secondary-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-4 sm:p-8 ring-1 ring-secondary-200/50 border border-secondary-200/30">
      <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 sm:w-6 sm:h-6 text-secondary-600 flex-shrink-0">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
        </svg>
        <span class="break-words">I luoghi</span>
      </h2>
      <div class="grid gap-4 sm:gap-6">
        ${e.Location.map((n,s)=>{const i=e.coordinates[s],o=e.geodataBySpace.get(n)||{},a=this._getCatalogueFields(),l=this._getModalFields(),u=this._getGeodataFields(),f=Object.keys(l).filter(m=>!a.includes(m)&&u.includes(m)&&o[m]!=null&&o[m]!=="").map(m=>{const d=o[m],y=l[m];let x=d;return typeof d=="string"&&d.length>100&&(x=d.substring(0,97)+"..."),`<div class="flex items-start gap-3 py-2">
            <div class="w-1.5 h-1.5 bg-secondary-400 rounded-full mt-2 flex-shrink-0"></div>
            <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">${y}</span>
                </div>
                <span class="text-sm text-gray-800 break-words">${x}</span>
            </div>
        </div>`}).filter(Boolean).join(""),v=i&&i.lat&&i.lng;return`
      <div class="space-card bg-white/90 backdrop-blur-sm rounded-xl p-4 sm:p-6 ring-1 ring-gray-200/50 hover:ring-secondary-300/70 transition-all duration-300 hover:shadow-lg border border-gray-200/30 hover:border-secondary-300/50 hover:-translate-y-1">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-4">
          <div class="flex items-start gap-3 min-w-0 flex-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5 text-secondary-600 flex-shrink-0 mt-0.5">
              <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
            </svg>
            <h3 class="text-base sm:text-lg font-semibold text-gray-900 break-words">${n}</h3>
          </div>
          
          ${v?`
            <button class="map-btn group w-full sm:w-auto px-4 py-2 text-sm font-medium bg-gradient-to-r from-secondary-500 to-secondary-600 hover:from-secondary-600 hover:to-secondary-700 active:from-secondary-700 active:to-secondary-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 hover:-translate-y-0.5 flex-shrink-0 whitespace-nowrap" 
                    data-lat="${i.lat}" 
                    data-lng="${i.lng}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 inline mr-1">
                <path fill-rule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V6h4.5a.75.75 0 0 1 0 1.5H8.75v4.25a.75.75 0 0 1-1.5 0V7.5H2.75a.75.75 0 0 1 0-1.5h4.5V1.75A.75.75 0 0 1 8 1Z" clip-rule="evenodd" />
              </svg>
              Visualizza sulla mappa
            </button>
          `:`
            <span class="w-full sm:w-auto px-4 py-2 text-sm font-medium bg-gray-100/80 text-gray-500 rounded-lg ring-1 ring-gray-200/50 backdrop-blur-sm text-center">
              Coordinate non disponibili
            </span>
          `}
        </div>
        
        ${f?`
          <div class="border-t border-gray-100/50 pt-4 mt-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">Informazioni su questo luogo</h4>
            <div class="space-y-2 overflow-hidden">
              ${f}
            </div>
          </div>
        `:`
          <div class="border-t border-gray-100/50 pt-4 mt-4">
            <div class="text-sm text-gray-500 italic">Nessuna informazione disponibile per questo luogo</div>
          </div>
        `}
      </div>
    `}).join("")}
      </div>
      <div class="mt-4 sm:mt-6 text-xs sm:text-sm text-secondary-700 bg-secondary-100/80 backdrop-blur-sm rounded-lg p-3 flex items-start gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 flex-shrink-0 mt-0.5">
          <path fill-rule="evenodd" d="M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0ZM9 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM6.75 8a.75.75 0 0 0 0 1.5h.75v1.75a.75.75 0 0 0 1.5 0v-2.5A.75.75 0 0 0 8.25 8h-1.5Z" clip-rule="evenodd" />
        </svg>
        <span class="break-words">Clicca sui pulsanti "Visualizza sulla mappa" per vedere i luoghi sulla mappa.</span>
      </div>
    </div>
  `}_handleFilterOverflow(){const e=document.getElementById("filter-badges-container"),t=document.getElementById("more-filters-indicator");if(!e||!t)return;const n=Array.from(e.children);if(n.length===0)return;e.clientHeight;let s=0;n.forEach((i,o)=>{const a=i.getBoundingClientRect(),l=e.getBoundingClientRect();a.top>=l.top&&a.bottom<=l.bottom?i.classList.remove("hidden"):(s++,i.classList.add("hidden"))}),s>0?(t.textContent=`+${s} ${s===1?"altro filtro":"altri filtri"}`,t.classList.remove("hidden"),t.style.cursor="pointer",t.onclick=()=>{e.classList.contains("max-h-none")?(e.classList.remove("max-h-none"),e.classList.add("max-h-[2.5rem]"),n.forEach(o=>{const a=o.getBoundingClientRect(),l=e.getBoundingClientRect();a.bottom>l.bottom&&o.classList.add("hidden")}),t.textContent=`+${s} ${s===1?"altro filtro":"altri filtri"}`):(e.classList.add("max-h-none"),e.classList.remove("max-h-[2.5rem]"),n.forEach(o=>o.classList.remove("hidden")),t.textContent="Mostra meno")}):t.classList.add("hidden")}_addMapFocusListeners(){document.querySelectorAll(".map-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseFloat(e.getAttribute("data-lat")),n=parseFloat(e.getAttribute("data-lng"));t&&n&&this.mapFocusCallback&&(this.mapFocusCallback(t,n,8),this._closeModal())})})}_extractCoordinates(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const s=e.lat_long[t];if(s&&typeof s=="string"){const i=s.split(",");if(i.length===2){const o=parseFloat(i[0].trim()),a=parseFloat(i[1].trim());!isNaN(o)&&!isNaN(a)&&(n={lat:o,lng:a})}}}else if(e.lat_long&&typeof e.lat_long=="string"){const s=e.lat_long.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),o=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(o)&&(n={lat:i,lng:o})}}return n}}class Oa{constructor(e){this.mapFocusCallback=e,this.allWorks=[],this.modalRenderer=new Fa(e)}updateResultsList(e,t,n={}){const s=document.getElementById("results");if(!s){console.error("Results container not found");return}this.items=e,this.searchState=n;const i=this._groupByIdOpera(e);this.allWorks=Object.values(i);const o=e.map(a=>a.pivot_ID);this.allWorks.sort((a,l)=>o.indexOf(a.pivot_ID)-o.indexOf(l.pivot_ID)),this.modalRenderer.setData(this.allWorks,this.items),this.modalRenderer.setConfig(t),this.modalRenderer.setSearchState(n),s.innerHTML=this.allWorks.map((a,l)=>this._renderResultItem(a,l)).join(""),this._addMapFocusListeners(),this._addModalListeners()}focusOnResult(e){const t=document.querySelector(`[data-result-id="${e}"]`);return t?(this._openFiltersPanel(),t.scrollIntoView({behavior:"smooth",block:"center"}),this._highlightResult(t),console.log(`Focused on result with pivot_ID: ${e}`),!0):(console.warn(`Result with pivot_ID ${e} not found in current results`),!1)}_openFiltersPanel(){const e=document.getElementById("results-panel");e?(e.classList.remove("panel-closed-right"),console.log("Filters panel opened")):console.warn('Filters panel with ID "results-panel" not found')}_highlightResult(e){const t=document.querySelector(".result-highlighted");t&&t.classList.remove("result-highlighted"),e.classList.add("result-highlighted"),e.style.transition="all 0.3s ease",e.style.transform="scale(1.02)",setTimeout(()=>{e.style.transform=""},1e3),setTimeout(()=>{e.classList.remove("result-highlighted")},3e3)}_groupByIdOpera(e){const t={};return e.forEach(n=>{const s=n.pivot_ID;t[s]||(t[s]={pivot_ID:s,Title:n[window.ledaSearch.config.result_cards.card_title],Subtitle:n[window.ledaSearch.config.result_cards.card_subtitle]||"",Subtitle2:n[window.ledaSearch.config.result_cards.card_subtitle_2]||"",Description:n[window.ledaSearch.config.result_cards.card_description]||"",Location:[],coordinates:[]}),n.Location&&(Array.isArray(n.Location)?n.Location:[n.Location]).forEach((o,a)=>{if(!t[s].Location.includes(o)){t[s].Location.push(o);const l=this._extractCoordinatesFromItem(n,a);t[s].coordinates.push(l)}})}),t}_renderResultItem(e,t){const n=e.Location.map((s,i)=>{const o=e.coordinates[i],a=o&&o.lat&&o.lng;return`
        <button class="focus-map-btn inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-200 hover:shadow-sm hover:scale-105 active:scale-95 cursor-pointer transform 
                       ${a?"bg-secondary-100 hover:bg-secondary-200 text-secondary-700 border border-secondary-200":"bg-gray-100 text-gray-500 border border-gray-200"}" 
                data-space="${encodeURIComponent(s)}" 
                ${a?`data-lat="${o.lat}" data-lng="${o.lng}"`:""}
                title="${a?"Clicca per visualizzare sulla mappa":"Coordinate non disponibili"}">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 mr-1 ${a?"":"opacity-50"}">
            <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
          </svg>
          ${s}
        </button>
      `}).join("");return`
  <div class="result-card bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300 p-6" 
       data-result-id="${e.pivot_ID}">
    <!-- Header with Title, Subtitles and Button -->
    <div class="flex items-start justify-between gap-4 mb-4">
      <div class="min-w-0 flex-1">
        <h1 class="text-xl font-bold text-gray-900 leading-tight">${e.Title}</h1>
        <div class="flex items-center gap-4 mt-2">
          ${e.Subtitle?`<p class="text-lg text-gray-700 font-medium truncate">${e.Subtitle}</p>`:""}
          ${e.Subtitle&&e.Subtitle2?'<span class="w-1.5 h-1.5 bg-gray-400 rounded-full flex-shrink-0"></span>':""}
          ${e.Subtitle2?`<p class="text-lg text-gray-600 font-mono flex-shrink-0">${e.Subtitle2}</p>`:""}
        </div>
      </div>
      
      <!-- More button -->
      <button class="modal-toggle-btn inline-flex items-center px-4 py-2 rounded-full shadow-md hover:shadow-lg transition-all duration-200 flex-shrink-0 bg-primary-500 hover:bg-primary-600 text-white"
              data-work-index="${t}"
              title="Visualizza tutte le opere">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
        </svg>
      </button>
    </div>
    
    <!-- Description with vertical bar -->
    ${e.Description?`
      <div class="flex items-stretch gap-2">
        <div class="w-1 bg-gradient-to-b from-primary-500 to-primary-600 rounded-full shadow-sm flex-shrink-0"></div>
        <p class="text-xs text-gray-600 flex-1">${e.Description}</p>
      </div>
    `:""}
    
    <!-- Locations -->
    ${n?`
      <div class="pt-4 border-t border-gray-200 mt-4">
        <div class="flex flex-wrap gap-2">
          ${n}
        </div>
      </div>
    `:""}
  </div>
`}_addModalListeners(){document.querySelectorAll(".modal-toggle-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=parseInt(e.getAttribute("data-work-index"));this.modalRenderer.toggleModal(n)})})}_extractCoordinatesFromItem(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const s=e.lat_long[t];if(s&&typeof s=="string"){const i=s.split(",");if(i.length===2){const o=parseFloat(i[0].trim()),a=parseFloat(i[1].trim());!isNaN(o)&&!isNaN(a)&&(n.lat=o,n.lng=a)}}}else if(e.lat_long&&typeof e.lat_long=="string"){const s=e.lat_long.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),o=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(o)&&(n.lat=i,n.lng=o)}}return n}_addMapFocusListeners(){document.querySelectorAll(".focus-map-btn").forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("data-lat"),s=e.getAttribute("data-lng"),i=decodeURIComponent(e.getAttribute("data-space"));n&&s&&this.mapFocusCallback?this.mapFocusCallback(parseFloat(n),parseFloat(s),i):console.warn("Coordinate non disponibili per questo luogo:",i)})})}}class Na{constructor(e,t){this.config=e,this.searchEngine=t,this.components={}}async initializeComponents(e){const t=fs(this.config);return this.components.map=t.map,this.components.markers=t.markers,this.components.renderMarkers=t.renderMarkers,this.components.setFocusResultCallback=t.setFocusResultCallback,this.components.mapInstance=t,window.ledaSearch||(window.ledaSearch={}),window.ledaSearch.config=this.config,window.ledaSearch.mapInstance=this.components.mapInstance,window.switchMarkerType=n=>{this.components.mapInstance&&this.components.mapInstance.switchMarkerType&&this.components.mapInstance.switchMarkerType(n)},this.components.facetRenderer=new La(this.config),this.components.rangeRenderer=new Xn,this.components.taxonomyRenderer=new qn,this.components.searchHandler=new ja(this.searchEngine,this.config),this.components.resultsRenderer=new Oa((n,s,i)=>{this.components.mapInstance&&this.components.mapInstance.focusOnLocation&&this.components.mapInstance.focusOnLocation(n,s,i)}),this.components.navBar=Vo,this.components}connectMapToResults(e,t,n){t&&t(s=>{const i=e.focusOnResult(s);return!i&&n&&n("Item not found in current results","warning"),i})}getComponents(){return this.components}}class $a{constructor(){this.config=null,this.searchEngine=null,this.universalNav=null,this.universalFooter=null,this.stateManager=null,this.searchCoordinator=null,this.uiManager=null,this.filterManager=null,this.eventCoordinator=null,this.componentsInitializer=null,this.components={},this.isInitialLoad=!0,this.isFullyLoaded=!1,this.initialize()}async initialize(){try{this.uiManager=new jo,this.uiManager.showFullScreenLoader(),this.config=await cs();const e=await hs();this.config.searchConfig.per_page=e.length,new us(this.config).render(),new ds(this.config).render(),this.searchEngine=Mo(e,this.config),this.initializeManagers(),await this.initializeComponents(),this.setupEvents(),await this.performSearch(),this.applyUrlFilters(),this.isInitialLoad=!1,this.isFullyLoaded=!0,this.uiManager.hideFullScreenLoader()}catch(e){console.error("Initialization error:",e),this.uiManager.showNotification("Error loading application","error"),this.uiManager.hideFullScreenLoader()}}initializeManagers(){this.stateManager=new Ao(this.config),this.searchCoordinator=new Lo(null,this.config),this.filterManager=new Fo(this.stateManager,this.config),this.eventCoordinator=new Oo(this.stateManager,this.config,{onSearch:()=>this.searchCoordinator.debouncedSearch(this.stateManager.getState(),this.getSearchCallbacks()),onSortChange:()=>this.performSearch(),onClearAllFilters:()=>this.clearAllFilters(),onRemoveFilter:(e,t)=>this.removeFilter(e,t),onClearSearchQuery:()=>this.clearSearchQuery()})}async initializeComponents(){this.componentsInitializer=new Na(this.config,this.searchEngine),this.components=await this.componentsInitializer.initializeComponents((e,t,n)=>this.focusOnMap(e,t,n)),this.searchCoordinator.searchHandler=this.components.searchHandler,this.componentsInitializer.connectMapToResults(this.components.resultsRenderer,this.components.setFocusResultCallback,(e,t)=>this.uiManager.showNotification(e,t))}setupEvents(){this.eventCoordinator.bindEvents(),this.eventCoordinator.bindNavBarEvents(this.components.navBar)}getSearchCallbacks(){return{onMarkersUpdate:e=>this.components.renderMarkers(e),onResultsUpdate:e=>{this.components.resultsRenderer.updateResultsList(e,this.config,{filters:this.stateManager.getState().filters,query:this.stateManager.getState().query,sort:this.stateManager.getState().sort})},onAggregationsUpdate:e=>this.renderFacets(e),onNavBarUpdate:(e,t)=>this.updateNavBar(e,t),onError:(e,t)=>this.uiManager.showNotification(e,t)}}async performSearch(){const e=this.stateManager.getState();return await this.searchCoordinator.performSearch(e,this.getSearchCallbacks())}async handleStateChange(e){await this.stateManager.handleStateChange(e,{onStateChange:async t=>{var s;window.ledaSearch.state=t;const n=await this.searchCoordinator.performSearch(t,this.getSearchCallbacks());console.log("Filter search completed:",((s=n.items)==null?void 0:s.length)||0,"items found")}})}renderFacets(e){this.components.facetRenderer.renderFacets(e,this.stateManager.getState(),t=>this.handleStateChange(t))}updateNavBar(e=0,t={}){this.components.navBar.updateFromSearchState(this.stateManager.getState(),e,t)}focusOnMap(e,t,n){this.components.mapInstance&&this.components.mapInstance.focusOnLocation&&this.components.mapInstance.focusOnLocation(e,t,n)}applyUrlFilters(){this.filterManager.applyUrlFilters({onApplyFilters:async()=>await this.performSearch(),onShowNotification:(e,t)=>this.uiManager.showFilterNotification(e,t),onError:(e,t)=>this.uiManager.showNotification(e,t)})}clearAllFilters(){this.filterManager.clearAllFilters(),this.performSearch()}removeFilter(e,t){this.filterManager.removeFilter(e,t),this.performSearch()}clearSearchQuery(){this.filterManager.clearSearchQuery(),this.performSearch()}getLoadingStatus(){return{isLoading:this.searchCoordinator.getLoadingStatus().isLoading,isFullyLoaded:this.isFullyLoaded,searchEngineReady:!!this.searchEngine,mapReady:!!this.components.map,configLoaded:!!this.config}}}document.addEventListener("DOMContentLoaded",()=>{window.ledaSearch=new $a})});export default Pa();
